<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Apache Dubbo™ 是一款微服务框架（Microservices Framework），它提供高性能 RPC 通信、服务发现、流量管理等服务治理能力，为你提供构建大规模微服务集群所需的全套解决方案。"><link rel=icon href=assets/images/dubbo.svg><link rel="shortcut icon" href=../../../../assets/favicon.png><meta name=generator content="mkdocs-1.1.2, mkdocs-material-5.5.3"><title>Service invoking process - Apache Dubbo</title><link rel=stylesheet href=../../../../assets/stylesheets/main.6fb40bf7.min.css><link rel=stylesheet href=../../../../assets/stylesheets/palette.cef4c379.min.css><meta name=theme-color content=#3f51b5><link rel=stylesheet href=../../../../css/dropdown.css><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-112489517-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview",document.location.pathname)})</script><script async src=https://www.google-analytics.com/analytics.js></script><meta property=og:type content=website><meta property=og:title content="Apache Dubbo - Service invoking process"><meta property=og:description content="Apache Dubbo™ 是一款微服务框架（Microservices Framework），它提供高性能 RPC 通信、服务发现、流量管理等服务治理能力，为你提供构建大规模微服务集群所需的全套解决方案。"><meta property=og:url content=None><meta property=og:image content=assets/images/banner.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@squidfunk><meta name=twitter:creator content=@squidfunk><meta name=twitter:title content="Apache Dubbo - Service invoking process"><meta name=twitter:description content="Apache Dubbo™ 是一款微服务框架（Microservices Framework），它提供高性能 RPC 通信、服务发现、流量管理等服务治理能力，为你提供构建大规模微服务集群所需的全套解决方案。"><meta name=twitter:image content=assets/images/banner.png><link rel=stylesheet href=../../../../assets/stylesheets/overrides.011ebae6.min.css></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#1 class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> <aside class=md-announce> <div class="md-announce__inner md-grid md-typeset"> <a href=https://dubbo.apache.org/en-us/docs/3.0/user/preface/background/ > Details of the next generation <strong>Dubbo 3.0</strong> <span class="twemoji twitter"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.73 11.93c0 1.72-.02 1.83-.23 2.07-.19.17-.38.23-.76.23l-.51.01-.03-2.27-.02-2.27h.52c.35 0 .6.07.77.21.24.21.26.25.26 2.02M22 7.5v9c0 1.11-.89 2-2 2H4c-1.11 0-2-.89-2-2v-9c0-1.11.89-2 2-2h16c1.11 0 2 .89 2 2M8.93 11.73c-.03-1.84-.05-1.99-.29-2.39-.4-.68-.85-.84-2.36-.84H5v7h1.21c1.33 0 1.89-.17 2.29-.71.41-.53.5-.98.43-3.06m4.19-3.23h-1.48c-1.49 0-1.5 0-1.71.28S9.7 9.21 9.7 12v2.96l.27.27c.25.27.31.27 1.71.27h1.44v-1.19l-1.09-.04-1.1-.03V12.6l.68-.03.66-.04v-1.19h-1.39V9.7h2.24V8.5m5.88.06c0-.06-.3-.06-.66-.06l-.68.06-.59 2.35c-.38 1.48-.62 2.27-.67 2.13-.08-.27-1.14-4.44-1.14-4.49 0-.05-.31-.05-.68-.05h-.69l.41 1.55c.2.87.59 2.28.81 3.15.34 1.35.46 1.65.75 1.94.2.22.45.36.61.36.33 0 .76-.34.9-.73C17.5 14.5 19 8.69 19 8.56z"/></svg> </span> </a> </div> </aside> </div> <!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Application header --> <header class=md-header data-md-component=header> <!-- Top-level navigation --> <nav class="md-header-nav md-grid" aria-label=Header> <!-- Link to home --> <a href=../../../.. title="Apache Dubbo" class="md-header-nav__button md-logo" aria-label="Apache Dubbo"> <svg xmlns=http://www.w3.org/2000/svg width=20px height=20px role=img viewbox="-2.24 -0.24 324.74 78.74"><title>Dubbo logo</title><defs><lineargradient id=a x1=4.06 x2=316.39 y1=39.27 y2=39.27 gradientunits=userSpaceOnUse><stop offset=0 stop-color=#8953ff /><stop offset=1 stop-color=#00e0e3 /></lineargradient></defs><path fill=url(#a) d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25h-50.9zm21.24-28h8.6V31h-8.6zm0 22.25h8.6v8.6h-8.6zM33.24 7.25H4.06v64h29.18c10.95 0 19.3-7.18 23.29-17.15a45.12 45.12 0 0 0 2.38-14.87 45.12 45.12 0 0 0-2.38-14.83C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63h-3.33a3.44 3.44 0 0 0-3.44 3.44v27.91a3.44 3.44 0 0 0 3.44 3.44h3.33v4.63h-8.3a6.87 6.87 0 0 1-6.87-6.87V24.12a6.87 6.87 0 0 1 6.87-6.87h8.3zM285.51 6.06c-17.05 0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21-13.83-33.21-30.88-33.21zm7.59 48.36a6.87 6.87 0 0 1-6.87 6.87h-8.3v-4.62h3.33a3.44 3.44 0 0 0 3.44-3.44V25.31a3.44 3.44 0 0 0-3.44-3.44h-3.33v-4.62h8.3a6.87 6.87 0 0 1 6.87 6.87zm-53.4-17.56a17.39 17.39 0 0 0-12.39-29.61H195.1v64h32.21a19.44 19.44 0 0 0 12.38-34.44zm-28.07 24.43h-6.08l18.68-44h6.08zM177 36.85a17.39 17.39 0 0 0-12.35-29.6h-32.22v64h32.21A19.44 19.44 0 0 0 177 36.85zm-28 24.44h-6.08l18.68-44h6.08z"/></svg> </a> <!-- Button to open drawer --> <label class="md-header-nav__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <!-- Header title --> <div class=md-header-nav__title data-md-component=header-title> <div class=md-header-nav__ellipsis> <span class="md-header-nav__topic md-ellipsis"> Apache Dubbo </span> <span class="md-header-nav__topic md-ellipsis"> Service invoking process </span> </div> </div> <!-- Button to open search dialogue --> <label class="md-header-nav__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <!-- Search interface --> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div> <div class=langChange id=translate title=中文|English> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"> <path d="M12.87 15.07l-2.54-2.51.03-.03A17.52 17.52 0 0014.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7l1.62-4.33L19.12 17h-3.24z"/> </svg> </div> <script>
    var translate = document.getElementById('translate');
    translate.addEventListener('click', changeHref, false);
    function changeHref() {
        if (window.location.href.search('en-us') !== -1) {
            var changeHref = window.location.href.replace('en-us', 'zh-cn');

        } else {
            var changeHref = window.location.href.replace('zh-cn', 'en-us');
        }
        window.location.href = changeHref
    }
</script> <style>
    .langChange {
        display: inline-block;
        width: 2.4rem;
        height: 2.4rem;
        vertical-align: middle;
        margin-left: .5rem;
    }

    .langChange svg {
        fill: rgba(255, 255, 255, 0.548);
        display: block;
        width: 1.2rem;
        height: 1.2rem;
        margin: 0 auto;
        margin-top: .6rem;
        margin-left: .6rem;
    }

    .langChange :hover {
        fill: white;
        cursor: pointer;
    }
</style> </div> <!-- Repository containing source --> <div class=md-header-nav__source> <a href=https://github.com/apache/dubbo/ title="前往 GitHub 仓库" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <!-- Home page --> <li class=md-tabs__item> <a href=../../../.. class="md-tabs__link md-tabs__link--active"> 首页 </a> </li> <!-- Main navigation item with nested items --> <!-- Home page --> <li class="md-tabs__item md-tabs_csr"> <a class="md-tabs__link md-tabs__link--active">文档</a> <ul class="md-tabs__list md-sub-tabs_bn"> <!-- Recurse, if the first item has nested items --> <!-- Home page --> <!-- Recurse, if the first item has nested items --> <!-- Home page --> <!-- Recurse, if the first item has nested items --> <li class=md-tabs__item> <a href=../../user/preface/background/ class=md-tabs__link>2.7</a> </li> <!-- Render item --> <!-- Recurse, if the first item has nested items --> <!-- Home page --> <!-- Recurse, if the first item has nested items --> <!-- Home page --> <!-- Recurse, if the first item has nested items --> <li class=md-tabs__item> <a href=../../../3.0/user/preface/background/ class=md-tabs__link>3.0</a> </li> <!-- Render item --> </ul> </li> <!-- Home page --> <!-- Recurse, if the first item has nested items --> <li class=md-tabs__item> <a href=../../../../blog/apache-dubbo-2019-2020/ class=md-sub-tabs_link>Blog</a> </li> <!-- Home page --> <!-- Recurse, if the first item has nested items --> <li class=md-tabs__item> <a href=../../../../developers/guide_dev/ class=md-sub-tabs_link>开发者指引</a> </li> <!-- Home page --> <!-- Recurse, if the first item has nested items --> <li class=md-tabs__item> <a href=../../../../blog/download/ class=md-sub-tabs_link>下载</a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Main navigation --> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <!-- Site title --> <label class=md-nav__title for=__drawer> <a href=../../../.. title="Apache Dubbo" class="md-nav__button md-logo" aria-label="Apache Dubbo"> <svg xmlns=http://www.w3.org/2000/svg width=20px height=20px role=img viewbox="-2.24 -0.24 324.74 78.74"><title>Dubbo logo</title><defs><lineargradient id=a x1=4.06 x2=316.39 y1=39.27 y2=39.27 gradientunits=userSpaceOnUse><stop offset=0 stop-color=#8953ff /><stop offset=1 stop-color=#00e0e3 /></lineargradient></defs><path fill=url(#a) d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25h-50.9zm21.24-28h8.6V31h-8.6zm0 22.25h8.6v8.6h-8.6zM33.24 7.25H4.06v64h29.18c10.95 0 19.3-7.18 23.29-17.15a45.12 45.12 0 0 0 2.38-14.87 45.12 45.12 0 0 0-2.38-14.83C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63h-3.33a3.44 3.44 0 0 0-3.44 3.44v27.91a3.44 3.44 0 0 0 3.44 3.44h3.33v4.63h-8.3a6.87 6.87 0 0 1-6.87-6.87V24.12a6.87 6.87 0 0 1 6.87-6.87h8.3zM285.51 6.06c-17.05 0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21-13.83-33.21-30.88-33.21zm7.59 48.36a6.87 6.87 0 0 1-6.87 6.87h-8.3v-4.62h3.33a3.44 3.44 0 0 0 3.44-3.44V25.31a3.44 3.44 0 0 0-3.44-3.44h-3.33v-4.62h8.3a6.87 6.87 0 0 1 6.87 6.87zm-53.4-17.56a17.39 17.39 0 0 0-12.39-29.61H195.1v64h32.21a19.44 19.44 0 0 0 12.38-34.44zm-28.07 24.43h-6.08l18.68-44h6.08zM177 36.85a17.39 17.39 0 0 0-12.35-29.6h-32.22v64h32.21A19.44 19.44 0 0 0 177 36.85zm-28 24.44h-6.08l18.68-44h6.08z"/></svg> </a> Apache Dubbo </label> <!-- Repository containing source --> <div class=md-nav__source> <a href=https://github.com/apache/dubbo/ title="前往 GitHub 仓库" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <!-- Render item list --> <ul class=md-nav__list data-md-scrollfix> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../.. title=首页 class=md-nav__link> 首页 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1> 2.7 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=2.7 data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 2.7 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1 type=checkbox id=nav-1-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1> 用户手册 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=用户手册 data-md-level=2> <label class=md-nav__title for=nav-1-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 用户手册 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-1 type=checkbox id=nav-1-1-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-1> 入门 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=入门 data-md-level=3> <label class=md-nav__title for=nav-1-1-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 入门 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/preface/background/ title=背景 class=md-nav__link> 背景 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/preface/requirements/ title=需求 class=md-nav__link> 需求 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/preface/architecture/ title=架构 class=md-nav__link> 架构 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/preface/usage/ title=用法 class=md-nav__link> 用法 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/quick-start/ title=快速启动 class=md-nav__link> 快速启动 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/dependencies/ title=依赖 class=md-nav__link> 依赖 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/maturity/ title=成熟度 class=md-nav__link> 成熟度 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-5 type=checkbox id=nav-1-1-5> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-5> 配置 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=配置 data-md-level=3> <label class=md-nav__title for=nav-1-1-5> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 配置 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/configuration/xml/ title="XML 配置" class=md-nav__link> XML 配置 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/configuration/api/ title="API 配置" class=md-nav__link> API 配置 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/configuration/annotation/ title="Annotation 配置" class=md-nav__link> Annotation 配置 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/configuration/annotation/ title=动态配置中心 class=md-nav__link> 动态配置中心 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/configuration/configuration-load-process/ title=配置加载流程 class=md-nav__link> 配置加载流程 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/configuration/environment-variables/ title=自动加载环境变量 class=md-nav__link> 自动加载环境变量 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-6 type=checkbox id=nav-1-1-6> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-6> 示例 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=示例 data-md-level=3> <label class=md-nav__title for=nav-1-1-6> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 示例 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/preflight-check/ title=启动时检查 class=md-nav__link> 启动时检查 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/fault-tolerent-strategy/ title=集群容错 class=md-nav__link> 集群容错 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/loadbalance/ title=负载均衡 class=md-nav__link> 负载均衡 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/thread-model/ title=线程模型 class=md-nav__link> 线程模型 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/explicit-target/ title=直连提供者 class=md-nav__link> 直连提供者 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/subscribe-only/ title=只订阅 class=md-nav__link> 只订阅 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/registry-only/ title=只注册 class=md-nav__link> 只注册 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/static-service/ title=静态服务 class=md-nav__link> 静态服务 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/multi-protocols/ title=多协议 class=md-nav__link> 多协议 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/multi-registry/ title=多注册中心 class=md-nav__link> 多注册中心 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/service-group/ title=服务分组 class=md-nav__link> 服务分组 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/multi-versions/ title=多版本 class=md-nav__link> 多版本 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/group-merger/ title=分组聚合 class=md-nav__link> 分组聚合 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/parameter-validation/ title=参数验证 class=md-nav__link> 参数验证 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/result-cache/ title=结果缓存 class=md-nav__link> 结果缓存 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/generic-reference/ title=泛化引用 class=md-nav__link> 泛化引用 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/generic-service/ title=泛化实现 class=md-nav__link> 泛化实现 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/echo-service/ title=回声测试 class=md-nav__link> 回声测试 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/context/ title=上下文信息 class=md-nav__link> 上下文信息 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/attachment/ title=隐式参数 class=md-nav__link> 隐式参数 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/async-call/ title=异步调用 class=md-nav__link> 异步调用 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/async-execute-on-provider/ title=服务端异步 class=md-nav__link> 服务端异步 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/local-call/ title=本地调用 class=md-nav__link> 本地调用 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/callback-parameter/ title=参数回调 class=md-nav__link> 参数回调 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/events-notify/ title=事件通知 class=md-nav__link> 事件通知 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/local-stub/ title=本地存根 class=md-nav__link> 本地存根 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/local-mock/ title=本地伪装 class=md-nav__link> 本地伪装 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/delay-publish/ title=延迟暴露 class=md-nav__link> 延迟暴露 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/concurrency-control/ title=并发控制 class=md-nav__link> 并发控制 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/config-connection.md title=连接控制 class=md-nav__link> 连接控制 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/lazy-connect/ title=延迟连接 class=md-nav__link> 延迟连接 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/stickiness/ title=粘滞连接 class=md-nav__link> 粘滞连接 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/token-authorization/ title=令牌验证 class=md-nav__link> 令牌验证 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/routing-rule/ title=路由规则 class=md-nav__link> 路由规则 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/config-rule/ title=配置规则 class=md-nav__link> 配置规则 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/service-downgrade/ title=服务降级 class=md-nav__link> 服务降级 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/graceful-shutdown/ title=优雅停机 class=md-nav__link> 优雅停机 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/hostname-binding/ title=主机绑定 class=md-nav__link> 主机绑定 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/logger-strategy/ title=日志适配 class=md-nav__link> 日志适配 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/accesslog/ title=访问日志 class=md-nav__link> 访问日志 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/service-container/ title=服务容器 class=md-nav__link> 服务容器 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/distributed-transaction/ title=分布式事务 class=md-nav__link> 分布式事务 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/dump/ title=线程栈自动dump class=md-nav__link> 线程栈自动dump </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/netty4/ title=Netty4 class=md-nav__link> Netty4 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/serialization/ title=Kryo和FST序列化 class=md-nav__link> Kryo和FST序列化 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/simplify-registry-data/ title=简化注册中心URL class=md-nav__link> 简化注册中心URL </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/demos/api.md title="API 参考手册" class=md-nav__link> API 参考手册 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-7 type=checkbox id=nav-1-1-7> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-7> schema 配置参考手册 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="schema 配置参考手册" data-md-level=3> <label class=md-nav__title for=nav-1-1-7> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> schema 配置参考手册 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/xml/introduction/ title=简介 class=md-nav__link> 简介 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/xml/dubbo-service/ title=dubbo:service class=md-nav__link> dubbo:service </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/xml/dubbo-reference/ title=dubbo:reference class=md-nav__link> dubbo:reference </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/xml/dubbo-protocol/ title=dubbo:protocol class=md-nav__link> dubbo:protocol </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/xml/dubbo-registry/ title=dubbo:registry class=md-nav__link> dubbo:registry </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/xml/dubbo-monitor/ title=dubbo:monitor class=md-nav__link> dubbo:monitor </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/xml/dubbo-application/ title=dubbo:application class=md-nav__link> dubbo:application </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/xml/dubbo-module/ title=dubbo:module class=md-nav__link> dubbo:module </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/xml/dubbo-provider/ title=dubbo:provider class=md-nav__link> dubbo:provider </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/xml/dubbo-consumer/ title=dubbo:consumer class=md-nav__link> dubbo:consumer </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/xml/dubbo-method/ title=dubbo:method class=md-nav__link> dubbo:method </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/xml/dubbo-argument/ title=dubbo:argument class=md-nav__link> dubbo:argument </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/xml/dubbo-parameter/ title=dubbo:parameter class=md-nav__link> dubbo:parameter </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/xml/dubbo-config-center/ title=dubbo:config-center class=md-nav__link> dubbo:config-center </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-8 type=checkbox id=nav-1-1-8> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-8> 协议参考手册 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=协议参考手册 data-md-level=3> <label class=md-nav__title for=nav-1-1-8> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 协议参考手册 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/protocol/dubbo/ title=dubbo:// class=md-nav__link> dubbo:// </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/protocol/rmi/ title=rmi:// class=md-nav__link> rmi:// </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/protocol/hessian/ title=hessian:// class=md-nav__link> hessian:// </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/protocol/http/ title=http:// class=md-nav__link> http:// </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/protocol/thrift/ title=thrift:// class=md-nav__link> thrift:// </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/protocol/rest/ title=rest:// class=md-nav__link> rest:// </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-9 type=checkbox id=nav-1-1-9> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-9> 注册中心参考手册 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=注册中心参考手册 data-md-level=3> <label class=md-nav__title for=nav-1-1-9> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 注册中心参考手册 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/registry/multicast/ title="Multicast 注册中心" class=md-nav__link> Multicast 注册中心 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/registry/zookeeper/ title="Zookeeper 注册中心" class=md-nav__link> Zookeeper 注册中心 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/registry/redis/ title="Redis 注册中心" class=md-nav__link> Redis 注册中心 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/registry/simple/ title="Simple 注册中心" class=md-nav__link> Simple 注册中心 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-10 type=checkbox id=nav-1-1-10> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-10> 元数据中心参考手册 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=元数据中心参考手册 data-md-level=3> <label class=md-nav__title for=nav-1-1-10> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 元数据中心参考手册 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/metadata/metadata-redis/ title="Redis 元数据中心" class=md-nav__link> Redis 元数据中心 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/metadata/metadata-zookeeper/ title="Zookeeper 元数据中心" class=md-nav__link> Zookeeper 元数据中心 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/telnet/ title="telnet 命令参考手册" class=md-nav__link> telnet 命令参考手册 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/qos/ title=在线运维命令-QOS class=md-nav__link> 在线运维命令-QOS </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/references/maven/ title="maven 插件参考手册" class=md-nav__link> maven 插件参考手册 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/best-practice/ title=服务化最佳实践 class=md-nav__link> 服务化最佳实践 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/recommend/ title=推荐用法 class=md-nav__link> 推荐用法 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/capacity-plan/ title=容量规划 class=md-nav__link> 容量规划 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/perf-test/ title=性能测试报告 class=md-nav__link> 性能测试报告 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/covergence.md title=测试覆盖率报告 class=md-nav__link> 测试覆盖率报告 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-19 type=checkbox id=nav-1-1-19> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-19> 版本与升级 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=版本与升级 data-md-level=3> <label class=md-nav__title for=nav-1-1-19> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 版本与升级 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/versions/version-270/ title=2.7.x升级步骤及注意事项 class=md-nav__link> 2.7.x升级步骤及注意事项 </a> </li> </ul> </nav> </li> <!-- Currently active page --> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-2 type=checkbox id=nav-1-2> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-2> 开发手册 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=开发手册 data-md-level=2> <label class=md-nav__title for=nav-1-2> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 开发手册 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/build.md title=源码构建 class=md-nav__link> 源码构建 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/design.md title=框架设计 class=md-nav__link> 框架设计 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/SPI.md title=扩展点加载 class=md-nav__link> 扩展点加载 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/implementation.md title=实现细节 class=md-nav__link> 实现细节 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-2-5 type=checkbox id=nav-1-2-5> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-2-5> SPI 扩展实现 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="SPI 扩展实现" data-md-level=3> <label class=md-nav__title for=nav-1-2-5> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> SPI 扩展实现 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/protocol.md title=协议扩展 class=md-nav__link> 协议扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/filter.md title=调用拦截扩展 class=md-nav__link> 调用拦截扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/invoker-listener.md title=引用监听扩展 class=md-nav__link> 引用监听扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/exporter-listener.md title=暴露监听扩展 class=md-nav__link> 暴露监听扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/cluster.md title=集群扩展 class=md-nav__link> 集群扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/router.md title=路由扩展 class=md-nav__link> 路由扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/load-balance.md title=负载均衡扩展 class=md-nav__link> 负载均衡扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/merger.md title=合并结果扩展 class=md-nav__link> 合并结果扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/registry.md title=注册中心扩展 class=md-nav__link> 注册中心扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/monitor.md title=监控中心扩展 class=md-nav__link> 监控中心扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/extension-factory.md title=扩展点加载扩展 class=md-nav__link> 扩展点加载扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/proxy-factory.md title=动态代理扩展 class=md-nav__link> 动态代理扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/compiler.md title=编译器扩展 class=md-nav__link> 编译器扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/dispatcher.md title=消息派发扩展 class=md-nav__link> 消息派发扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/threadpool.md title=线程池扩展 class=md-nav__link> 线程池扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/serialize.md title=序列化扩展 class=md-nav__link> 序列化扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/remoting.md title=网络传输扩展 class=md-nav__link> 网络传输扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/exchanger.md title=信息交换扩展 class=md-nav__link> 信息交换扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/networker.md title=组网扩展 class=md-nav__link> 组网扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/telnet-handler.md title="Telnet 命令扩展" class=md-nav__link> Telnet 命令扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/status-checker.md title=状态检查扩展 class=md-nav__link> 状态检查扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/container.md title=容器扩展 class=md-nav__link> 容器扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/page.md title=页面扩展 class=md-nav__link> 页面扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/cache.md title=缓存扩展 class=md-nav__link> 缓存扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/validation.md title=验证扩展 class=md-nav__link> 验证扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/logger-adapter.md title=日志适配扩展 class=md-nav__link> 日志适配扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/config-center.md title=配置中心 class=md-nav__link> 配置中心 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/contract.md title=公共契约 class=md-nav__link> 公共契约 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/coding.md title=编码约定 class=md-nav__link> 编码约定 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-2-8 type=checkbox id=nav-1-2-8> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-2-8> 设计原则 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=设计原则 data-md-level=3> <label class=md-nav__title for=nav-1-2-8> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 设计原则 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/code-detail.md title=魔鬼在细节 class=md-nav__link> 魔鬼在细节 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/general-knowledge.md title=一些设计上的基本常识 class=md-nav__link> 一些设计上的基本常识 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/expansibility.md title=谈谈扩充式扩展与增量式扩展 class=md-nav__link> 谈谈扩充式扩展与增量式扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/configuration.md title=配置设计 class=md-nav__link> 配置设计 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/robustness.md title=设计实现的健壮性 class=md-nav__link> 设计实现的健壮性 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/dummy.md title=防痴呆设计 class=md-nav__link> 防痴呆设计 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/extension.md title=扩展点重构 class=md-nav__link> 扩展点重构 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/release.md title=版本发布 class=md-nav__link> 版本发布 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/contribution.md title=贡献代码 class=md-nav__link> 贡献代码 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/checklist.md title=检查列表 class=md-nav__link> 检查列表 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/code-smell.md title=坏味道 class=md-nav__link> 坏味道 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/TCK.md title=兼容性测试 class=md-nav__link> 兼容性测试 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-3 type=checkbox id=nav-1-3> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-3> 管理者文档 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=管理者文档 data-md-level=2> <label class=md-nav__title for=nav-1-3> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 管理者文档 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../admin/introduction.md title="Dubbo Admin介绍" class=md-nav__link> Dubbo Admin介绍 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../admin/serviceSearch.md title=服务搜索和详情 class=md-nav__link> 服务搜索和详情 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../admin/serviceGovernance.md title=服务治理 class=md-nav__link> 服务治理 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../admin/serviceTest.md title=服务测试 class=md-nav__link> 服务测试 </a> </li> </ul> </nav> </li> <!-- Currently active page --> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1> 3.0 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=3.0 data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 3.0 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1 type=checkbox id=nav-1-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1> User's Guide <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="User's Guide" data-md-level=2> <label class=md-nav__title for=nav-1-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> User's Guide </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-1 type=checkbox id=nav-1-1-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-1> Preface <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=Preface data-md-level=3> <label class=md-nav__title for=nav-1-1-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Preface </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../3.0/user/preface/background/ title=Bakcground class=md-nav__link> Bakcground </a> </li> </ul> </nav> </li> <!-- Currently active page --> </ul> </nav> </li> <!-- Currently active page --> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1> Blog <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=Blog data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Blog </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/apache-dubbo-2019-2020/ title=2019-2020 class=md-nav__link> 2019-2020 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/service-test/ title=服务测试 class=md-nav__link> 服务测试 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/dubboAsync_server/ title="Implementation background and practice of Dubbo server asynchronous interface" class=md-nav__link> Implementation background and practice of Dubbo server asynchronous interface </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/dubboAsync_client/ title="Implementation background and practice of Dubbo client asynchronous interface" class=md-nav__link> Implementation background and practice of Dubbo client asynchronous interface </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/dubbo-fescar/ title="How to use Fescar to ensure consistency between Dubbo Microservices" class=md-nav__link> How to use Fescar to ensure consistency between Dubbo Microservices </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/prepare-an-apache-release/ title="Prepare an Apache Release" class=md-nav__link> Prepare an Apache Release </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/dubbo-protocol/ title="Dubbo protocol" class=md-nav__link> Dubbo protocol </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/dubbo-101/ title="Your First Dubbo Demo" class=md-nav__link> Your First Dubbo Demo </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/first-dubbo-filter/ title="Your First Dubbo filter" class=md-nav__link> Your First Dubbo filter </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/dubbo-zk/ title="Using Zookeeper in Dubbo" class=md-nav__link> Using Zookeeper in Dubbo </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/dubbo-annotation/ title="Using annotation in Dubbo" class=md-nav__link> Using annotation in Dubbo </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/introduction-to-dubbo-spi/ title="Introduction to Dubbo spi" class=md-nav__link> Introduction to Dubbo spi </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/spring-boot-dubbo-start-stop-analysis/ title="Source code analysis of spring-boot+Dubbo App start and stop" class=md-nav__link> Source code analysis of spring-boot+Dubbo App start and stop </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/introduction-to-dubbo-spi-2/ title="Dubbo extensible mechanism source code analysis" class=md-nav__link> Dubbo extensible mechanism source code analysis </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/introduction-to-dubbo-qos/ title="Manipulating Services Dynamically via QoS" class=md-nav__link> Manipulating Services Dynamically via QoS </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/dubbo-loadbalance/ title="Dubbo Loadbalance" class=md-nav__link> Dubbo Loadbalance </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/sentinel-introduction-for-dubbo/ title="Sentinel: The flow sentinel of Dubbo service" class=md-nav__link> Sentinel: The flow sentinel of Dubbo service </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/pinpoint/ title="Tracking with Pinpoint" class=md-nav__link> Tracking with Pinpoint </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1> 开发者指引 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=开发者指引 data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 开发者指引 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../developers/guide_dev/ title=如何做出贡献 class=md-nav__link> 如何做出贡献 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../developers/developers_dev/ title=开发者 class=md-nav__link> 开发者 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-3 type=checkbox id=nav-1-3> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-3> 使用指南 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=使用指南 data-md-level=2> <label class=md-nav__title for=nav-1-3> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 使用指南 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../developers/user-guide/faq_dev/ title=faq class=md-nav__link> faq </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-4 type=checkbox id=nav-1-4> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-4> 贡献者指南 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=贡献者指南 data-md-level=2> <label class=md-nav__title for=nav-1-4> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 贡献者指南 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../developers/contributor-guide/new-contributor-guide_dev/ title="New contributor guide" class=md-nav__link> New contributor guide </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../developers/contributor-guide/software-donation-guide_dev/ title="Software donation guide" class=md-nav__link> Software donation guide </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../developers/contributor-guide/test-coverage-guide_dev/ title="Test coverage guide" class=md-nav__link> Test coverage guide </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../developers/contributor-guide/mailing-list-subscription-guide_dev/ title="Mailing list subscription guide" class=md-nav__link> Mailing list subscription guide </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../developers/contributor-guide/cla-signing-guide_dev/ title="CLA Signing Guide" class=md-nav__link> CLA Signing Guide </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../developers/contributor-guide/dubbo-extension-guide_dev/ title="Extension guide" class=md-nav__link> Extension guide </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../developers/contributor-guide/become-a-committer_dev/ title="How to become a committer" class=md-nav__link> How to become a committer </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../developers/reporting-security-issues_dev.md title="How to report security issues" class=md-nav__link> How to report security issues </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-5 type=checkbox id=nav-1-5> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-5> 提交者指南 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=提交者指南 data-md-level=2> <label class=md-nav__title for=nav-1-5> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 提交者指南 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../developers/committer-guide/new-committer-guide_dev/ title="New Committer guide" class=md-nav__link> New Committer guide </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../developers/committer-guide/label-an-issue-guide_dev/ title="Label an Issue" class=md-nav__link> Label an Issue </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../developers/committer-guide/website-guide_dev/ title="Website Guide" class=md-nav__link> Website Guide </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../developers/committer-guide/apache-dubbo-page_dev/ title="Apache Dubbo Page Maintenance" class=md-nav__link> Apache Dubbo Page Maintenance </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../developers/committer-guide/release-guide_dev/ title="Release Guide" class=md-nav__link> Release Guide </a> </li> </ul> </nav> </li> <!-- Currently active page --> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1> 下载 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=下载 data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 下载 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/download/ title=版本列表 class=md-nav__link> 版本列表 </a> </li> </ul> </nav> </li> <!-- Currently active page --> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 目录 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1 class=md-nav__link> 1. 简介 </a> </li> <li class=md-nav__item> <a href=#2 class=md-nav__link> 2. 源码分析 </a> <nav class=md-nav aria-label="2. 源码分析"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21 class=md-nav__link> 2.1 服务调用方式 </a> </li> <li class=md-nav__item> <a href=#22 class=md-nav__link> 2.2 服务消费方发送请求 </a> <nav class=md-nav aria-label="2.2 服务消费方发送请求"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#221 class=md-nav__link> 2.2.1 发送请求 </a> </li> <li class=md-nav__item> <a href=#222 class=md-nav__link> 2.2.2 请求编码 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#23 class=md-nav__link> 2.3 服务提供方接收请求 </a> <nav class=md-nav aria-label="2.3 服务提供方接收请求"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#231 class=md-nav__link> 2.3.1 请求解码 </a> </li> <li class=md-nav__item> <a href=#232 class=md-nav__link> 2.3.2 调用服务 </a> <nav class=md-nav aria-label="2.3.2 调用服务"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#2321 class=md-nav__link> 2.3.2.1 线程派发模型 </a> </li> <li class=md-nav__item> <a href=#2322 class=md-nav__link> 2.3.2.2 调用服务 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#24 class=md-nav__link> 2.4 服务提供方返回调用结果 </a> </li> <li class=md-nav__item> <a href=#25 class=md-nav__link> 2.5 服务消费方接收调用结果 </a> <nav class=md-nav aria-label="2.5 服务消费方接收调用结果"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#251 class=md-nav__link> 2.5.1 响应数据解码 </a> </li> <li class=md-nav__item> <a href=#252 class=md-nav__link> 2.5.2 向用户线程传递调用结果 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3 class=md-nav__link> 3. 总结 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/apache/dubbo-website/edit/master/zh-cn/docs/2.7/source_code_guide/service-invoking-process.md title=编辑此页 class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1>Service invoking process</h1> <h2 id=1>1. 简介<a class=headerlink href=#1 title="Permanent link">&para;</a></h2> <p>在前面的文章中，我们分析了 Dubbo SPI、服务导出与引入、以及集群容错方面的代码。经过前文的铺垫，本篇文章我们终于可以分析服务调用过程了。Dubbo 服务调用过程比较复杂，包含众多步骤，比如发送请求、编解码、服务降级、过滤器链处理、序列化、线程派发以及响应请求等步骤。限于篇幅原因，本篇文章无法对所有的步骤一一进行分析。本篇文章将会重点分析请求的发送与接收、编解码、线程派发以及响应的发送与接收等过程，至于服务降级、过滤器链和序列化大家自行进行分析，也可以将其当成一个黑盒，暂时忽略也没关系。介绍完本篇文章要分析的内容，接下来我们进入正题吧。</p> <h2 id=2>2. 源码分析<a class=headerlink href=#2 title="Permanent link">&para;</a></h2> <p>在进行源码分析之前，我们先来通过一张图了解 Dubbo 服务调用过程。</p> <p><img alt src=../sources/images/send-request-process.jpg></p> <p>首先服务消费者通过代理对象 Proxy 发起远程调用，接着通过网络客户端 Client 将编码后的请求发送给服务提供方的网络层上，也就是 Server。Server 在收到请求后，首先要做的事情是对数据包进行解码。然后将解码后的请求发送至分发器 Dispatcher，再由分发器将请求派发到指定的线程池上，最后由线程池调用具体的服务。这就是一个远程调用请求的发送与接收过程。至于响应的发送与接收过程，这张图中没有表现出来。对于这两个过程，我们也会进行详细分析。</p> <h3 id=21>2.1 服务调用方式<a class=headerlink href=#21 title="Permanent link">&para;</a></h3> <p>Dubbo 支持同步和异步两种调用方式，其中异步调用还可细分为“有返回值”的异步调用和“无返回值”的异步调用。所谓“无返回值”异步调用是指服务消费方只管调用，但不关心调用结果，此时 Dubbo 会直接返回一个空的 RpcResult。若要使用异步特性，需要服务消费方手动进行配置。默认情况下，Dubbo 使用同步调用方式。</p> <p>本节以及其他章节将会使用 Dubbo 官方提供的 Demo 分析整个调用过程，下面我们从 DemoService 接口的代理类开始进行分析。Dubbo 默认使用 Javassist 框架为服务接口生成动态代理类，因此我们需要先将代理类进行反编译才能看到源码。这里使用阿里开源 Java 应用诊断工具 <a href=https://github.com/alibaba/arthas>Arthas</a> 反编译代理类，结果如下：</p> <div class=highlight><pre><span></span><code><span class=cm>/**</span>
<span class=cm> * Arthas 反编译步骤：</span>
<span class=cm> * 1. 启动 Arthas</span>
<span class=cm> *    java -jar arthas-boot.jar</span>
<span class=cm> *</span>
<span class=cm> * 2. 输入编号选择进程</span>
<span class=cm> *    Arthas 启动后，会打印 Java 应用进程列表，如下：</span>
<span class=cm> *    [1]: 11232 org.jetbrains.jps.cmdline.Launcher</span>
<span class=cm> *    [2]: 22370 org.jetbrains.jps.cmdline.Launcher</span>
<span class=cm> *    [3]: 22371 com.alibaba.dubbo.demo.consumer.Consumer</span>
<span class=cm> *    [4]: 22362 com.alibaba.dubbo.demo.provider.Provider</span>
<span class=cm> *    [5]: 2074 org.apache.zookeeper.server.quorum.QuorumPeerMain</span>
<span class=cm> * 这里输入编号 3，让 Arthas 关联到启动类为 com.....Consumer 的 Java 进程上</span>
<span class=cm> *</span>
<span class=cm> * 3. 由于 Demo 项目中只有一个服务接口，因此此接口的代理类类名为 proxy0，此时使用 sc 命令搜索这个类名。</span>
<span class=cm> *    $ sc *.proxy0</span>
<span class=cm> *    com.alibaba.dubbo.common.bytecode.proxy0</span>
<span class=cm> *</span>
<span class=cm> * 4. 使用 jad 命令反编译 com.alibaba.dubbo.common.bytecode.proxy0</span>
<span class=cm> *    $ jad com.alibaba.dubbo.common.bytecode.proxy0</span>
<span class=cm> *</span>
<span class=cm> * 更多使用方法请参考 Arthas 官方文档：</span>
<span class=cm> *   https://alibaba.github.io/arthas/quick-start.html</span>
<span class=cm> */</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>proxy0</span> <span class=kd>implements</span> <span class=n>ClassGenerator</span><span class=p>.</span><span class=na>DC</span><span class=p>,</span> <span class=n>EchoService</span><span class=p>,</span> <span class=n>DemoService</span> <span class=p>{</span>
    <span class=c1>// 方法数组</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=n>Method</span><span class=o>[]</span> <span class=n>methods</span><span class=p>;</span>
    <span class=kd>private</span> <span class=n>InvocationHandler</span> <span class=n>handler</span><span class=p>;</span>

    <span class=kd>public</span> <span class=nf>proxy0</span><span class=p>(</span><span class=n>InvocationHandler</span> <span class=n>invocationHandler</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=na>handler</span> <span class=o>=</span> <span class=n>invocationHandler</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kd>public</span> <span class=nf>proxy0</span><span class=p>()</span> <span class=p>{</span>
    <span class=p>}</span>

    <span class=kd>public</span> <span class=n>String</span> <span class=nf>sayHello</span><span class=p>(</span><span class=n>String</span> <span class=n>string</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// 将参数存储到 Object 数组中</span>
        <span class=n>Object</span><span class=o>[]</span> <span class=n>arrobject</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=n>string</span><span class=p>};</span>
        <span class=c1>// 调用 InvocationHandler 实现类的 invoke 方法得到调用结果</span>
        <span class=n>Object</span> <span class=n>object</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=na>handler</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>methods</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>,</span> <span class=n>arrobject</span><span class=p>);</span>
        <span class=c1>// 返回调用结果</span>
        <span class=k>return</span> <span class=p>(</span><span class=n>String</span><span class=p>)</span><span class=n>object</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=cm>/** 回声测试方法 */</span>
    <span class=kd>public</span> <span class=n>Object</span> <span class=nf>$echo</span><span class=p>(</span><span class=n>Object</span> <span class=n>object</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Object</span><span class=o>[]</span> <span class=n>arrobject</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=n>object</span><span class=p>};</span>
        <span class=n>Object</span> <span class=n>object2</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=na>handler</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>methods</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span><span class=p>,</span> <span class=n>arrobject</span><span class=p>);</span>
        <span class=k>return</span> <span class=n>object2</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>如上，代理类的逻辑比较简单。首先将运行时参数存储到数组中，然后调用 InvocationHandler 接口实现类的 invoke 方法，得到调用结果，最后将结果转型并返回给调用方。关于代理类的逻辑就说这么多，继续向下分析。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>InvokerInvocationHandler</span> <span class=kd>implements</span> <span class=n>InvocationHandler</span> <span class=p>{</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Invoker</span><span class=o>&lt;?&gt;</span> <span class=n>invoker</span><span class=p>;</span>

    <span class=kd>public</span> <span class=nf>InvokerInvocationHandler</span><span class=p>(</span><span class=n>Invoker</span><span class=o>&lt;?&gt;</span> <span class=n>handler</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=na>invoker</span> <span class=o>=</span> <span class=n>handler</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>Object</span> <span class=nf>invoke</span><span class=p>(</span><span class=n>Object</span> <span class=n>proxy</span><span class=p>,</span> <span class=n>Method</span> <span class=n>method</span><span class=p>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>Throwable</span> <span class=p>{</span>
        <span class=n>String</span> <span class=n>methodName</span> <span class=o>=</span> <span class=n>method</span><span class=p>.</span><span class=na>getName</span><span class=p>();</span>
        <span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=n>parameterTypes</span> <span class=o>=</span> <span class=n>method</span><span class=p>.</span><span class=na>getParameterTypes</span><span class=p>();</span>

        <span class=c1>// 拦截定义在 Object 类中的方法（未被子类重写），比如 wait/notify</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>method</span><span class=p>.</span><span class=na>getDeclaringClass</span><span class=p>()</span> <span class=o>==</span> <span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=n>method</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>invoker</span><span class=p>,</span> <span class=n>args</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=c1>// 如果 toString、hashCode 和 equals 等方法被子类重写了，这里也直接调用</span>
        <span class=k>if</span> <span class=p>(</span><span class=s>&quot;toString&quot;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>methodName</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>parameterTypes</span><span class=p>.</span><span class=na>length</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=n>invoker</span><span class=p>.</span><span class=na>toString</span><span class=p>();</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=s>&quot;hashCode&quot;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>methodName</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>parameterTypes</span><span class=p>.</span><span class=na>length</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=n>invoker</span><span class=p>.</span><span class=na>hashCode</span><span class=p>();</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=s>&quot;equals&quot;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>methodName</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>parameterTypes</span><span class=p>.</span><span class=na>length</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=n>invoker</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>args</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=c1>// 将 method 和 args 封装到 RpcInvocation 中，并执行后续的调用</span>
        <span class=k>return</span> <span class=n>invoker</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=k>new</span> <span class=n>RpcInvocation</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>args</span><span class=p>)).</span><span class=na>recreate</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>InvokerInvocationHandler 中的 invoker 成员变量类型为 MockClusterInvoker，MockClusterInvoker 内部封装了服务降级逻辑。下面简单看一下：</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MockClusterInvoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>invoker</span><span class=p>;</span>

    <span class=kd>public</span> <span class=n>Result</span> <span class=nf>invoke</span><span class=p>(</span><span class=n>Invocation</span> <span class=n>invocation</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RpcException</span> <span class=p>{</span>
        <span class=n>Result</span> <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>

        <span class=c1>// 获取 mock 配置值</span>
        <span class=n>String</span> <span class=n>value</span> <span class=o>=</span> <span class=n>directory</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getMethodParameter</span><span class=p>(</span><span class=n>invocation</span><span class=p>.</span><span class=na>getMethodName</span><span class=p>(),</span> <span class=n>Constants</span><span class=p>.</span><span class=na>MOCK_KEY</span><span class=p>,</span> <span class=n>Boolean</span><span class=p>.</span><span class=na>FALSE</span><span class=p>.</span><span class=na>toString</span><span class=p>()).</span><span class=na>trim</span><span class=p>();</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>value</span><span class=p>.</span><span class=na>length</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>value</span><span class=p>.</span><span class=na>equalsIgnoreCase</span><span class=p>(</span><span class=s>&quot;false&quot;</span><span class=p>))</span> <span class=p>{</span>
            <span class=c1>// 无 mock 逻辑，直接调用其他 Invoker 对象的 invoke 方法，</span>
            <span class=c1>// 比如 FailoverClusterInvoker</span>
            <span class=n>result</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=na>invoker</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>invocation</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>value</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&quot;force&quot;</span><span class=p>))</span> <span class=p>{</span>
            <span class=c1>// force:xxx 直接执行 mock 逻辑，不发起远程调用</span>
            <span class=n>result</span> <span class=o>=</span> <span class=n>doMockInvoke</span><span class=p>(</span><span class=n>invocation</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=c1>// fail:xxx 表示消费方对调用服务失败后，再执行 mock 逻辑，不抛出异常</span>
            <span class=k>try</span> <span class=p>{</span>
                <span class=c1>// 调用其他 Invoker 对象的 invoke 方法</span>
                <span class=n>result</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=na>invoker</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>invocation</span><span class=p>);</span>
            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>RpcException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>isBiz</span><span class=p>())</span> <span class=p>{</span>
                    <span class=k>throw</span> <span class=n>e</span><span class=p>;</span>
                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                    <span class=c1>// 调用失败，执行 mock 逻辑</span>
                    <span class=n>result</span> <span class=o>=</span> <span class=n>doMockInvoke</span><span class=p>(</span><span class=n>invocation</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=c1>// 省略其他方法</span>
<span class=p>}</span>
</code></pre></div> <p>服务降级不是本文重点，因此这里就不分析 doMockInvoke 方法了。考虑到前文已经详细分析过 FailoverClusterInvoker，因此本节略过 FailoverClusterInvoker，直接分析 DubboInvoker。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>AbstractInvoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>

    <span class=kd>public</span> <span class=n>Result</span> <span class=nf>invoke</span><span class=p>(</span><span class=n>Invocation</span> <span class=n>inv</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RpcException</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>destroyed</span><span class=p>.</span><span class=na>get</span><span class=p>())</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>RpcException</span><span class=p>(</span><span class=s>&quot;Rpc invoker for service ...&quot;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=n>RpcInvocation</span> <span class=n>invocation</span> <span class=o>=</span> <span class=p>(</span><span class=n>RpcInvocation</span><span class=p>)</span> <span class=n>inv</span><span class=p>;</span>
        <span class=c1>// 设置 Invoker</span>
        <span class=n>invocation</span><span class=p>.</span><span class=na>setInvoker</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>attachment</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>attachment</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 设置 attachment</span>
            <span class=n>invocation</span><span class=p>.</span><span class=na>addAttachmentsIfAbsent</span><span class=p>(</span><span class=n>attachment</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>contextAttachments</span> <span class=o>=</span> <span class=n>RpcContext</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>getAttachments</span><span class=p>();</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>contextAttachments</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>contextAttachments</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 添加 contextAttachments 到 RpcInvocation#attachment 变量中</span>
            <span class=n>invocation</span><span class=p>.</span><span class=na>addAttachments</span><span class=p>(</span><span class=n>contextAttachments</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>getUrl</span><span class=p>().</span><span class=na>getMethodParameter</span><span class=p>(</span><span class=n>invocation</span><span class=p>.</span><span class=na>getMethodName</span><span class=p>(),</span> <span class=n>Constants</span><span class=p>.</span><span class=na>ASYNC_KEY</span><span class=p>,</span> <span class=kc>false</span><span class=p>))</span> <span class=p>{</span>
            <span class=c1>// 设置异步信息到 RpcInvocation#attachment 中</span>
            <span class=n>invocation</span><span class=p>.</span><span class=na>setAttachment</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>ASYNC_KEY</span><span class=p>,</span> <span class=n>Boolean</span><span class=p>.</span><span class=na>TRUE</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span>
        <span class=p>}</span>
        <span class=n>RpcUtils</span><span class=p>.</span><span class=na>attachInvocationIdIfAsync</span><span class=p>(</span><span class=n>getUrl</span><span class=p>(),</span> <span class=n>invocation</span><span class=p>);</span>

        <span class=k>try</span> <span class=p>{</span>
            <span class=c1>// 抽象方法，由子类实现</span>
            <span class=k>return</span> <span class=n>doInvoke</span><span class=p>(</span><span class=n>invocation</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>InvocationTargetException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// ...</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>RpcException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// ...</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=k>new</span> <span class=n>RpcResult</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=kd>protected</span> <span class=kd>abstract</span> <span class=n>Result</span> <span class=nf>doInvoke</span><span class=p>(</span><span class=n>Invocation</span> <span class=n>invocation</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>Throwable</span><span class=p>;</span>

    <span class=c1>// 省略其他方法</span>
<span class=p>}</span>
</code></pre></div> <p>上面的代码来自 AbstractInvoker 类，其中大部分代码用于添加信息到 RpcInvocation#attachment 变量中，添加完毕后，调用 doInvoke 执行后续的调用。doInvoke 是一个抽象方法，需要由子类实现，下面到 DubboInvoker 中看一下。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DubboInvoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>AbstractInvoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>ExchangeClient</span><span class=o>[]</span> <span class=n>clients</span><span class=p>;</span>

    <span class=kd>protected</span> <span class=n>Result</span> <span class=nf>doInvoke</span><span class=p>(</span><span class=kd>final</span> <span class=n>Invocation</span> <span class=n>invocation</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>Throwable</span> <span class=p>{</span>
        <span class=n>RpcInvocation</span> <span class=n>inv</span> <span class=o>=</span> <span class=p>(</span><span class=n>RpcInvocation</span><span class=p>)</span> <span class=n>invocation</span><span class=p>;</span>
        <span class=kd>final</span> <span class=n>String</span> <span class=n>methodName</span> <span class=o>=</span> <span class=n>RpcUtils</span><span class=p>.</span><span class=na>getMethodName</span><span class=p>(</span><span class=n>invocation</span><span class=p>);</span>
        <span class=c1>// 设置 path 和 version 到 attachment 中</span>
        <span class=n>inv</span><span class=p>.</span><span class=na>setAttachment</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>PATH_KEY</span><span class=p>,</span> <span class=n>getUrl</span><span class=p>().</span><span class=na>getPath</span><span class=p>());</span>
        <span class=n>inv</span><span class=p>.</span><span class=na>setAttachment</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>VERSION_KEY</span><span class=p>,</span> <span class=n>version</span><span class=p>);</span>

        <span class=n>ExchangeClient</span> <span class=n>currentClient</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>clients</span><span class=p>.</span><span class=na>length</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 从 clients 数组中获取 ExchangeClient</span>
            <span class=n>currentClient</span> <span class=o>=</span> <span class=n>clients</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=n>currentClient</span> <span class=o>=</span> <span class=n>clients</span><span class=o>[</span><span class=n>index</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>()</span> <span class=o>%</span> <span class=n>clients</span><span class=p>.</span><span class=na>length</span><span class=o>]</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=c1>// 获取异步配置</span>
            <span class=kt>boolean</span> <span class=n>isAsync</span> <span class=o>=</span> <span class=n>RpcUtils</span><span class=p>.</span><span class=na>isAsync</span><span class=p>(</span><span class=n>getUrl</span><span class=p>(),</span> <span class=n>invocation</span><span class=p>);</span>
            <span class=c1>// isOneway 为 true，表示“单向”通信</span>
            <span class=kt>boolean</span> <span class=n>isOneway</span> <span class=o>=</span> <span class=n>RpcUtils</span><span class=p>.</span><span class=na>isOneway</span><span class=p>(</span><span class=n>getUrl</span><span class=p>(),</span> <span class=n>invocation</span><span class=p>);</span>
            <span class=kt>int</span> <span class=n>timeout</span> <span class=o>=</span> <span class=n>getUrl</span><span class=p>().</span><span class=na>getMethodParameter</span><span class=p>(</span><span class=n>methodName</span><span class=p>,</span> <span class=n>Constants</span><span class=p>.</span><span class=na>TIMEOUT_KEY</span><span class=p>,</span> <span class=n>Constants</span><span class=p>.</span><span class=na>DEFAULT_TIMEOUT</span><span class=p>);</span>

            <span class=c1>// 异步无返回值</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>isOneway</span><span class=p>)</span> <span class=p>{</span>
                <span class=kt>boolean</span> <span class=n>isSent</span> <span class=o>=</span> <span class=n>getUrl</span><span class=p>().</span><span class=na>getMethodParameter</span><span class=p>(</span><span class=n>methodName</span><span class=p>,</span> <span class=n>Constants</span><span class=p>.</span><span class=na>SENT_KEY</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
                <span class=c1>// 发送请求</span>
                <span class=n>currentClient</span><span class=p>.</span><span class=na>send</span><span class=p>(</span><span class=n>inv</span><span class=p>,</span> <span class=n>isSent</span><span class=p>);</span>
                <span class=c1>// 设置上下文中的 future 字段为 null</span>
                <span class=n>RpcContext</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>setFuture</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
                <span class=c1>// 返回一个空的 RpcResult</span>
                <span class=k>return</span> <span class=k>new</span> <span class=n>RpcResult</span><span class=p>();</span>
            <span class=p>}</span> 

            <span class=c1>// 异步有返回值</span>
            <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>isAsync</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 发送请求，并得到一个 ResponseFuture 实例</span>
                <span class=n>ResponseFuture</span> <span class=n>future</span> <span class=o>=</span> <span class=n>currentClient</span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>inv</span><span class=p>,</span> <span class=n>timeout</span><span class=p>);</span>
                <span class=c1>// 设置 future 到上下文中</span>
                <span class=n>RpcContext</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>setFuture</span><span class=p>(</span><span class=k>new</span> <span class=n>FutureAdapter</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=p>(</span><span class=n>future</span><span class=p>));</span>
                <span class=c1>// 暂时返回一个空结果</span>
                <span class=k>return</span> <span class=k>new</span> <span class=n>RpcResult</span><span class=p>();</span>
            <span class=p>}</span> 

            <span class=c1>// 同步调用</span>
            <span class=k>else</span> <span class=p>{</span>
                <span class=n>RpcContext</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>setFuture</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
                <span class=c1>// 发送请求，得到一个 ResponseFuture 实例，并调用该实例的 get 方法进行等待</span>
                <span class=k>return</span> <span class=p>(</span><span class=n>Result</span><span class=p>)</span> <span class=n>currentClient</span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>inv</span><span class=p>,</span> <span class=n>timeout</span><span class=p>).</span><span class=na>get</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>TimeoutException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>RpcException</span><span class=p>(...,</span> <span class=s>&quot;Invoke remote method timeout....&quot;</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>RemotingException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>RpcException</span><span class=p>(...,</span> <span class=s>&quot;Failed to invoke remote method: ...&quot;</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// 省略其他方法</span>
<span class=p>}</span>
</code></pre></div> <p>上面的代码包含了 Dubbo 对同步和异步调用的处理逻辑，搞懂了上面的代码，会对 Dubbo 的同步和异步调用方式有更深入的了解。Dubbo 实现同步和异步调用比较关键的一点就在于由谁调用 ResponseFuture 的 get 方法。同步调用模式下，由框架自身调用 ResponseFuture 的 get 方法。异步调用模式下，则由用户调用该方法。ResponseFuture 是一个接口，下面我们来看一下它的默认实现类 DefaultFuture 的源码。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DefaultFuture</span> <span class=kd>implements</span> <span class=n>ResponseFuture</span> <span class=p>{</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Long</span><span class=p>,</span> <span class=n>Channel</span><span class=o>&gt;</span> <span class=n>CHANNELS</span> <span class=o>=</span> 
        <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>Long</span><span class=p>,</span> <span class=n>Channel</span><span class=o>&gt;</span><span class=p>();</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Long</span><span class=p>,</span> <span class=n>DefaultFuture</span><span class=o>&gt;</span> <span class=n>FUTURES</span> <span class=o>=</span> 
        <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>Long</span><span class=p>,</span> <span class=n>DefaultFuture</span><span class=o>&gt;</span><span class=p>();</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>id</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Channel</span> <span class=n>channel</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Request</span> <span class=n>request</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>timeout</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Lock</span> <span class=n>lock</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ReentrantLock</span><span class=p>();</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Condition</span> <span class=n>done</span> <span class=o>=</span> <span class=n>lock</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span>
    <span class=kd>private</span> <span class=kd>volatile</span> <span class=n>Response</span> <span class=n>response</span><span class=p>;</span>

    <span class=kd>public</span> <span class=nf>DefaultFuture</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>Request</span> <span class=n>request</span><span class=p>,</span> <span class=kt>int</span> <span class=n>timeout</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=na>channel</span> <span class=o>=</span> <span class=n>channel</span><span class=p>;</span>
        <span class=k>this</span><span class=p>.</span><span class=na>request</span> <span class=o>=</span> <span class=n>request</span><span class=p>;</span>

        <span class=c1>// 获取请求 id，这个 id 很重要，后面还会见到</span>
        <span class=k>this</span><span class=p>.</span><span class=na>id</span> <span class=o>=</span> <span class=n>request</span><span class=p>.</span><span class=na>getId</span><span class=p>();</span>
        <span class=k>this</span><span class=p>.</span><span class=na>timeout</span> <span class=o>=</span> <span class=n>timeout</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>?</span> <span class=n>timeout</span> <span class=p>:</span> <span class=n>channel</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getPositiveParameter</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>TIMEOUT_KEY</span><span class=p>,</span> <span class=n>Constants</span><span class=p>.</span><span class=na>DEFAULT_TIMEOUT</span><span class=p>);</span>
        <span class=c1>// 存储 &lt;requestId, DefaultFuture&gt; 映射关系到 FUTURES 中</span>
        <span class=n>FUTURES</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>id</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
        <span class=n>CHANNELS</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>id</span><span class=p>,</span> <span class=n>channel</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>Object</span> <span class=nf>get</span><span class=p>()</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>get</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>Object</span> <span class=nf>get</span><span class=p>(</span><span class=kt>int</span> <span class=n>timeout</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>timeout</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>timeout</span> <span class=o>=</span> <span class=n>Constants</span><span class=p>.</span><span class=na>DEFAULT_TIMEOUT</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=c1>// 检测服务提供方是否成功返回了调用结果</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isDone</span><span class=p>())</span> <span class=p>{</span>
            <span class=kt>long</span> <span class=n>start</span> <span class=o>=</span> <span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span>
            <span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span>
            <span class=k>try</span> <span class=p>{</span>
                <span class=c1>// 循环检测服务提供方是否成功返回了调用结果</span>
                <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>isDone</span><span class=p>())</span> <span class=p>{</span>
                    <span class=c1>// 如果调用结果尚未返回，这里等待一段时间</span>
                    <span class=n>done</span><span class=p>.</span><span class=na>await</span><span class=p>(</span><span class=n>timeout</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>);</span>
                    <span class=c1>// 如果调用结果成功返回，或等待超时，此时跳出 while 循环，执行后续的逻辑</span>
                    <span class=k>if</span> <span class=p>(</span><span class=n>isDone</span><span class=p>()</span> <span class=o>||</span> <span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span> <span class=o>&gt;</span> <span class=n>timeout</span><span class=p>)</span> <span class=p>{</span>
                        <span class=k>break</span><span class=p>;</span>
                    <span class=p>}</span>
                <span class=p>}</span>
            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
            <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
                <span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span>
            <span class=p>}</span>

            <span class=c1>// 如果调用结果仍未返回，则抛出超时异常</span>
            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isDone</span><span class=p>())</span> <span class=p>{</span>
                <span class=k>throw</span> <span class=k>new</span> <span class=n>TimeoutException</span><span class=p>(</span><span class=n>sent</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span> <span class=n>channel</span><span class=p>,</span> <span class=n>getTimeoutMessage</span><span class=p>(</span><span class=kc>false</span><span class=p>));</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=c1>// 返回调用结果</span>
        <span class=k>return</span> <span class=n>returnFromResponse</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isDone</span><span class=p>()</span> <span class=p>{</span>
        <span class=c1>// 通过检测 response 字段为空与否，判断是否收到了调用结果</span>
        <span class=k>return</span> <span class=n>response</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=n>Object</span> <span class=nf>returnFromResponse</span><span class=p>()</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=n>Response</span> <span class=n>res</span> <span class=o>=</span> <span class=n>response</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>res</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;response cannot be null&quot;</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=c1>// 如果调用结果的状态为 Response.OK，则表示调用过程正常，服务提供方成功返回了调用结果</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>res</span><span class=p>.</span><span class=na>getStatus</span><span class=p>()</span> <span class=o>==</span> <span class=n>Response</span><span class=p>.</span><span class=na>OK</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=n>res</span><span class=p>.</span><span class=na>getResult</span><span class=p>();</span>
        <span class=p>}</span>

        <span class=c1>// 抛出异常</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>res</span><span class=p>.</span><span class=na>getStatus</span><span class=p>()</span> <span class=o>==</span> <span class=n>Response</span><span class=p>.</span><span class=na>CLIENT_TIMEOUT</span> <span class=o>||</span> <span class=n>res</span><span class=p>.</span><span class=na>getStatus</span><span class=p>()</span> <span class=o>==</span> <span class=n>Response</span><span class=p>.</span><span class=na>SERVER_TIMEOUT</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>TimeoutException</span><span class=p>(</span><span class=n>res</span><span class=p>.</span><span class=na>getStatus</span><span class=p>()</span> <span class=o>==</span> <span class=n>Response</span><span class=p>.</span><span class=na>SERVER_TIMEOUT</span><span class=p>,</span> <span class=n>channel</span><span class=p>,</span> <span class=n>res</span><span class=p>.</span><span class=na>getErrorMessage</span><span class=p>());</span>
        <span class=p>}</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>RemotingException</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>res</span><span class=p>.</span><span class=na>getErrorMessage</span><span class=p>());</span>
    <span class=p>}</span>

    <span class=c1>// 省略其他方法</span>
<span class=p>}</span>
</code></pre></div> <p>如上，当服务消费者还未接收到调用结果时，用户线程调用 get 方法会被阻塞住。同步调用模式下，框架获得 DefaultFuture 对象后，会立即调用 get 方法进行等待。而异步模式下则是将该对象封装到 FutureAdapter 实例中，并将 FutureAdapter 实例设置到 RpcContext 中，供用户使用。FutureAdapter 是一个适配器，用于将 Dubbo 中的 ResponseFuture 与 JDK 中的 Future 进行适配。这样当用户线程调用 Future 的 get 方法时，经过 FutureAdapter 适配，最终会调用 ResponseFuture 实现类对象的 get 方法，也就是 DefaultFuture 的 get 方法。</p> <p>到这里关于 Dubbo 几种调用方式的代码逻辑就分析完了，下面来分析请求数据的发送与接收，以及响应数据的发送与接收过程。</p> <h3 id=22>2.2 服务消费方发送请求<a class=headerlink href=#22 title="Permanent link">&para;</a></h3> <h4 id=221>2.2.1 发送请求<a class=headerlink href=#221 title="Permanent link">&para;</a></h4> <p>本节我们来看一下同步调用模式下，服务消费方是如何发送调用请求的。在深入分析源码前，我们先来看一张图。</p> <p><img alt src=../sources/images/send-request-thread-stack.jpg></p> <p>这张图展示了服务消费方发送请求过程的部分调用栈，略为复杂。从上图可以看出，经过多次调用后，才将请求数据送至 Netty NioClientSocketChannel。这样做的原因是通过 Exchange 层为框架引入 Request 和 Response 语义，这一点会在接下来的源码分析过程中会看到。其他的就不多说了，下面开始进行分析。首先分析 ReferenceCountExchangeClient 的源码。</p> <div class=highlight><pre><span></span><code><span class=kd>final</span> <span class=kd>class</span> <span class=nc>ReferenceCountExchangeClient</span> <span class=kd>implements</span> <span class=n>ExchangeClient</span> <span class=p>{</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>URL</span> <span class=n>url</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>AtomicInteger</span> <span class=n>referenceCount</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>

    <span class=kd>public</span> <span class=nf>ReferenceCountExchangeClient</span><span class=p>(</span><span class=n>ExchangeClient</span> <span class=n>client</span><span class=p>,</span> <span class=n>ConcurrentMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>LazyConnectExchangeClient</span><span class=o>&gt;</span> <span class=n>ghostClientMap</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=na>client</span> <span class=o>=</span> <span class=n>client</span><span class=p>;</span>
        <span class=c1>// 引用计数自增</span>
        <span class=n>referenceCount</span><span class=p>.</span><span class=na>incrementAndGet</span><span class=p>();</span>
        <span class=k>this</span><span class=p>.</span><span class=na>url</span> <span class=o>=</span> <span class=n>client</span><span class=p>.</span><span class=na>getUrl</span><span class=p>();</span>

        <span class=c1>// ...</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>ResponseFuture</span> <span class=nf>request</span><span class=p>(</span><span class=n>Object</span> <span class=n>request</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=c1>// 直接调用被装饰对象的同签名方法</span>
        <span class=k>return</span> <span class=n>client</span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>ResponseFuture</span> <span class=nf>request</span><span class=p>(</span><span class=n>Object</span> <span class=n>request</span><span class=p>,</span> <span class=kt>int</span> <span class=n>timeout</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=c1>// 直接调用被装饰对象的同签名方法</span>
        <span class=k>return</span> <span class=n>client</span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>timeout</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=cm>/** 引用计数自增，该方法由外部调用 */</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>incrementAndGetCount</span><span class=p>()</span> <span class=p>{</span>
        <span class=c1>// referenceCount 自增</span>
        <span class=n>referenceCount</span><span class=p>.</span><span class=na>incrementAndGet</span><span class=p>();</span>
    <span class=p>}</span>

        <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>close</span><span class=p>(</span><span class=kt>int</span> <span class=n>timeout</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// referenceCount 自减</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>referenceCount</span><span class=p>.</span><span class=na>decrementAndGet</span><span class=p>()</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>timeout</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>client</span><span class=p>.</span><span class=na>close</span><span class=p>();</span>
            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                <span class=n>client</span><span class=p>.</span><span class=na>close</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=n>client</span> <span class=o>=</span> <span class=n>replaceWithLazyClient</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// 省略部分方法</span>
<span class=p>}</span>
</code></pre></div> <p>ReferenceCountExchangeClient 内部定义了一个引用计数变量 referenceCount，每当该对象被引用一次 referenceCount 都会进行自增。每当 close 方法被调用时，referenceCount 进行自减。ReferenceCountExchangeClient 内部仅实现了一个引用计数的功能，其他方法并无复杂逻辑，均是直接调用被装饰对象的相关方法。所以这里就不多说了，继续向下分析，这次是 HeaderExchangeClient。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HeaderExchangeClient</span> <span class=kd>implements</span> <span class=n>ExchangeClient</span> <span class=p>{</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>ScheduledThreadPoolExecutor</span> <span class=n>scheduled</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ScheduledThreadPoolExecutor</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=k>new</span> <span class=n>NamedThreadFactory</span><span class=p>(</span><span class=s>&quot;dubbo-remoting-client-heartbeat&quot;</span><span class=p>,</span> <span class=kc>true</span><span class=p>));</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Client</span> <span class=n>client</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>ExchangeChannel</span> <span class=n>channel</span><span class=p>;</span>
    <span class=kd>private</span> <span class=n>ScheduledFuture</span><span class=o>&lt;?&gt;</span> <span class=n>heartbeatTimer</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>int</span> <span class=n>heartbeat</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kt>int</span> <span class=n>heartbeatTimeout</span><span class=p>;</span>

    <span class=kd>public</span> <span class=nf>HeaderExchangeClient</span><span class=p>(</span><span class=n>Client</span> <span class=n>client</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>needHeartbeat</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>client</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;client == null&quot;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>this</span><span class=p>.</span><span class=na>client</span> <span class=o>=</span> <span class=n>client</span><span class=p>;</span>

        <span class=c1>// 创建 HeaderExchangeChannel 对象</span>
        <span class=k>this</span><span class=p>.</span><span class=na>channel</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HeaderExchangeChannel</span><span class=p>(</span><span class=n>client</span><span class=p>);</span>

        <span class=c1>// 以下代码均与心跳检测逻辑有关</span>
        <span class=n>String</span> <span class=n>dubbo</span> <span class=o>=</span> <span class=n>client</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getParameter</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>DUBBO_VERSION_KEY</span><span class=p>);</span>
        <span class=k>this</span><span class=p>.</span><span class=na>heartbeat</span> <span class=o>=</span> <span class=n>client</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getParameter</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>HEARTBEAT_KEY</span><span class=p>,</span> <span class=n>dubbo</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>dubbo</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&quot;1.0.&quot;</span><span class=p>)</span> <span class=o>?</span> <span class=n>Constants</span><span class=p>.</span><span class=na>DEFAULT_HEARTBEAT</span> <span class=p>:</span> <span class=mi>0</span><span class=p>);</span>
        <span class=k>this</span><span class=p>.</span><span class=na>heartbeatTimeout</span> <span class=o>=</span> <span class=n>client</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getParameter</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>HEARTBEAT_TIMEOUT_KEY</span><span class=p>,</span> <span class=n>heartbeat</span> <span class=o>*</span> <span class=mi>3</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>heartbeatTimeout</span> <span class=o>&lt;</span> <span class=n>heartbeat</span> <span class=o>*</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;heartbeatTimeout &lt; heartbeatInterval * 2&quot;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>needHeartbeat</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 开启心跳检测定时器</span>
            <span class=n>startHeartbeatTimer</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>ResponseFuture</span> <span class=nf>request</span><span class=p>(</span><span class=n>Object</span> <span class=n>request</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=c1>// 直接 HeaderExchangeChannel 对象的同签名方法</span>
        <span class=k>return</span> <span class=n>channel</span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>ResponseFuture</span> <span class=nf>request</span><span class=p>(</span><span class=n>Object</span> <span class=n>request</span><span class=p>,</span> <span class=kt>int</span> <span class=n>timeout</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=c1>// 直接 HeaderExchangeChannel 对象的同签名方法</span>
        <span class=k>return</span> <span class=n>channel</span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>timeout</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>close</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>doClose</span><span class=p>();</span>
        <span class=n>channel</span><span class=p>.</span><span class=na>close</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>doClose</span><span class=p>()</span> <span class=p>{</span>
        <span class=c1>// 停止心跳检测定时器</span>
        <span class=n>stopHeartbeatTimer</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>startHeartbeatTimer</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>stopHeartbeatTimer</span><span class=p>();</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>heartbeat</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>heartbeatTimer</span> <span class=o>=</span> <span class=n>scheduled</span><span class=p>.</span><span class=na>scheduleWithFixedDelay</span><span class=p>(</span>
                    <span class=k>new</span> <span class=n>HeartBeatTask</span><span class=p>(</span><span class=k>new</span> <span class=n>HeartBeatTask</span><span class=p>.</span><span class=na>ChannelProvider</span><span class=p>()</span> <span class=p>{</span>
                        <span class=nd>@Override</span>
                        <span class=kd>public</span> <span class=n>Collection</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;</span> <span class=nf>getChannels</span><span class=p>()</span> <span class=p>{</span>
                            <span class=k>return</span> <span class=n>Collections</span><span class=p>.</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;</span><span class=n>singletonList</span><span class=p>(</span><span class=n>HeaderExchangeClient</span><span class=p>.</span><span class=na>this</span><span class=p>);</span>
                        <span class=p>}</span>
                    <span class=p>},</span> <span class=n>heartbeat</span><span class=p>,</span> <span class=n>heartbeatTimeout</span><span class=p>),</span>
                    <span class=n>heartbeat</span><span class=p>,</span> <span class=n>heartbeat</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>stopHeartbeatTimer</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>heartbeatTimer</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>heartbeatTimer</span><span class=p>.</span><span class=na>isCancelled</span><span class=p>())</span> <span class=p>{</span>
            <span class=k>try</span> <span class=p>{</span>
                <span class=n>heartbeatTimer</span><span class=p>.</span><span class=na>cancel</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
                <span class=n>scheduled</span><span class=p>.</span><span class=na>purge</span><span class=p>();</span>
            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>logger</span><span class=p>.</span><span class=na>isWarnEnabled</span><span class=p>())</span> <span class=p>{</span>
                    <span class=n>logger</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>(),</span> <span class=n>e</span><span class=p>);</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=n>heartbeatTimer</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=c1>// 省略部分方法</span>
<span class=p>}</span>
</code></pre></div> <p>HeaderExchangeClient 中很多方法只有一行代码，即调用 HeaderExchangeChannel 对象的同签名方法。那 HeaderExchangeClient 有什么用处呢？答案是封装了一些关于心跳检测的逻辑。心跳检测并非本文所关注的点，因此就不多说了，继续向下看。</p> <div class=highlight><pre><span></span><code><span class=kd>final</span> <span class=kd>class</span> <span class=nc>HeaderExchangeChannel</span> <span class=kd>implements</span> <span class=n>ExchangeChannel</span> <span class=p>{</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Channel</span> <span class=n>channel</span><span class=p>;</span>

    <span class=n>HeaderExchangeChannel</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>channel</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;channel == null&quot;</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=c1>// 这里的 channel 指向的是 NettyClient</span>
        <span class=k>this</span><span class=p>.</span><span class=na>channel</span> <span class=o>=</span> <span class=n>channel</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>ResponseFuture</span> <span class=nf>request</span><span class=p>(</span><span class=n>Object</span> <span class=n>request</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>request</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>channel</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getPositiveParameter</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>TIMEOUT_KEY</span><span class=p>,</span> <span class=n>Constants</span><span class=p>.</span><span class=na>DEFAULT_TIMEOUT</span><span class=p>));</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>ResponseFuture</span> <span class=nf>request</span><span class=p>(</span><span class=n>Object</span> <span class=n>request</span><span class=p>,</span> <span class=kt>int</span> <span class=n>timeout</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>closed</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>RemotingException</span><span class=p>(...,</span> <span class=err>&quot;</span><span class=n>Failed</span> <span class=n>to</span> <span class=n>send</span> <span class=n>request</span> <span class=p>...);</span>
        <span class=p>}</span>
        <span class=c1>// 创建 Request 对象</span>
        <span class=n>Request</span> <span class=n>req</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Request</span><span class=p>();</span>
        <span class=n>req</span><span class=p>.</span><span class=na>setVersion</span><span class=p>(</span><span class=n>Version</span><span class=p>.</span><span class=na>getProtocolVersion</span><span class=p>());</span>
        <span class=c1>// 设置双向通信标志为 true</span>
        <span class=n>req</span><span class=p>.</span><span class=na>setTwoWay</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
        <span class=c1>// 这里的 request 变量类型为 RpcInvocation</span>
        <span class=n>req</span><span class=p>.</span><span class=na>setData</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>

        <span class=c1>// 创建 DefaultFuture 对象</span>
        <span class=n>DefaultFuture</span> <span class=n>future</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultFuture</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>req</span><span class=p>,</span> <span class=n>timeout</span><span class=p>);</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=c1>// 调用 NettyClient 的 send 方法发送请求</span>
            <span class=n>channel</span><span class=p>.</span><span class=na>send</span><span class=p>(</span><span class=n>req</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>RemotingException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>future</span><span class=p>.</span><span class=na>cancel</span><span class=p>();</span>
            <span class=k>throw</span> <span class=n>e</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=c1>// 返回 DefaultFuture 对象</span>
        <span class=k>return</span> <span class=n>future</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>到这里大家终于看到了 Request 语义了，上面的方法首先定义了一个 Request 对象，然后再将该对象传给 NettyClient 的 send 方法，进行后续的调用。需要说明的是，NettyClient 中并未实现 send 方法，该方法继承自父类 AbstractPeer，下面直接分析 AbstractPeer 的代码。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>AbstractPeer</span> <span class=kd>implements</span> <span class=n>Endpoint</span><span class=p>,</span> <span class=n>ChannelHandler</span> <span class=p>{</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>send</span><span class=p>(</span><span class=n>Object</span> <span class=n>message</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=c1>// 该方法由 AbstractClient 类实现</span>
        <span class=n>send</span><span class=p>(</span><span class=n>message</span><span class=p>,</span> <span class=n>url</span><span class=p>.</span><span class=na>getParameter</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>SENT_KEY</span><span class=p>,</span> <span class=kc>false</span><span class=p>));</span>
    <span class=p>}</span>

    <span class=c1>// 省略其他方法</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>AbstractClient</span> <span class=kd>extends</span> <span class=n>AbstractEndpoint</span> <span class=kd>implements</span> <span class=n>Client</span> <span class=p>{</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>send</span><span class=p>(</span><span class=n>Object</span> <span class=n>message</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>sent</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>send_reconnect</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isConnected</span><span class=p>())</span> <span class=p>{</span>
            <span class=n>connect</span><span class=p>();</span>
        <span class=p>}</span>

        <span class=c1>// 获取 Channel，getChannel 是一个抽象方法，具体由子类实现</span>
        <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>getChannel</span><span class=p>();</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>channel</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>channel</span><span class=p>.</span><span class=na>isConnected</span><span class=p>())</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>RemotingException</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=s>&quot;message can not send ...&quot;</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=c1>// 继续向下调用</span>
        <span class=n>channel</span><span class=p>.</span><span class=na>send</span><span class=p>(</span><span class=n>message</span><span class=p>,</span> <span class=n>sent</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=kd>protected</span> <span class=kd>abstract</span> <span class=n>Channel</span> <span class=nf>getChannel</span><span class=p>();</span>

    <span class=c1>// 省略其他方法</span>
<span class=p>}</span>
</code></pre></div> <p>默认情况下，Dubbo 使用 Netty 作为底层的通信框架，因此下面我们到 NettyClient 类中看一下 getChannel 方法的实现逻辑。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>NettyClient</span> <span class=kd>extends</span> <span class=n>AbstractClient</span> <span class=p>{</span>

    <span class=c1>// 这里的 Channel 全限定名称为 org.jboss.netty.channel.Channel</span>
    <span class=kd>private</span> <span class=kd>volatile</span> <span class=n>Channel</span> <span class=n>channel</span><span class=p>;</span>

    <span class=nd>@Override</span>
    <span class=kd>protected</span> <span class=n>com</span><span class=p>.</span><span class=na>alibaba</span><span class=p>.</span><span class=na>dubbo</span><span class=p>.</span><span class=na>remoting</span><span class=p>.</span><span class=na>Channel</span> <span class=nf>getChannel</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>Channel</span> <span class=n>c</span> <span class=o>=</span> <span class=n>channel</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>c</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>c</span><span class=p>.</span><span class=na>isConnected</span><span class=p>())</span>
            <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
        <span class=c1>// 获取一个 NettyChannel 类型对象</span>
        <span class=k>return</span> <span class=n>NettyChannel</span><span class=p>.</span><span class=na>getOrAddChannel</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>getUrl</span><span class=p>(),</span> <span class=k>this</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kd>final</span> <span class=kd>class</span> <span class=nc>NettyChannel</span> <span class=kd>extends</span> <span class=n>AbstractChannel</span> <span class=p>{</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>ConcurrentMap</span><span class=o>&lt;</span><span class=n>org</span><span class=p>.</span><span class=na>jboss</span><span class=p>.</span><span class=na>netty</span><span class=p>.</span><span class=na>channel</span><span class=p>.</span><span class=na>Channel</span><span class=p>,</span> <span class=n>NettyChannel</span><span class=o>&gt;</span> <span class=n>channelMap</span> <span class=o>=</span> 
        <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>org</span><span class=p>.</span><span class=na>jboss</span><span class=p>.</span><span class=na>netty</span><span class=p>.</span><span class=na>channel</span><span class=p>.</span><span class=na>Channel</span><span class=p>,</span> <span class=n>NettyChannel</span><span class=o>&gt;</span><span class=p>();</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>org</span><span class=p>.</span><span class=na>jboss</span><span class=p>.</span><span class=na>netty</span><span class=p>.</span><span class=na>channel</span><span class=p>.</span><span class=na>Channel</span> <span class=n>channel</span><span class=p>;</span>

    <span class=cm>/** 私有构造方法 */</span>
    <span class=kd>private</span> <span class=nf>NettyChannel</span><span class=p>(</span><span class=n>org</span><span class=p>.</span><span class=na>jboss</span><span class=p>.</span><span class=na>netty</span><span class=p>.</span><span class=na>channel</span><span class=p>.</span><span class=na>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>URL</span> <span class=n>url</span><span class=p>,</span> <span class=n>ChannelHandler</span> <span class=n>handler</span><span class=p>)</span> <span class=p>{</span>
        <span class=kd>super</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>handler</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>channel</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;netty channel == null;&quot;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>this</span><span class=p>.</span><span class=na>channel</span> <span class=o>=</span> <span class=n>channel</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kd>static</span> <span class=n>NettyChannel</span> <span class=nf>getOrAddChannel</span><span class=p>(</span><span class=n>org</span><span class=p>.</span><span class=na>jboss</span><span class=p>.</span><span class=na>netty</span><span class=p>.</span><span class=na>channel</span><span class=p>.</span><span class=na>Channel</span> <span class=n>ch</span><span class=p>,</span> <span class=n>URL</span> <span class=n>url</span><span class=p>,</span> <span class=n>ChannelHandler</span> <span class=n>handler</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>ch</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=c1>// 尝试从集合中获取 NettyChannel 实例</span>
        <span class=n>NettyChannel</span> <span class=n>ret</span> <span class=o>=</span> <span class=n>channelMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>ch</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 如果 ret = null，则创建一个新的 NettyChannel 实例</span>
            <span class=n>NettyChannel</span> <span class=n>nc</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NettyChannel</span><span class=p>(</span><span class=n>ch</span><span class=p>,</span> <span class=n>url</span><span class=p>,</span> <span class=n>handler</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>ch</span><span class=p>.</span><span class=na>isConnected</span><span class=p>())</span> <span class=p>{</span>
                <span class=c1>// 将 &lt;Channel, NettyChannel&gt; 键值对存入 channelMap 集合中</span>
                <span class=n>ret</span> <span class=o>=</span> <span class=n>channelMap</span><span class=p>.</span><span class=na>putIfAbsent</span><span class=p>(</span><span class=n>ch</span><span class=p>,</span> <span class=n>nc</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>ret</span> <span class=o>=</span> <span class=n>nc</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>获取到 NettyChannel 实例后，即可进行后续的调用。下面看一下 NettyChannel 的 send 方法。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kt>void</span> <span class=nf>send</span><span class=p>(</span><span class=n>Object</span> <span class=n>message</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>sent</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
    <span class=kd>super</span><span class=p>.</span><span class=na>send</span><span class=p>(</span><span class=n>message</span><span class=p>,</span> <span class=n>sent</span><span class=p>);</span>

    <span class=kt>boolean</span> <span class=n>success</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>timeout</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=k>try</span> <span class=p>{</span>
        <span class=c1>// 发送消息(包含请求和响应消息)</span>
        <span class=n>ChannelFuture</span> <span class=n>future</span> <span class=o>=</span> <span class=n>channel</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>message</span><span class=p>);</span>

        <span class=c1>// sent 的值源于 &lt;dubbo:method sent=&quot;true/false&quot; /&gt; 中 sent 的配置值，有两种配置值：</span>
        <span class=c1>//   1. true: 等待消息发出，消息发送失败将抛出异常</span>
        <span class=c1>//   2. false: 不等待消息发出，将消息放入 IO 队列，即刻返回</span>
        <span class=c1>// 默认情况下 sent = false；</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>sent</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>timeout</span> <span class=o>=</span> <span class=n>getUrl</span><span class=p>().</span><span class=na>getPositiveParameter</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>TIMEOUT_KEY</span><span class=p>,</span> <span class=n>Constants</span><span class=p>.</span><span class=na>DEFAULT_TIMEOUT</span><span class=p>);</span>
            <span class=c1>// 等待消息发出，若在规定时间没能发出，success 会被置为 false</span>
            <span class=n>success</span> <span class=o>=</span> <span class=n>future</span><span class=p>.</span><span class=na>await</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=n>Throwable</span> <span class=n>cause</span> <span class=o>=</span> <span class=n>future</span><span class=p>.</span><span class=na>getCause</span><span class=p>();</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>cause</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=n>cause</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>RemotingException</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=s>&quot;Failed to send message ...&quot;</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// 若 success 为 false，这里抛出异常</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>success</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>RemotingException</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=s>&quot;Failed to send message ...&quot;</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>经历多次调用，到这里请求数据的发送过程就结束了，过程漫长。为了便于大家阅读代码，这里以 DemoService 为例，将 sayHello 方法的整个调用路径贴出来。</p> <div class=highlight><pre><span></span><code>proxy0#sayHello(String)
  —&gt; InvokerInvocationHandler#invoke(Object, Method, Object[])
    —&gt; MockClusterInvoker#invoke(Invocation)
      —&gt; AbstractClusterInvoker#invoke(Invocation)
        —&gt; FailoverClusterInvoker#doInvoke(Invocation, List&lt;Invoker&lt;T&gt;&gt;, LoadBalance)
          —&gt; Filter#invoke(Invoker, Invocation)  // 包含多个 Filter 调用
            —&gt; ListenerInvokerWrapper#invoke(Invocation) 
              —&gt; AbstractInvoker#invoke(Invocation) 
                —&gt; DubboInvoker#doInvoke(Invocation)
                  —&gt; ReferenceCountExchangeClient#request(Object, int)
                    —&gt; HeaderExchangeClient#request(Object, int)
                      —&gt; HeaderExchangeChannel#request(Object, int)
                        —&gt; AbstractPeer#send(Object)
                          —&gt; AbstractClient#send(Object, boolean)
                            —&gt; NettyChannel#send(Object, boolean)
                              —&gt; NioClientSocketChannel#write(Object)
</code></pre></div> <p>在 Netty 中，出站数据在发出之前还需要进行编码操作，接下来我们来分析一下请求数据的编码逻辑。</p> <h4 id=222>2.2.2 请求编码<a class=headerlink href=#222 title="Permanent link">&para;</a></h4> <p>在分析请求编码逻辑之前，我们先来看一下 Dubbo 数据包结构。</p> <p><img alt src=../sources/images/data-format.jpg></p> <p>Dubbo 数据包分为消息头和消息体，消息头用于存储一些元信息，比如魔数（Magic），数据包类型（Request/Response），消息体长度（Data Length）等。消息体中用于存储具体的调用消息，比如方法名称，参数列表等。下面简单列举一下消息头的内容。</p> <table> <thead> <tr> <th>偏移量(Bit)</th> <th>字段</th> <th>取值</th> </tr> </thead> <tbody> <tr> <td>0 ~ 7</td> <td>魔数高位</td> <td>0xda00</td> </tr> <tr> <td>8 ~ 15</td> <td>魔数低位</td> <td>0xbb</td> </tr> <tr> <td>16</td> <td>数据包类型</td> <td>0 - Response, 1 - Request</td> </tr> <tr> <td>17</td> <td>调用方式</td> <td>仅在第16位被设为1的情况下有效，0 - 单向调用，1 - 双向调用</td> </tr> <tr> <td>18</td> <td>事件标识</td> <td>0 - 当前数据包是请求或响应包，1 - 当前数据包是心跳包</td> </tr> <tr> <td>19 ~ 23</td> <td>序列化器编号</td> <td>2 - Hessian2Serialization<br>3 - JavaSerialization<br>4 - CompactedJavaSerialization<br>6 - FastJsonSerialization<br>7 - NativeJavaSerialization<br>8 - KryoSerialization<br>9 - FstSerialization</td> </tr> <tr> <td>24 ~ 31</td> <td>状态</td> <td>20 - OK<br>30 - CLIENT_TIMEOUT<br>31 - SERVER_TIMEOUT<br>40 - BAD_REQUEST<br>50 - BAD_RESPONSE<br>......</td> </tr> <tr> <td>32 ~ 95</td> <td>请求编号</td> <td>共8字节，运行时生成</td> </tr> <tr> <td>96 ~ 127</td> <td>消息体长度</td> <td>运行时计算</td> </tr> </tbody> </table> <p>了解了 Dubbo 数据包格式，接下来我们就可以探索编码过程了。这次我们开门见山，直接分析编码逻辑所在类。如下：</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ExchangeCodec</span> <span class=kd>extends</span> <span class=n>TelnetCodec</span> <span class=p>{</span>

    <span class=c1>// 消息头长度</span>
    <span class=kd>protected</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>HEADER_LENGTH</span> <span class=o>=</span> <span class=mi>16</span><span class=p>;</span>
    <span class=c1>// 魔数内容</span>
    <span class=kd>protected</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>short</span> <span class=n>MAGIC</span> <span class=o>=</span> <span class=p>(</span><span class=kt>short</span><span class=p>)</span> <span class=mh>0xdabb</span><span class=p>;</span>
    <span class=kd>protected</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>byte</span> <span class=n>MAGIC_HIGH</span> <span class=o>=</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>short2bytes</span><span class=p>(</span><span class=n>MAGIC</span><span class=p>)</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>;</span>
    <span class=kd>protected</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>byte</span> <span class=n>MAGIC_LOW</span> <span class=o>=</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>short2bytes</span><span class=p>(</span><span class=n>MAGIC</span><span class=p>)</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span><span class=p>;</span>
    <span class=kd>protected</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>byte</span> <span class=n>FLAG_REQUEST</span> <span class=o>=</span> <span class=p>(</span><span class=kt>byte</span><span class=p>)</span> <span class=mh>0x80</span><span class=p>;</span>
    <span class=kd>protected</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>byte</span> <span class=n>FLAG_TWOWAY</span> <span class=o>=</span> <span class=p>(</span><span class=kt>byte</span><span class=p>)</span> <span class=mh>0x40</span><span class=p>;</span>
    <span class=kd>protected</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>byte</span> <span class=n>FLAG_EVENT</span> <span class=o>=</span> <span class=p>(</span><span class=kt>byte</span><span class=p>)</span> <span class=mh>0x20</span><span class=p>;</span>
    <span class=kd>protected</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>SERIALIZATION_MASK</span> <span class=o>=</span> <span class=mh>0x1f</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Logger</span> <span class=n>logger</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=p>.</span><span class=na>getLogger</span><span class=p>(</span><span class=n>ExchangeCodec</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>

    <span class=kd>public</span> <span class=n>Short</span> <span class=nf>getMagicCode</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>MAGIC</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>encode</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>ChannelBuffer</span> <span class=n>buffer</span><span class=p>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>msg</span> <span class=k>instanceof</span> <span class=n>Request</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 对 Request 对象进行编码</span>
            <span class=n>encodeRequest</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=p>(</span><span class=n>Request</span><span class=p>)</span> <span class=n>msg</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>msg</span> <span class=k>instanceof</span> <span class=n>Response</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 对 Response 对象进行编码，后面分析</span>
            <span class=n>encodeResponse</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=p>(</span><span class=n>Response</span><span class=p>)</span> <span class=n>msg</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=kd>super</span><span class=p>.</span><span class=na>encode</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=n>msg</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>encodeRequest</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>ChannelBuffer</span> <span class=n>buffer</span><span class=p>,</span> <span class=n>Request</span> <span class=n>req</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
        <span class=n>Serialization</span> <span class=n>serialization</span> <span class=o>=</span> <span class=n>getSerialization</span><span class=p>(</span><span class=n>channel</span><span class=p>);</span>

        <span class=c1>// 创建消息头字节数组，长度为 16</span>
        <span class=kt>byte</span><span class=o>[]</span> <span class=n>header</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=n>HEADER_LENGTH</span><span class=o>]</span><span class=p>;</span>

        <span class=c1>// 设置魔数</span>
        <span class=n>Bytes</span><span class=p>.</span><span class=na>short2bytes</span><span class=p>(</span><span class=n>MAGIC</span><span class=p>,</span> <span class=n>header</span><span class=p>);</span>

        <span class=c1>// 设置数据包类型（Request/Response）和序列化器编号</span>
        <span class=n>header</span><span class=o>[</span><span class=mi>2</span><span class=o>]</span> <span class=o>=</span> <span class=p>(</span><span class=kt>byte</span><span class=p>)</span> <span class=p>(</span><span class=n>FLAG_REQUEST</span> <span class=o>|</span> <span class=n>serialization</span><span class=p>.</span><span class=na>getContentTypeId</span><span class=p>());</span>

        <span class=c1>// 设置通信方式(单向/双向)</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>req</span><span class=p>.</span><span class=na>isTwoWay</span><span class=p>())</span> <span class=p>{</span>
            <span class=n>header</span><span class=o>[</span><span class=mi>2</span><span class=o>]</span> <span class=o>|=</span> <span class=n>FLAG_TWOWAY</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=c1>// 设置事件标识</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>req</span><span class=p>.</span><span class=na>isEvent</span><span class=p>())</span> <span class=p>{</span>
            <span class=n>header</span><span class=o>[</span><span class=mi>2</span><span class=o>]</span> <span class=o>|=</span> <span class=n>FLAG_EVENT</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=c1>// 设置请求编号，8个字节，从第4个字节开始设置</span>
        <span class=n>Bytes</span><span class=p>.</span><span class=na>long2bytes</span><span class=p>(</span><span class=n>req</span><span class=p>.</span><span class=na>getId</span><span class=p>(),</span> <span class=n>header</span><span class=p>,</span> <span class=mi>4</span><span class=p>);</span>

        <span class=c1>// 获取 buffer 当前的写位置</span>
        <span class=kt>int</span> <span class=n>savedWriteIndex</span> <span class=o>=</span> <span class=n>buffer</span><span class=p>.</span><span class=na>writerIndex</span><span class=p>();</span>
        <span class=c1>// 更新 writerIndex，为消息头预留 16 个字节的空间</span>
        <span class=n>buffer</span><span class=p>.</span><span class=na>writerIndex</span><span class=p>(</span><span class=n>savedWriteIndex</span> <span class=o>+</span> <span class=n>HEADER_LENGTH</span><span class=p>);</span>
        <span class=n>ChannelBufferOutputStream</span> <span class=n>bos</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ChannelBufferOutputStream</span><span class=p>(</span><span class=n>buffer</span><span class=p>);</span>
        <span class=c1>// 创建序列化器，比如 Hessian2ObjectOutput</span>
        <span class=n>ObjectOutput</span> <span class=n>out</span> <span class=o>=</span> <span class=n>serialization</span><span class=p>.</span><span class=na>serialize</span><span class=p>(</span><span class=n>channel</span><span class=p>.</span><span class=na>getUrl</span><span class=p>(),</span> <span class=n>bos</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>req</span><span class=p>.</span><span class=na>isEvent</span><span class=p>())</span> <span class=p>{</span>
            <span class=c1>// 对事件数据进行序列化操作</span>
            <span class=n>encodeEventData</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>out</span><span class=p>,</span> <span class=n>req</span><span class=p>.</span><span class=na>getData</span><span class=p>());</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=c1>// 对请求数据进行序列化操作</span>
            <span class=n>encodeRequestData</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>out</span><span class=p>,</span> <span class=n>req</span><span class=p>.</span><span class=na>getData</span><span class=p>(),</span> <span class=n>req</span><span class=p>.</span><span class=na>getVersion</span><span class=p>());</span>
        <span class=p>}</span>
        <span class=n>out</span><span class=p>.</span><span class=na>flushBuffer</span><span class=p>();</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>out</span> <span class=k>instanceof</span> <span class=n>Cleanable</span><span class=p>)</span> <span class=p>{</span>
            <span class=p>((</span><span class=n>Cleanable</span><span class=p>)</span> <span class=n>out</span><span class=p>).</span><span class=na>cleanup</span><span class=p>();</span>
        <span class=p>}</span>
        <span class=n>bos</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span>
        <span class=n>bos</span><span class=p>.</span><span class=na>close</span><span class=p>();</span>

        <span class=c1>// 获取写入的字节数，也就是消息体长度</span>
        <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=n>bos</span><span class=p>.</span><span class=na>writtenBytes</span><span class=p>();</span>
        <span class=n>checkPayload</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>

        <span class=c1>// 将消息体长度写入到消息头中</span>
        <span class=n>Bytes</span><span class=p>.</span><span class=na>int2bytes</span><span class=p>(</span><span class=n>len</span><span class=p>,</span> <span class=n>header</span><span class=p>,</span> <span class=mi>12</span><span class=p>);</span>

        <span class=c1>// 将 buffer 指针移动到 savedWriteIndex，为写消息头做准备</span>
        <span class=n>buffer</span><span class=p>.</span><span class=na>writerIndex</span><span class=p>(</span><span class=n>savedWriteIndex</span><span class=p>);</span>
        <span class=c1>// 从 savedWriteIndex 下标处写入消息头</span>
        <span class=n>buffer</span><span class=p>.</span><span class=na>writeBytes</span><span class=p>(</span><span class=n>header</span><span class=p>);</span>
        <span class=c1>// 设置新的 writerIndex，writerIndex = 原写下标 + 消息头长度 + 消息体长度</span>
        <span class=n>buffer</span><span class=p>.</span><span class=na>writerIndex</span><span class=p>(</span><span class=n>savedWriteIndex</span> <span class=o>+</span> <span class=n>HEADER_LENGTH</span> <span class=o>+</span> <span class=n>len</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// 省略其他方法</span>
<span class=p>}</span>
</code></pre></div> <p>以上就是请求对象的编码过程，该过程首先会通过位运算将消息头写入到 header 数组中。然后对 Request 对象的 data 字段执行序列化操作，序列化后的数据最终会存储到 ChannelBuffer 中。序列化操作执行完后，可得到数据序列化后的长度 len，紧接着将 len 写入到 header 指定位置处。最后再将消息头字节数组 header 写入到 ChannelBuffer 中，整个编码过程就结束了。本节的最后，我们再来看一下 Request 对象的 data 字段序列化过程，也就是 encodeRequestData 方法的逻辑，如下：</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DubboCodec</span> <span class=kd>extends</span> <span class=n>ExchangeCodec</span> <span class=kd>implements</span> <span class=n>Codec2</span> <span class=p>{</span>

    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>encodeRequestData</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>ObjectOutput</span> <span class=n>out</span><span class=p>,</span> <span class=n>Object</span> <span class=n>data</span><span class=p>,</span> <span class=n>String</span> <span class=n>version</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
        <span class=n>RpcInvocation</span> <span class=n>inv</span> <span class=o>=</span> <span class=p>(</span><span class=n>RpcInvocation</span><span class=p>)</span> <span class=n>data</span><span class=p>;</span>

        <span class=c1>// 依次序列化 dubbo version、path、version</span>
        <span class=n>out</span><span class=p>.</span><span class=na>writeUTF</span><span class=p>(</span><span class=n>version</span><span class=p>);</span>
        <span class=n>out</span><span class=p>.</span><span class=na>writeUTF</span><span class=p>(</span><span class=n>inv</span><span class=p>.</span><span class=na>getAttachment</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>PATH_KEY</span><span class=p>));</span>
        <span class=n>out</span><span class=p>.</span><span class=na>writeUTF</span><span class=p>(</span><span class=n>inv</span><span class=p>.</span><span class=na>getAttachment</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>VERSION_KEY</span><span class=p>));</span>

        <span class=c1>// 序列化调用方法名</span>
        <span class=n>out</span><span class=p>.</span><span class=na>writeUTF</span><span class=p>(</span><span class=n>inv</span><span class=p>.</span><span class=na>getMethodName</span><span class=p>());</span>
        <span class=c1>// 将参数类型转换为字符串，并进行序列化</span>
        <span class=n>out</span><span class=p>.</span><span class=na>writeUTF</span><span class=p>(</span><span class=n>ReflectUtils</span><span class=p>.</span><span class=na>getDesc</span><span class=p>(</span><span class=n>inv</span><span class=p>.</span><span class=na>getParameterTypes</span><span class=p>()));</span>
        <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span> <span class=o>=</span> <span class=n>inv</span><span class=p>.</span><span class=na>getArguments</span><span class=p>();</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>args</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span>
            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>args</span><span class=p>.</span><span class=na>length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 对运行时参数进行序列化</span>
                <span class=n>out</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>encodeInvocationArgument</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>inv</span><span class=p>,</span> <span class=n>i</span><span class=p>));</span>
            <span class=p>}</span>

        <span class=c1>// 序列化 attachments</span>
        <span class=n>out</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>inv</span><span class=p>.</span><span class=na>getAttachments</span><span class=p>());</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>至此，关于服务消费方发送请求的过程就分析完了，接下来我们来看一下服务提供方是如何接收请求的。</p> <h3 id=23>2.3 服务提供方接收请求<a class=headerlink href=#23 title="Permanent link">&para;</a></h3> <p>前面说过，默认情况下 Dubbo 使用 Netty 作为底层的通信框架。Netty 检测到有数据入站后，首先会通过解码器对数据进行解码，并将解码后的数据传递给下一个入站处理器的指定方法。所以在进行后续的分析之前，我们先来看一下数据解码过程。</p> <h4 id=231>2.3.1 请求解码<a class=headerlink href=#231 title="Permanent link">&para;</a></h4> <p>这里直接分析请求数据的解码逻辑，忽略中间过程，如下：</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ExchangeCodec</span> <span class=kd>extends</span> <span class=n>TelnetCodec</span> <span class=p>{</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>Object</span> <span class=nf>decode</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>ChannelBuffer</span> <span class=n>buffer</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
        <span class=kt>int</span> <span class=n>readable</span> <span class=o>=</span> <span class=n>buffer</span><span class=p>.</span><span class=na>readableBytes</span><span class=p>();</span>
        <span class=c1>// 创建消息头字节数组</span>
        <span class=kt>byte</span><span class=o>[]</span> <span class=n>header</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>readable</span><span class=p>,</span> <span class=n>HEADER_LENGTH</span><span class=p>)</span><span class=o>]</span><span class=p>;</span>
        <span class=c1>// 读取消息头数据</span>
        <span class=n>buffer</span><span class=p>.</span><span class=na>readBytes</span><span class=p>(</span><span class=n>header</span><span class=p>);</span>
        <span class=c1>// 调用重载方法进行后续解码工作</span>
        <span class=k>return</span> <span class=n>decode</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=n>readable</span><span class=p>,</span> <span class=n>header</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>protected</span> <span class=n>Object</span> <span class=nf>decode</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>ChannelBuffer</span> <span class=n>buffer</span><span class=p>,</span> <span class=kt>int</span> <span class=n>readable</span><span class=p>,</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>header</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
        <span class=c1>// 检查魔数是否相等</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>readable</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>header</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span> <span class=o>!=</span> <span class=n>MAGIC_HIGH</span>
                <span class=o>||</span> <span class=n>readable</span> <span class=o>&gt;</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=n>header</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span> <span class=o>!=</span> <span class=n>MAGIC_LOW</span><span class=p>)</span> <span class=p>{</span>
            <span class=kt>int</span> <span class=n>length</span> <span class=o>=</span> <span class=n>header</span><span class=p>.</span><span class=na>length</span><span class=p>;</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>header</span><span class=p>.</span><span class=na>length</span> <span class=o>&lt;</span> <span class=n>readable</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>header</span> <span class=o>=</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>copyOf</span><span class=p>(</span><span class=n>header</span><span class=p>,</span> <span class=n>readable</span><span class=p>);</span>
                <span class=n>buffer</span><span class=p>.</span><span class=na>readBytes</span><span class=p>(</span><span class=n>header</span><span class=p>,</span> <span class=n>length</span><span class=p>,</span> <span class=n>readable</span> <span class=o>-</span> <span class=n>length</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>header</span><span class=p>.</span><span class=na>length</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>header</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>==</span> <span class=n>MAGIC_HIGH</span> <span class=o>&amp;&amp;</span> <span class=n>header</span><span class=o>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=o>]</span> <span class=o>==</span> <span class=n>MAGIC_LOW</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>buffer</span><span class=p>.</span><span class=na>readerIndex</span><span class=p>(</span><span class=n>buffer</span><span class=p>.</span><span class=na>readerIndex</span><span class=p>()</span> <span class=o>-</span> <span class=n>header</span><span class=p>.</span><span class=na>length</span> <span class=o>+</span> <span class=n>i</span><span class=p>);</span>
                    <span class=n>header</span> <span class=o>=</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>copyOf</span><span class=p>(</span><span class=n>header</span><span class=p>,</span> <span class=n>i</span><span class=p>);</span>
                    <span class=k>break</span><span class=p>;</span>
                <span class=p>}</span>
            <span class=p>}</span>
            <span class=c1>// 通过 telnet 命令行发送的数据包不包含消息头，所以这里</span>
            <span class=c1>// 调用 TelnetCodec 的 decode 方法对数据包进行解码</span>
            <span class=k>return</span> <span class=kd>super</span><span class=p>.</span><span class=na>decode</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=n>readable</span><span class=p>,</span> <span class=n>header</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=c1>// 检测可读数据量是否少于消息头长度，若小于则立即返回 DecodeResult.NEED_MORE_INPUT</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>readable</span> <span class=o>&lt;</span> <span class=n>HEADER_LENGTH</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=n>DecodeResult</span><span class=p>.</span><span class=na>NEED_MORE_INPUT</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=c1>// 从消息头中获取消息体长度</span>
        <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>bytes2int</span><span class=p>(</span><span class=n>header</span><span class=p>,</span> <span class=mi>12</span><span class=p>);</span>
        <span class=c1>// 检测消息体长度是否超出限制，超出则抛出异常</span>
        <span class=n>checkPayload</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>

        <span class=kt>int</span> <span class=n>tt</span> <span class=o>=</span> <span class=n>len</span> <span class=o>+</span> <span class=n>HEADER_LENGTH</span><span class=p>;</span>
        <span class=c1>// 检测可读的字节数是否小于实际的字节数</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>readable</span> <span class=o>&lt;</span> <span class=n>tt</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=n>DecodeResult</span><span class=p>.</span><span class=na>NEED_MORE_INPUT</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=n>ChannelBufferInputStream</span> <span class=n>is</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ChannelBufferInputStream</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>

        <span class=k>try</span> <span class=p>{</span>
            <span class=c1>// 继续进行解码工作</span>
            <span class=k>return</span> <span class=n>decodeBody</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>is</span><span class=p>,</span> <span class=n>header</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>is</span><span class=p>.</span><span class=na>available</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>try</span> <span class=p>{</span>
                    <span class=n>StreamUtils</span><span class=p>.</span><span class=na>skipUnusedStream</span><span class=p>(</span><span class=n>is</span><span class=p>);</span>
                <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>logger</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>(),</span> <span class=n>e</span><span class=p>);</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>上面方法通过检测消息头中的魔数是否与规定的魔数相等，提前拦截掉非常规数据包，比如通过 telnet 命令行发出的数据包。接着再对消息体长度，以及可读字节数进行检测。最后调用 decodeBody 方法进行后续的解码工作，ExchangeCodec 中实现了 decodeBody 方法，但因其子类 DubboCodec 覆写了该方法，所以在运行时 DubboCodec 中的 decodeBody 方法会被调用。下面我们来看一下该方法的代码。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DubboCodec</span> <span class=kd>extends</span> <span class=n>ExchangeCodec</span> <span class=kd>implements</span> <span class=n>Codec2</span> <span class=p>{</span>

    <span class=nd>@Override</span>
    <span class=kd>protected</span> <span class=n>Object</span> <span class=nf>decodeBody</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>InputStream</span> <span class=n>is</span><span class=p>,</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>header</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
        <span class=c1>// 获取消息头中的第三个字节，并通过逻辑与运算得到序列化器编号</span>
        <span class=kt>byte</span> <span class=n>flag</span> <span class=o>=</span> <span class=n>header</span><span class=o>[</span><span class=mi>2</span><span class=o>]</span><span class=p>,</span> <span class=n>proto</span> <span class=o>=</span> <span class=p>(</span><span class=kt>byte</span><span class=p>)</span> <span class=p>(</span><span class=n>flag</span> <span class=o>&amp;</span> <span class=n>SERIALIZATION_MASK</span><span class=p>);</span>
        <span class=n>Serialization</span> <span class=n>s</span> <span class=o>=</span> <span class=n>CodecSupport</span><span class=p>.</span><span class=na>getSerialization</span><span class=p>(</span><span class=n>channel</span><span class=p>.</span><span class=na>getUrl</span><span class=p>(),</span> <span class=n>proto</span><span class=p>);</span>
        <span class=c1>// 获取调用编号</span>
        <span class=kt>long</span> <span class=n>id</span> <span class=o>=</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>bytes2long</span><span class=p>(</span><span class=n>header</span><span class=p>,</span> <span class=mi>4</span><span class=p>);</span>
        <span class=c1>// 通过逻辑与运算得到调用类型，0 - Response，1 - Request</span>
        <span class=k>if</span> <span class=p>((</span><span class=n>flag</span> <span class=o>&amp;</span> <span class=n>FLAG_REQUEST</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 对响应结果进行解码，得到 Response 对象。这个非本节内容，后面再分析</span>
            <span class=c1>// ...</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=c1>// 创建 Request 对象</span>
            <span class=n>Request</span> <span class=n>req</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Request</span><span class=p>(</span><span class=n>id</span><span class=p>);</span>
            <span class=n>req</span><span class=p>.</span><span class=na>setVersion</span><span class=p>(</span><span class=n>Version</span><span class=p>.</span><span class=na>getProtocolVersion</span><span class=p>());</span>
            <span class=c1>// 通过逻辑与运算得到通信方式，并设置到 Request 对象中</span>
            <span class=n>req</span><span class=p>.</span><span class=na>setTwoWay</span><span class=p>((</span><span class=n>flag</span> <span class=o>&amp;</span> <span class=n>FLAG_TWOWAY</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>);</span>

            <span class=c1>// 通过位运算检测数据包是否为事件类型</span>
            <span class=k>if</span> <span class=p>((</span><span class=n>flag</span> <span class=o>&amp;</span> <span class=n>FLAG_EVENT</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 设置心跳事件到 Request 对象中</span>
                <span class=n>req</span><span class=p>.</span><span class=na>setEvent</span><span class=p>(</span><span class=n>Request</span><span class=p>.</span><span class=na>HEARTBEAT_EVENT</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=k>try</span> <span class=p>{</span>
                <span class=n>Object</span> <span class=n>data</span><span class=p>;</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>req</span><span class=p>.</span><span class=na>isHeartbeat</span><span class=p>())</span> <span class=p>{</span>
                    <span class=c1>// 对心跳包进行解码，该方法已被标注为废弃</span>
                    <span class=n>data</span> <span class=o>=</span> <span class=n>decodeHeartbeatData</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>deserialize</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>channel</span><span class=p>.</span><span class=na>getUrl</span><span class=p>(),</span> <span class=n>is</span><span class=p>));</span>
                <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>req</span><span class=p>.</span><span class=na>isEvent</span><span class=p>())</span> <span class=p>{</span>
                    <span class=c1>// 对事件数据进行解码</span>
                    <span class=n>data</span> <span class=o>=</span> <span class=n>decodeEventData</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>deserialize</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>channel</span><span class=p>.</span><span class=na>getUrl</span><span class=p>(),</span> <span class=n>is</span><span class=p>));</span>
                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                    <span class=n>DecodeableRpcInvocation</span> <span class=n>inv</span><span class=p>;</span>
                    <span class=c1>// 根据 url 参数判断是否在 IO 线程上对消息体进行解码</span>
                    <span class=k>if</span> <span class=p>(</span><span class=n>channel</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getParameter</span><span class=p>(</span>
                            <span class=n>Constants</span><span class=p>.</span><span class=na>DECODE_IN_IO_THREAD_KEY</span><span class=p>,</span>
                            <span class=n>Constants</span><span class=p>.</span><span class=na>DEFAULT_DECODE_IN_IO_THREAD</span><span class=p>))</span> <span class=p>{</span>
                        <span class=n>inv</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DecodeableRpcInvocation</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>req</span><span class=p>,</span> <span class=n>is</span><span class=p>,</span> <span class=n>proto</span><span class=p>);</span>
                        <span class=c1>// 在当前线程，也就是 IO 线程上进行后续的解码工作。此工作完成后，可将</span>
                        <span class=c1>// 调用方法名、attachment、以及调用参数解析出来</span>
                        <span class=n>inv</span><span class=p>.</span><span class=na>decode</span><span class=p>();</span>
                    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                        <span class=c1>// 仅创建 DecodeableRpcInvocation 对象，但不在当前线程上执行解码逻辑</span>
                        <span class=n>inv</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DecodeableRpcInvocation</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>req</span><span class=p>,</span>
                                <span class=k>new</span> <span class=n>UnsafeByteArrayInputStream</span><span class=p>(</span><span class=n>readMessageData</span><span class=p>(</span><span class=n>is</span><span class=p>)),</span> <span class=n>proto</span><span class=p>);</span>
                    <span class=p>}</span>
                    <span class=n>data</span> <span class=o>=</span> <span class=n>inv</span><span class=p>;</span>
                <span class=p>}</span>

                <span class=c1>// 设置 data 到 Request 对象中</span>
                <span class=n>req</span><span class=p>.</span><span class=na>setData</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 若解码过程中出现异常，则将 broken 字段设为 true，</span>
                <span class=c1>// 并将异常对象设置到 Reqeust 对象中</span>
                <span class=n>req</span><span class=p>.</span><span class=na>setBroken</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
                <span class=n>req</span><span class=p>.</span><span class=na>setData</span><span class=p>(</span><span class=n>t</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=k>return</span> <span class=n>req</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>如上，decodeBody 对部分字段进行了解码，并将解码得到的字段封装到 Request 中。随后会调用 DecodeableRpcInvocation 的 decode 方法进行后续的解码工作。此工作完成后，可将调用方法名、attachment、以及调用参数解析出来。下面我们来看一下 DecodeableRpcInvocation 的 decode 方法逻辑。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DecodeableRpcInvocation</span> <span class=kd>extends</span> <span class=n>RpcInvocation</span> <span class=kd>implements</span> <span class=n>Codec</span><span class=p>,</span> <span class=n>Decodeable</span> <span class=p>{</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>Object</span> <span class=nf>decode</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>InputStream</span> <span class=n>input</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
        <span class=n>ObjectInput</span> <span class=n>in</span> <span class=o>=</span> <span class=n>CodecSupport</span><span class=p>.</span><span class=na>getSerialization</span><span class=p>(</span><span class=n>channel</span><span class=p>.</span><span class=na>getUrl</span><span class=p>(),</span> <span class=n>serializationType</span><span class=p>)</span>
                <span class=p>.</span><span class=na>deserialize</span><span class=p>(</span><span class=n>channel</span><span class=p>.</span><span class=na>getUrl</span><span class=p>(),</span> <span class=n>input</span><span class=p>);</span>

        <span class=c1>// 通过反序列化得到 dubbo version，并保存到 attachments 变量中</span>
        <span class=n>String</span> <span class=n>dubboVersion</span> <span class=o>=</span> <span class=n>in</span><span class=p>.</span><span class=na>readUTF</span><span class=p>();</span>
        <span class=n>request</span><span class=p>.</span><span class=na>setVersion</span><span class=p>(</span><span class=n>dubboVersion</span><span class=p>);</span>
        <span class=n>setAttachment</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>DUBBO_VERSION_KEY</span><span class=p>,</span> <span class=n>dubboVersion</span><span class=p>);</span>

        <span class=c1>// 通过反序列化得到 path，version，并保存到 attachments 变量中</span>
        <span class=n>setAttachment</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>PATH_KEY</span><span class=p>,</span> <span class=n>in</span><span class=p>.</span><span class=na>readUTF</span><span class=p>());</span>
        <span class=n>setAttachment</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>VERSION_KEY</span><span class=p>,</span> <span class=n>in</span><span class=p>.</span><span class=na>readUTF</span><span class=p>());</span>

        <span class=c1>// 通过反序列化得到调用方法名</span>
        <span class=n>setMethodName</span><span class=p>(</span><span class=n>in</span><span class=p>.</span><span class=na>readUTF</span><span class=p>());</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=p>;</span>
            <span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=n>pts</span><span class=p>;</span>
            <span class=c1>// 通过反序列化得到参数类型字符串，比如 Ljava/lang/String;</span>
            <span class=n>String</span> <span class=n>desc</span> <span class=o>=</span> <span class=n>in</span><span class=p>.</span><span class=na>readUTF</span><span class=p>();</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>desc</span><span class=p>.</span><span class=na>length</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>pts</span> <span class=o>=</span> <span class=n>DubboCodec</span><span class=p>.</span><span class=na>EMPTY_CLASS_ARRAY</span><span class=p>;</span>
                <span class=n>args</span> <span class=o>=</span> <span class=n>DubboCodec</span><span class=p>.</span><span class=na>EMPTY_OBJECT_ARRAY</span><span class=p>;</span>
            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                <span class=c1>// 将 desc 解析为参数类型数组</span>
                <span class=n>pts</span> <span class=o>=</span> <span class=n>ReflectUtils</span><span class=p>.</span><span class=na>desc2classArray</span><span class=p>(</span><span class=n>desc</span><span class=p>);</span>
                <span class=n>args</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Object</span><span class=o>[</span><span class=n>pts</span><span class=p>.</span><span class=na>length</span><span class=o>]</span><span class=p>;</span>
                <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>args</span><span class=p>.</span><span class=na>length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                    <span class=k>try</span> <span class=p>{</span>
                        <span class=c1>// 解析运行时参数</span>
                        <span class=n>args</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>in</span><span class=p>.</span><span class=na>readObject</span><span class=p>(</span><span class=n>pts</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>);</span>
                    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                        <span class=k>if</span> <span class=p>(</span><span class=n>log</span><span class=p>.</span><span class=na>isWarnEnabled</span><span class=p>())</span> <span class=p>{</span>
                            <span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Decode argument failed: &quot;</span> <span class=o>+</span> <span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>(),</span> <span class=n>e</span><span class=p>);</span>
                        <span class=p>}</span>
                    <span class=p>}</span>
                <span class=p>}</span>
            <span class=p>}</span>

            <span class=c1>// 设置参数类型数组</span>
            <span class=n>setParameterTypes</span><span class=p>(</span><span class=n>pts</span><span class=p>);</span>

            <span class=c1>// 通过反序列化得到原 attachment 的内容</span>
            <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>map</span> <span class=o>=</span> <span class=p>(</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>String</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>in</span><span class=p>.</span><span class=na>readObject</span><span class=p>(</span><span class=n>Map</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>map</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>map</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>attachment</span> <span class=o>=</span> <span class=n>getAttachments</span><span class=p>();</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>attachment</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>attachment</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>String</span><span class=o>&gt;</span><span class=p>();</span>
                <span class=p>}</span>
                <span class=c1>// 将 map 与当前对象中的 attachment 集合进行融合</span>
                <span class=n>attachment</span><span class=p>.</span><span class=na>putAll</span><span class=p>(</span><span class=n>map</span><span class=p>);</span>
                <span class=n>setAttachments</span><span class=p>(</span><span class=n>attachment</span><span class=p>);</span>
            <span class=p>}</span>

            <span class=c1>// 对 callback 类型的参数进行处理</span>
            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>args</span><span class=p>.</span><span class=na>length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>args</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>decodeInvocationArgument</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=k>this</span><span class=p>,</span> <span class=n>pts</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>args</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>);</span>
            <span class=p>}</span>

            <span class=c1>// 设置参数列表</span>
            <span class=n>setArguments</span><span class=p>(</span><span class=n>args</span><span class=p>);</span>

        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>ClassNotFoundException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>IOException</span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>toString</span><span class=p>(</span><span class=s>&quot;Read invocation data failed.&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>));</span>
        <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>in</span> <span class=k>instanceof</span> <span class=n>Cleanable</span><span class=p>)</span> <span class=p>{</span>
                <span class=p>((</span><span class=n>Cleanable</span><span class=p>)</span> <span class=n>in</span><span class=p>).</span><span class=na>cleanup</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>上面的方法通过反序列化将诸如 path、version、调用方法名、参数列表等信息依次解析出来，并设置到相应的字段中，最终得到一个具有完整调用信息的 DecodeableRpcInvocation 对象。</p> <p>到这里，请求数据解码的过程就分析完了。此时我们得到了一个 Request 对象，这个对象会被传送到下一个入站处理器中，我们继续往下看。</p> <h4 id=232>2.3.2 调用服务<a class=headerlink href=#232 title="Permanent link">&para;</a></h4> <p>解码器将数据包解析成 Request 对象后，NettyHandler 的 messageReceived 方法紧接着会收到这个对象，并将这个对象继续向下传递。这期间该对象会被依次传递给 NettyServer、MultiMessageHandler、HeartbeatHandler 以及 AllChannelHandler。最后由 AllChannelHandler 将该对象封装到 Runnable 实现类对象中，并将 Runnable 放入线程池中执行后续的调用逻辑。整个调用栈如下：</p> <div class=highlight><pre><span></span><code>NettyHandler#messageReceived(ChannelHandlerContext, MessageEvent)
  —&gt; AbstractPeer#received(Channel, Object)
    —&gt; MultiMessageHandler#received(Channel, Object)
      —&gt; HeartbeatHandler#received(Channel, Object)
        —&gt; AllChannelHandler#received(Channel, Object)
          —&gt; ExecutorService#execute(Runnable)    // 由线程池执行后续的调用逻辑
</code></pre></div> <p>考虑到篇幅，以及很多中间调用的逻辑并非十分重要，所以这里就不对调用栈中的每个方法都进行分析了。这里我们直接分析调用栈中的分析第一个和最后一个调用方法逻辑。如下：</p> <div class=highlight><pre><span></span><code><span class=nd>@Sharable</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>NettyHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelHandler</span> <span class=p>{</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Channel</span><span class=o>&gt;</span> <span class=n>channels</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Channel</span><span class=o>&gt;</span><span class=p>();</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>URL</span> <span class=n>url</span><span class=p>;</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>ChannelHandler</span> <span class=n>handler</span><span class=p>;</span>

    <span class=kd>public</span> <span class=nf>NettyHandler</span><span class=p>(</span><span class=n>URL</span> <span class=n>url</span><span class=p>,</span> <span class=n>ChannelHandler</span> <span class=n>handler</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>url</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;url == null&quot;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>handler</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;handler == null&quot;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>this</span><span class=p>.</span><span class=na>url</span> <span class=o>=</span> <span class=n>url</span><span class=p>;</span>

        <span class=c1>// 这里的 handler 类型为 NettyServer</span>
        <span class=k>this</span><span class=p>.</span><span class=na>handler</span> <span class=o>=</span> <span class=n>handler</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>messageReceived</span><span class=p>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=p>,</span> <span class=n>MessageEvent</span> <span class=n>e</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=p>{</span>
        <span class=c1>// 获取 NettyChannel</span>
        <span class=n>NettyChannel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>NettyChannel</span><span class=p>.</span><span class=na>getOrAddChannel</span><span class=p>(</span><span class=n>ctx</span><span class=p>.</span><span class=na>getChannel</span><span class=p>(),</span> <span class=n>url</span><span class=p>,</span> <span class=n>handler</span><span class=p>);</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=c1>// 继续向下调用</span>
            <span class=n>handler</span><span class=p>.</span><span class=na>received</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span>
        <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
            <span class=n>NettyChannel</span><span class=p>.</span><span class=na>removeChannelIfDisconnected</span><span class=p>(</span><span class=n>ctx</span><span class=p>.</span><span class=na>getChannel</span><span class=p>());</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>如上，NettyHandler 中的 messageReceived 逻辑比较简单。首先根据一些信息获取 NettyChannel 实例，然后将 NettyChannel 实例以及 Request 对象向下传递。下面再来看看 AllChannelHandler 的逻辑，在详细分析代码之前，我们先来了解一下 Dubbo 中的线程派发模型。</p> <h5 id=2321>2.3.2.1 线程派发模型<a class=headerlink href=#2321 title="Permanent link">&para;</a></h5> <p>Dubbo 将底层通信框架中接收请求的线程称为 IO 线程。如果一些事件处理逻辑可以很快执行完，比如只在内存打一个标记，此时直接在 IO 线程上执行该段逻辑即可。但如果事件的处理逻辑比较耗时，比如该段逻辑会发起数据库查询或者 HTTP 请求。此时我们就不应该让事件处理逻辑在 IO 线程上执行，而是应该派发到线程池中去执行。原因也很简单，IO 线程主要用于接收请求，如果 IO 线程被占满，将导致它不能接收新的请求。</p> <p>以上就是线程派发的背景，下面我们再来通过 Dubbo 调用图，看一下线程派发器所处的位置。</p> <p><img alt src=../sources/images/dispatcher-location.jpg></p> <p>如上图，红框中的 Dispatcher 就是线程派发器。需要说明的是，Dispatcher 真实的职责创建具有线程派发能力的 ChannelHandler，比如 AllChannelHandler、MessageOnlyChannelHandler 和 ExecutionChannelHandler 等，其本身并不具备线程派发能力。Dubbo 支持 5 种不同的线程派发策略，下面通过一个表格列举一下。</p> <table> <thead> <tr> <th>策略</th> <th>用途</th> </tr> </thead> <tbody> <tr> <td>all</td> <td>所有消息都派发到线程池，包括请求，响应，连接事件，断开事件等</td> </tr> <tr> <td>direct</td> <td>所有消息都不派发到线程池，全部在 IO 线程上直接执行</td> </tr> <tr> <td>message</td> <td>只有**请求**和**响应**消息派发到线程池，其它消息均在 IO 线程上执行</td> </tr> <tr> <td>execution</td> <td>只有**请求**消息派发到线程池，不含响应。其它消息均在 IO 线程上执行</td> </tr> <tr> <td>connection</td> <td>在 IO 线程上，将连接断开事件放入队列，有序逐个执行，其它消息派发到线程池</td> </tr> </tbody> </table> <p>默认配置下，Dubbo 使用 <code>all</code> 派发策略，即将所有的消息都派发到线程池中。下面我们来分析一下 AllChannelHandler 的代码。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>AllChannelHandler</span> <span class=kd>extends</span> <span class=n>WrappedChannelHandler</span> <span class=p>{</span>

    <span class=kd>public</span> <span class=nf>AllChannelHandler</span><span class=p>(</span><span class=n>ChannelHandler</span> <span class=n>handler</span><span class=p>,</span> <span class=n>URL</span> <span class=n>url</span><span class=p>)</span> <span class=p>{</span>
        <span class=kd>super</span><span class=p>(</span><span class=n>handler</span><span class=p>,</span> <span class=n>url</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=cm>/** 处理连接事件 */</span>
    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>connected</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=c1>// 获取线程池</span>
        <span class=n>ExecutorService</span> <span class=n>cexecutor</span> <span class=o>=</span> <span class=n>getExecutorService</span><span class=p>();</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=c1>// 将连接事件派发到线程池中处理</span>
            <span class=n>cexecutor</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=k>new</span> <span class=n>ChannelEventRunnable</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>handler</span><span class=p>,</span> <span class=n>ChannelState</span><span class=p>.</span><span class=na>CONNECTED</span><span class=p>));</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>ExecutionException</span><span class=p>(...,</span> <span class=s>&quot; error when process connected event .&quot;</span><span class=p>,</span> <span class=n>t</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=cm>/** 处理断开事件 */</span>
    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>disconnected</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=n>ExecutorService</span> <span class=n>cexecutor</span> <span class=o>=</span> <span class=n>getExecutorService</span><span class=p>();</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=n>cexecutor</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=k>new</span> <span class=n>ChannelEventRunnable</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>handler</span><span class=p>,</span> <span class=n>ChannelState</span><span class=p>.</span><span class=na>DISCONNECTED</span><span class=p>));</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>ExecutionException</span><span class=p>(...,</span> <span class=s>&quot;error when process disconnected event .&quot;</span><span class=p>,</span> <span class=n>t</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=cm>/** 处理请求和响应消息，这里的 message 变量类型可能是 Request，也可能是 Response */</span>
    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>received</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>Object</span> <span class=n>message</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=n>ExecutorService</span> <span class=n>cexecutor</span> <span class=o>=</span> <span class=n>getExecutorService</span><span class=p>();</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=c1>// 将请求和响应消息派发到线程池中处理</span>
            <span class=n>cexecutor</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=k>new</span> <span class=n>ChannelEventRunnable</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>handler</span><span class=p>,</span> <span class=n>ChannelState</span><span class=p>.</span><span class=na>RECEIVED</span><span class=p>,</span> <span class=n>message</span><span class=p>));</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span><span class=p>(</span><span class=n>message</span> <span class=k>instanceof</span> <span class=n>Request</span> <span class=o>&amp;&amp;</span> <span class=n>t</span> <span class=k>instanceof</span> <span class=n>RejectedExecutionException</span><span class=p>){</span>
                <span class=n>Request</span> <span class=n>request</span> <span class=o>=</span> <span class=p>(</span><span class=n>Request</span><span class=p>)</span><span class=n>message</span><span class=p>;</span>
                <span class=c1>// 如果通信方式为双向通信，此时将 Server side ... threadpool is exhausted </span>
                <span class=c1>// 错误信息封装到 Response 中，并返回给服务消费方。</span>
                <span class=k>if</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>isTwoWay</span><span class=p>()){</span>
                    <span class=n>String</span> <span class=n>msg</span> <span class=o>=</span> <span class=s>&quot;Server side(&quot;</span> <span class=o>+</span> <span class=n>url</span><span class=p>.</span><span class=na>getIp</span><span class=p>()</span> <span class=o>+</span> <span class=s>&quot;,&quot;</span> <span class=o>+</span> <span class=n>url</span><span class=p>.</span><span class=na>getPort</span><span class=p>()</span> 
                        <span class=o>+</span> <span class=s>&quot;) threadpool is exhausted ,detail msg:&quot;</span> <span class=o>+</span> <span class=n>t</span><span class=p>.</span><span class=na>getMessage</span><span class=p>();</span>
                    <span class=n>Response</span> <span class=n>response</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Response</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>getId</span><span class=p>(),</span> <span class=n>request</span><span class=p>.</span><span class=na>getVersion</span><span class=p>());</span>
                    <span class=n>response</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>Response</span><span class=p>.</span><span class=na>SERVER_THREADPOOL_EXHAUSTED_ERROR</span><span class=p>);</span>
                    <span class=n>response</span><span class=p>.</span><span class=na>setErrorMessage</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span>
                    <span class=c1>// 返回包含错误信息的 Response 对象</span>
                    <span class=n>channel</span><span class=p>.</span><span class=na>send</span><span class=p>(</span><span class=n>response</span><span class=p>);</span>
                    <span class=k>return</span><span class=p>;</span>
                <span class=p>}</span>
            <span class=p>}</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>ExecutionException</span><span class=p>(...,</span> <span class=s>&quot; error when process received event .&quot;</span><span class=p>,</span> <span class=n>t</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=cm>/** 处理异常信息 */</span>
    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>caught</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>Throwable</span> <span class=n>exception</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=n>ExecutorService</span> <span class=n>cexecutor</span> <span class=o>=</span> <span class=n>getExecutorService</span><span class=p>();</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=n>cexecutor</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=k>new</span> <span class=n>ChannelEventRunnable</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>handler</span><span class=p>,</span> <span class=n>ChannelState</span><span class=p>.</span><span class=na>CAUGHT</span><span class=p>,</span> <span class=n>exception</span><span class=p>));</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>ExecutionException</span><span class=p>(...,</span> <span class=s>&quot;error when process caught event ...&quot;</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>如上，请求对象会被封装 ChannelEventRunnable 中，ChannelEventRunnable 将会是服务调用过程的新起点。所以接下来我们以 ChannelEventRunnable 为起点向下探索。</p> <h5 id=2322>2.3.2.2 调用服务<a class=headerlink href=#2322 title="Permanent link">&para;</a></h5> <p>本小节，我们从 ChannelEventRunnable 开始分析，该类的主要代码如下：</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ChannelEventRunnable</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=p>{</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>ChannelHandler</span> <span class=n>handler</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Channel</span> <span class=n>channel</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>ChannelState</span> <span class=n>state</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Throwable</span> <span class=n>exception</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Object</span> <span class=n>message</span><span class=p>;</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
        <span class=c1>// 检测通道状态，对于请求或响应消息，此时 state = RECEIVED</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>state</span> <span class=o>==</span> <span class=n>ChannelState</span><span class=p>.</span><span class=na>RECEIVED</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>try</span> <span class=p>{</span>
                <span class=c1>// 将 channel 和 message 传给 ChannelHandler 对象，进行后续的调用</span>
                <span class=n>handler</span><span class=p>.</span><span class=na>received</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>message</span><span class=p>);</span>
            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>logger</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;... operation error, channel is ... message is ...&quot;</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span> 

        <span class=c1>// 其他消息类型通过 switch 进行处理</span>
        <span class=k>else</span> <span class=p>{</span>
            <span class=k>switch</span> <span class=p>(</span><span class=n>state</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>case</span> <span class=n>CONNECTED</span><span class=p>:</span>
                <span class=k>try</span> <span class=p>{</span>
                    <span class=n>handler</span><span class=p>.</span><span class=na>connected</span><span class=p>(</span><span class=n>channel</span><span class=p>);</span>
                <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>logger</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;... operation error, channel is ...&quot;</span><span class=p>);</span>
                <span class=p>}</span>
                <span class=k>break</span><span class=p>;</span>
            <span class=k>case</span> <span class=n>DISCONNECTED</span><span class=p>:</span>
                <span class=c1>// ...</span>
            <span class=k>case</span> <span class=n>SENT</span><span class=p>:</span>
                <span class=c1>// ...</span>
            <span class=k>case</span> <span class=n>CAUGHT</span><span class=p>:</span>
                <span class=c1>// ...</span>
            <span class=k>default</span><span class=p>:</span>
                <span class=n>logger</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;unknown state: &quot;</span> <span class=o>+</span> <span class=n>state</span> <span class=o>+</span> <span class=s>&quot;, message is &quot;</span> <span class=o>+</span> <span class=n>message</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span>

    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>如上，请求和响应消息出现频率明显比其他类型消息高，所以这里对该类型的消息进行了针对性判断。ChannelEventRunnable 仅是一个中转站，它的 run 方法中并不包含具体的调用逻辑，仅用于将参数传给其他 ChannelHandler 对象进行处理，该对象类型为 DecodeHandler。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DecodeHandler</span> <span class=kd>extends</span> <span class=n>AbstractChannelHandlerDelegate</span> <span class=p>{</span>

    <span class=kd>public</span> <span class=nf>DecodeHandler</span><span class=p>(</span><span class=n>ChannelHandler</span> <span class=n>handler</span><span class=p>)</span> <span class=p>{</span>
        <span class=kd>super</span><span class=p>(</span><span class=n>handler</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>received</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>Object</span> <span class=n>message</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>message</span> <span class=k>instanceof</span> <span class=n>Decodeable</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 对 Decodeable 接口实现类对象进行解码</span>
            <span class=n>decode</span><span class=p>(</span><span class=n>message</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>message</span> <span class=k>instanceof</span> <span class=n>Request</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 对 Request 的 data 字段进行解码</span>
            <span class=n>decode</span><span class=p>(((</span><span class=n>Request</span><span class=p>)</span> <span class=n>message</span><span class=p>).</span><span class=na>getData</span><span class=p>());</span>
        <span class=p>}</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>message</span> <span class=k>instanceof</span> <span class=n>Response</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 对 Request 的 result 字段进行解码</span>
            <span class=n>decode</span><span class=p>(((</span><span class=n>Response</span><span class=p>)</span> <span class=n>message</span><span class=p>).</span><span class=na>getResult</span><span class=p>());</span>
        <span class=p>}</span>

        <span class=c1>// 执行后续逻辑</span>
        <span class=n>handler</span><span class=p>.</span><span class=na>received</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>message</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>decode</span><span class=p>(</span><span class=n>Object</span> <span class=n>message</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// Decodeable 接口目前有两个实现类，</span>
        <span class=c1>// 分别为 DecodeableRpcInvocation 和 DecodeableRpcResult</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>message</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>message</span> <span class=k>instanceof</span> <span class=n>Decodeable</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>try</span> <span class=p>{</span>
                <span class=c1>// 执行解码逻辑</span>
                <span class=p>((</span><span class=n>Decodeable</span><span class=p>)</span> <span class=n>message</span><span class=p>).</span><span class=na>decode</span><span class=p>();</span>
            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>log</span><span class=p>.</span><span class=na>isWarnEnabled</span><span class=p>())</span> <span class=p>{</span>
                    <span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Call Decodeable.decode failed: &quot;</span> <span class=o>+</span> <span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>(),</span> <span class=n>e</span><span class=p>);</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>DecodeHandler 主要是包含了一些解码逻辑。2.2.1 节分析请求解码时说过，请求解码可在 IO 线程上执行，也可在线程池中执行，这个取决于运行时配置。DecodeHandler 存在的意义就是保证请求或响应对象可在线程池中被解码。解码完毕后，完全解码后的 Request 对象会继续向后传递，下一站是 HeaderExchangeHandler。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HeaderExchangeHandler</span> <span class=kd>implements</span> <span class=n>ChannelHandlerDelegate</span> <span class=p>{</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>ExchangeHandler</span> <span class=n>handler</span><span class=p>;</span>

    <span class=kd>public</span> <span class=nf>HeaderExchangeHandler</span><span class=p>(</span><span class=n>ExchangeHandler</span> <span class=n>handler</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>handler</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;handler == null&quot;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>this</span><span class=p>.</span><span class=na>handler</span> <span class=o>=</span> <span class=n>handler</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>received</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>Object</span> <span class=n>message</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=n>channel</span><span class=p>.</span><span class=na>setAttribute</span><span class=p>(</span><span class=n>KEY_READ_TIMESTAMP</span><span class=p>,</span> <span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>());</span>
        <span class=n>ExchangeChannel</span> <span class=n>exchangeChannel</span> <span class=o>=</span> <span class=n>HeaderExchangeChannel</span><span class=p>.</span><span class=na>getOrAddChannel</span><span class=p>(</span><span class=n>channel</span><span class=p>);</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=c1>// 处理请求对象</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>message</span> <span class=k>instanceof</span> <span class=n>Request</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>Request</span> <span class=n>request</span> <span class=o>=</span> <span class=p>(</span><span class=n>Request</span><span class=p>)</span> <span class=n>message</span><span class=p>;</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>isEvent</span><span class=p>())</span> <span class=p>{</span>
                    <span class=c1>// 处理事件</span>
                    <span class=n>handlerEvent</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>request</span><span class=p>);</span>
                <span class=p>}</span> 
                <span class=c1>// 处理普通的请求</span>
                <span class=k>else</span> <span class=p>{</span>
                    <span class=c1>// 双向通信</span>
                    <span class=k>if</span> <span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>isTwoWay</span><span class=p>())</span> <span class=p>{</span>
                        <span class=c1>// 向后调用服务，并得到调用结果</span>
                        <span class=n>Response</span> <span class=n>response</span> <span class=o>=</span> <span class=n>handleRequest</span><span class=p>(</span><span class=n>exchangeChannel</span><span class=p>,</span> <span class=n>request</span><span class=p>);</span>
                        <span class=c1>// 将调用结果返回给服务消费端</span>
                        <span class=n>channel</span><span class=p>.</span><span class=na>send</span><span class=p>(</span><span class=n>response</span><span class=p>);</span>
                    <span class=p>}</span> 
                    <span class=c1>// 如果是单向通信，仅向后调用指定服务即可，无需返回调用结果</span>
                    <span class=k>else</span> <span class=p>{</span>
                        <span class=n>handler</span><span class=p>.</span><span class=na>received</span><span class=p>(</span><span class=n>exchangeChannel</span><span class=p>,</span> <span class=n>request</span><span class=p>.</span><span class=na>getData</span><span class=p>());</span>
                    <span class=p>}</span>
                <span class=p>}</span>
            <span class=p>}</span>      
            <span class=c1>// 处理响应对象，服务消费方会执行此处逻辑，后面分析</span>
            <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>message</span> <span class=k>instanceof</span> <span class=n>Response</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>handleResponse</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=p>(</span><span class=n>Response</span><span class=p>)</span> <span class=n>message</span><span class=p>);</span>
            <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>message</span> <span class=k>instanceof</span> <span class=n>String</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// telnet 相关，忽略</span>
            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                <span class=n>handler</span><span class=p>.</span><span class=na>received</span><span class=p>(</span><span class=n>exchangeChannel</span><span class=p>,</span> <span class=n>message</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
            <span class=n>HeaderExchangeChannel</span><span class=p>.</span><span class=na>removeChannelIfDisconnected</span><span class=p>(</span><span class=n>channel</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=n>Response</span> <span class=nf>handleRequest</span><span class=p>(</span><span class=n>ExchangeChannel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>Request</span> <span class=n>req</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=n>Response</span> <span class=n>res</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Response</span><span class=p>(</span><span class=n>req</span><span class=p>.</span><span class=na>getId</span><span class=p>(),</span> <span class=n>req</span><span class=p>.</span><span class=na>getVersion</span><span class=p>());</span>
        <span class=c1>// 检测请求是否合法，不合法则返回状态码为 BAD_REQUEST 的响应</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>req</span><span class=p>.</span><span class=na>isBroken</span><span class=p>())</span> <span class=p>{</span>
            <span class=n>Object</span> <span class=n>data</span> <span class=o>=</span> <span class=n>req</span><span class=p>.</span><span class=na>getData</span><span class=p>();</span>

            <span class=n>String</span> <span class=n>msg</span><span class=p>;</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>data</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span>
                <span class=n>msg</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
            <span class=k>else</span> <span class=k>if</span>
                <span class=p>(</span><span class=n>data</span> <span class=k>instanceof</span> <span class=n>Throwable</span><span class=p>)</span> <span class=n>msg</span> <span class=o>=</span> <span class=n>StringUtils</span><span class=p>.</span><span class=na>toString</span><span class=p>((</span><span class=n>Throwable</span><span class=p>)</span> <span class=n>data</span><span class=p>);</span>
            <span class=k>else</span>
                <span class=n>msg</span> <span class=o>=</span> <span class=n>data</span><span class=p>.</span><span class=na>toString</span><span class=p>();</span>
            <span class=n>res</span><span class=p>.</span><span class=na>setErrorMessage</span><span class=p>(</span><span class=s>&quot;Fail to decode request due to: &quot;</span> <span class=o>+</span> <span class=n>msg</span><span class=p>);</span>
            <span class=c1>// 设置 BAD_REQUEST 状态</span>
            <span class=n>res</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>Response</span><span class=p>.</span><span class=na>BAD_REQUEST</span><span class=p>);</span>

            <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=c1>// 获取 data 字段值，也就是 RpcInvocation 对象</span>
        <span class=n>Object</span> <span class=n>msg</span> <span class=o>=</span> <span class=n>req</span><span class=p>.</span><span class=na>getData</span><span class=p>();</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=c1>// 继续向下调用</span>
            <span class=n>Object</span> <span class=n>result</span> <span class=o>=</span> <span class=n>handler</span><span class=p>.</span><span class=na>reply</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>msg</span><span class=p>);</span>
            <span class=c1>// 设置 OK 状态码</span>
            <span class=n>res</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>Response</span><span class=p>.</span><span class=na>OK</span><span class=p>);</span>
            <span class=c1>// 设置调用结果</span>
            <span class=n>res</span><span class=p>.</span><span class=na>setResult</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 若调用过程出现异常，则设置 SERVICE_ERROR，表示服务端异常</span>
            <span class=n>res</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>Response</span><span class=p>.</span><span class=na>SERVICE_ERROR</span><span class=p>);</span>
            <span class=n>res</span><span class=p>.</span><span class=na>setErrorMessage</span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>toString</span><span class=p>(</span><span class=n>e</span><span class=p>));</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>到这里，我们看到了比较清晰的请求和响应逻辑。对于双向通信，HeaderExchangeHandler 首先向后进行调用，得到调用结果。然后将调用结果封装到 Response 对象中，最后再将该对象返回给服务消费方。如果请求不合法，或者调用失败，则将错误信息封装到 Response 对象中，并返回给服务消费方。接下来我们继续向后分析，把剩余的调用过程分析完。下面分析定义在 DubboProtocol 类中的匿名类对象逻辑，如下：</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DubboProtocol</span> <span class=kd>extends</span> <span class=n>AbstractProtocol</span> <span class=p>{</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>NAME</span> <span class=o>=</span> <span class=s>&quot;dubbo&quot;</span><span class=p>;</span>

    <span class=kd>private</span> <span class=n>ExchangeHandler</span> <span class=n>requestHandler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ExchangeHandlerAdapter</span><span class=p>()</span> <span class=p>{</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=n>Object</span> <span class=nf>reply</span><span class=p>(</span><span class=n>ExchangeChannel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>Object</span> <span class=n>message</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>message</span> <span class=k>instanceof</span> <span class=n>Invocation</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>Invocation</span> <span class=n>inv</span> <span class=o>=</span> <span class=p>(</span><span class=n>Invocation</span><span class=p>)</span> <span class=n>message</span><span class=p>;</span>
                <span class=c1>// 获取 Invoker 实例</span>
                <span class=n>Invoker</span><span class=o>&lt;?&gt;</span> <span class=n>invoker</span> <span class=o>=</span> <span class=n>getInvoker</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>inv</span><span class=p>);</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>Boolean</span><span class=p>.</span><span class=na>TRUE</span><span class=p>.</span><span class=na>toString</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>inv</span><span class=p>.</span><span class=na>getAttachments</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>IS_CALLBACK_SERVICE_INVOKE</span><span class=p>)))</span> <span class=p>{</span>
                    <span class=c1>// 回调相关，忽略</span>
                <span class=p>}</span>
                <span class=n>RpcContext</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>setRemoteAddress</span><span class=p>(</span><span class=n>channel</span><span class=p>.</span><span class=na>getRemoteAddress</span><span class=p>());</span>
                <span class=c1>// 通过 Invoker 调用具体的服务</span>
                <span class=k>return</span> <span class=n>invoker</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>inv</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>RemotingException</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=s>&quot;Unsupported request: ...&quot;</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=c1>// 忽略其他方法</span>
    <span class=p>}</span>

    <span class=n>Invoker</span><span class=o>&lt;?&gt;</span> <span class=n>getInvoker</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>Invocation</span> <span class=n>inv</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=c1>// 忽略回调和本地存根相关逻辑</span>
        <span class=c1>// ...</span>

        <span class=kt>int</span> <span class=n>port</span> <span class=o>=</span> <span class=n>channel</span><span class=p>.</span><span class=na>getLocalAddress</span><span class=p>().</span><span class=na>getPort</span><span class=p>();</span>

        <span class=c1>// 计算 service key，格式为 groupName/serviceName:serviceVersion:port。比如：</span>
        <span class=c1>//   dubbo/com.alibaba.dubbo.demo.DemoService:1.0.0:20880</span>
        <span class=n>String</span> <span class=n>serviceKey</span> <span class=o>=</span> <span class=n>serviceKey</span><span class=p>(</span><span class=n>port</span><span class=p>,</span> <span class=n>path</span><span class=p>,</span> <span class=n>inv</span><span class=p>.</span><span class=na>getAttachments</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>VERSION_KEY</span><span class=p>),</span> <span class=n>inv</span><span class=p>.</span><span class=na>getAttachments</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>GROUP_KEY</span><span class=p>));</span>

        <span class=c1>// 从 exporterMap 查找与 serviceKey 相对应的 DubboExporter 对象，</span>
        <span class=c1>// 服务导出过程中会将 &lt;serviceKey, DubboExporter&gt; 映射关系存储到 exporterMap 集合中</span>
        <span class=n>DubboExporter</span><span class=o>&lt;?&gt;</span> <span class=n>exporter</span> <span class=o>=</span> <span class=p>(</span><span class=n>DubboExporter</span><span class=o>&lt;?&gt;</span><span class=p>)</span> <span class=n>exporterMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>serviceKey</span><span class=p>);</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>exporter</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>RemotingException</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=s>&quot;Not found exported service ...&quot;</span><span class=p>);</span>

        <span class=c1>// 获取 Invoker 对象，并返回</span>
        <span class=k>return</span> <span class=n>exporter</span><span class=p>.</span><span class=na>getInvoker</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=c1>// 忽略其他方法</span>
<span class=p>}</span>
</code></pre></div> <p>以上逻辑用于获取与指定服务对应的 Invoker 实例，并通过 Invoker 的 invoke 方法调用服务逻辑。invoke 方法定义在 AbstractProxyInvoker 中，代码如下。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>AbstractProxyInvoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>Result</span> <span class=nf>invoke</span><span class=p>(</span><span class=n>Invocation</span> <span class=n>invocation</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RpcException</span> <span class=p>{</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=c1>// 调用 doInvoke 执行后续的调用，并将调用结果封装到 RpcResult 中，并</span>
            <span class=k>return</span> <span class=k>new</span> <span class=n>RpcResult</span><span class=p>(</span><span class=n>doInvoke</span><span class=p>(</span><span class=n>proxy</span><span class=p>,</span> <span class=n>invocation</span><span class=p>.</span><span class=na>getMethodName</span><span class=p>(),</span> <span class=n>invocation</span><span class=p>.</span><span class=na>getParameterTypes</span><span class=p>(),</span> <span class=n>invocation</span><span class=p>.</span><span class=na>getArguments</span><span class=p>()));</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>InvocationTargetException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=k>new</span> <span class=n>RpcResult</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getTargetException</span><span class=p>());</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>RpcException</span><span class=p>(</span><span class=s>&quot;Failed to invoke remote proxy method ...&quot;</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=kd>protected</span> <span class=kd>abstract</span> <span class=n>Object</span> <span class=nf>doInvoke</span><span class=p>(</span><span class=n>T</span> <span class=n>proxy</span><span class=p>,</span> <span class=n>String</span> <span class=n>methodName</span><span class=p>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=n>parameterTypes</span><span class=p>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>arguments</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>Throwable</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>如上，doInvoke 是一个抽象方法，这个需要由具体的 Invoker 实例实现。Invoker 实例是在运行时通过 JavassistProxyFactory 创建的，创建逻辑如下：</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>JavassistProxyFactory</span> <span class=kd>extends</span> <span class=n>AbstractProxyFactory</span> <span class=p>{</span>

    <span class=c1>// 省略其他方法</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>getInvoker</span><span class=p>(</span><span class=n>T</span> <span class=n>proxy</span><span class=p>,</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>type</span><span class=p>,</span> <span class=n>URL</span> <span class=n>url</span><span class=p>)</span> <span class=p>{</span>
        <span class=kd>final</span> <span class=n>Wrapper</span> <span class=n>wrapper</span> <span class=o>=</span> <span class=n>Wrapper</span><span class=p>.</span><span class=na>getWrapper</span><span class=p>(</span><span class=n>proxy</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getName</span><span class=p>().</span><span class=na>indexOf</span><span class=p>(</span><span class=sc>&#39;$&#39;</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>?</span> <span class=n>proxy</span><span class=p>.</span><span class=na>getClass</span><span class=p>()</span> <span class=p>:</span> <span class=n>type</span><span class=p>);</span>
        <span class=c1>// 创建匿名类对象</span>
        <span class=k>return</span> <span class=k>new</span> <span class=n>AbstractProxyInvoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>(</span><span class=n>proxy</span><span class=p>,</span> <span class=n>type</span><span class=p>,</span> <span class=n>url</span><span class=p>)</span> <span class=p>{</span>
            <span class=nd>@Override</span>
            <span class=kd>protected</span> <span class=n>Object</span> <span class=nf>doInvoke</span><span class=p>(</span><span class=n>T</span> <span class=n>proxy</span><span class=p>,</span> <span class=n>String</span> <span class=n>methodName</span><span class=p>,</span>
                                      <span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=n>parameterTypes</span><span class=p>,</span>
                                      <span class=n>Object</span><span class=o>[]</span> <span class=n>arguments</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>Throwable</span> <span class=p>{</span>
                <span class=c1>// 调用 invokeMethod 方法进行后续的调用</span>
                <span class=k>return</span> <span class=n>wrapper</span><span class=p>.</span><span class=na>invokeMethod</span><span class=p>(</span><span class=n>proxy</span><span class=p>,</span> <span class=n>methodName</span><span class=p>,</span> <span class=n>parameterTypes</span><span class=p>,</span> <span class=n>arguments</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>};</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>Wrapper 是一个抽象类，其中 invokeMethod 是一个抽象方法。Dubbo 会在运行时通过 Javassist 框架为 Wrapper 生成实现类，并实现 invokeMethod 方法，该方法最终会根据调用信息调用具体的服务。以 DemoServiceImpl 为例，Javassist 为其生成的代理类如下。</p> <div class=highlight><pre><span></span><code><span class=cm>/** Wrapper0 是在运行时生成的，大家可使用 Arthas 进行反编译 */</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>Wrapper0</span> <span class=kd>extends</span> <span class=n>Wrapper</span> <span class=kd>implements</span> <span class=n>ClassGenerator</span><span class=p>.</span><span class=na>DC</span> <span class=p>{</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=n>String</span><span class=o>[]</span> <span class=n>pns</span><span class=p>;</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=n>Map</span> <span class=n>pts</span><span class=p>;</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=n>String</span><span class=o>[]</span> <span class=n>mns</span><span class=p>;</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=n>String</span><span class=o>[]</span> <span class=n>dmns</span><span class=p>;</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=n>Class</span><span class=o>[]</span> <span class=n>mts0</span><span class=p>;</span>

    <span class=c1>// 省略其他方法</span>

    <span class=kd>public</span> <span class=n>Object</span> <span class=nf>invokeMethod</span><span class=p>(</span><span class=n>Object</span> <span class=n>object</span><span class=p>,</span> <span class=n>String</span> <span class=n>string</span><span class=p>,</span> <span class=n>Class</span><span class=o>[]</span> <span class=n>arrclass</span><span class=p>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>arrobject</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>InvocationTargetException</span> <span class=p>{</span>
        <span class=n>DemoService</span> <span class=n>demoService</span><span class=p>;</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=c1>// 类型转换</span>
            <span class=n>demoService</span> <span class=o>=</span> <span class=p>(</span><span class=n>DemoService</span><span class=p>)</span><span class=n>object</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>throwable</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=n>throwable</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=c1>// 根据方法名调用指定的方法</span>
            <span class=k>if</span> <span class=p>(</span><span class=s>&quot;sayHello&quot;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>string</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>arrclass</span><span class=p>.</span><span class=na>length</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>return</span> <span class=n>demoService</span><span class=p>.</span><span class=na>sayHello</span><span class=p>((</span><span class=n>String</span><span class=p>)</span><span class=n>arrobject</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>throwable</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>InvocationTargetException</span><span class=p>(</span><span class=n>throwable</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>NoSuchMethodException</span><span class=p>(</span><span class=k>new</span> <span class=n>StringBuffer</span><span class=p>().</span><span class=na>append</span><span class=p>(</span><span class=s>&quot;Not found method \&quot;&quot;</span><span class=p>).</span><span class=na>append</span><span class=p>(</span><span class=n>string</span><span class=p>).</span><span class=na>append</span><span class=p>(</span><span class=s>&quot;\&quot; in class com.alibaba.dubbo.demo.DemoService.&quot;</span><span class=p>).</span><span class=na>toString</span><span class=p>());</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>到这里，整个服务调用过程就分析完了。最后把调用过程贴出来，如下：</p> <div class=highlight><pre><span></span><code>ChannelEventRunnable#run()
  —&gt; DecodeHandler#received(Channel, Object)
    —&gt; HeaderExchangeHandler#received(Channel, Object)
      —&gt; HeaderExchangeHandler#handleRequest(ExchangeChannel, Request)
        —&gt; DubboProtocol.requestHandler#reply(ExchangeChannel, Object)
          —&gt; Filter#invoke(Invoker, Invocation)
            —&gt; AbstractProxyInvoker#invoke(Invocation)
              —&gt; Wrapper0#invokeMethod(Object, String, Class[], Object[])
                —&gt; DemoServiceImpl#sayHello(String)
</code></pre></div> <h3 id=24>2.4 服务提供方返回调用结果<a class=headerlink href=#24 title="Permanent link">&para;</a></h3> <p>服务提供方调用指定服务后，会将调用结果封装到 Response 对象中，并将该对象返回给服务消费方。服务提供方也是通过 NettyChannel 的 send 方法将 Response 对象返回，这个方法在 2.2.1 节分析过，这里就不在重复分析了。本节我们仅需关注 Response 对象的编码过程即可，这里仍然省略一些中间调用，直接分析具体的编码逻辑。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ExchangeCodec</span> <span class=kd>extends</span> <span class=n>TelnetCodec</span> <span class=p>{</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>encode</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>ChannelBuffer</span> <span class=n>buffer</span><span class=p>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>msg</span> <span class=k>instanceof</span> <span class=n>Request</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>encodeRequest</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=p>(</span><span class=n>Request</span><span class=p>)</span> <span class=n>msg</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>msg</span> <span class=k>instanceof</span> <span class=n>Response</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 对响应对象进行编码</span>
            <span class=n>encodeResponse</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=p>(</span><span class=n>Response</span><span class=p>)</span> <span class=n>msg</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=kd>super</span><span class=p>.</span><span class=na>encode</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=n>msg</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>encodeResponse</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>ChannelBuffer</span> <span class=n>buffer</span><span class=p>,</span> <span class=n>Response</span> <span class=n>res</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
        <span class=kt>int</span> <span class=n>savedWriteIndex</span> <span class=o>=</span> <span class=n>buffer</span><span class=p>.</span><span class=na>writerIndex</span><span class=p>();</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=n>Serialization</span> <span class=n>serialization</span> <span class=o>=</span> <span class=n>getSerialization</span><span class=p>(</span><span class=n>channel</span><span class=p>);</span>
            <span class=c1>// 创建消息头字节数组</span>
            <span class=kt>byte</span><span class=o>[]</span> <span class=n>header</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=n>HEADER_LENGTH</span><span class=o>]</span><span class=p>;</span>
            <span class=c1>// 设置魔数</span>
            <span class=n>Bytes</span><span class=p>.</span><span class=na>short2bytes</span><span class=p>(</span><span class=n>MAGIC</span><span class=p>,</span> <span class=n>header</span><span class=p>);</span>
            <span class=c1>// 设置序列化器编号</span>
            <span class=n>header</span><span class=o>[</span><span class=mi>2</span><span class=o>]</span> <span class=o>=</span> <span class=n>serialization</span><span class=p>.</span><span class=na>getContentTypeId</span><span class=p>();</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>res</span><span class=p>.</span><span class=na>isHeartbeat</span><span class=p>())</span> <span class=n>header</span><span class=o>[</span><span class=mi>2</span><span class=o>]</span> <span class=o>|=</span> <span class=n>FLAG_EVENT</span><span class=p>;</span>
            <span class=c1>// 获取响应状态</span>
            <span class=kt>byte</span> <span class=n>status</span> <span class=o>=</span> <span class=n>res</span><span class=p>.</span><span class=na>getStatus</span><span class=p>();</span>
            <span class=c1>// 设置响应状态</span>
            <span class=n>header</span><span class=o>[</span><span class=mi>3</span><span class=o>]</span> <span class=o>=</span> <span class=n>status</span><span class=p>;</span>
            <span class=c1>// 设置请求编号</span>
            <span class=n>Bytes</span><span class=p>.</span><span class=na>long2bytes</span><span class=p>(</span><span class=n>res</span><span class=p>.</span><span class=na>getId</span><span class=p>(),</span> <span class=n>header</span><span class=p>,</span> <span class=mi>4</span><span class=p>);</span>

            <span class=c1>// 更新 writerIndex，为消息头预留 16 个字节的空间</span>
            <span class=n>buffer</span><span class=p>.</span><span class=na>writerIndex</span><span class=p>(</span><span class=n>savedWriteIndex</span> <span class=o>+</span> <span class=n>HEADER_LENGTH</span><span class=p>);</span>
            <span class=n>ChannelBufferOutputStream</span> <span class=n>bos</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ChannelBufferOutputStream</span><span class=p>(</span><span class=n>buffer</span><span class=p>);</span>
            <span class=n>ObjectOutput</span> <span class=n>out</span> <span class=o>=</span> <span class=n>serialization</span><span class=p>.</span><span class=na>serialize</span><span class=p>(</span><span class=n>channel</span><span class=p>.</span><span class=na>getUrl</span><span class=p>(),</span> <span class=n>bos</span><span class=p>);</span>

            <span class=k>if</span> <span class=p>(</span><span class=n>status</span> <span class=o>==</span> <span class=n>Response</span><span class=p>.</span><span class=na>OK</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>res</span><span class=p>.</span><span class=na>isHeartbeat</span><span class=p>())</span> <span class=p>{</span>
                    <span class=c1>// 对心跳响应结果进行序列化，已废弃</span>
                    <span class=n>encodeHeartbeatData</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>out</span><span class=p>,</span> <span class=n>res</span><span class=p>.</span><span class=na>getResult</span><span class=p>());</span>
                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                    <span class=c1>// 对调用结果进行序列化</span>
                    <span class=n>encodeResponseData</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>out</span><span class=p>,</span> <span class=n>res</span><span class=p>.</span><span class=na>getResult</span><span class=p>(),</span> <span class=n>res</span><span class=p>.</span><span class=na>getVersion</span><span class=p>());</span>
                <span class=p>}</span>
            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span> 
                <span class=c1>// 对错误信息进行序列化</span>
                <span class=n>out</span><span class=p>.</span><span class=na>writeUTF</span><span class=p>(</span><span class=n>res</span><span class=p>.</span><span class=na>getErrorMessage</span><span class=p>())</span>
            <span class=p>};</span>
            <span class=n>out</span><span class=p>.</span><span class=na>flushBuffer</span><span class=p>();</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>out</span> <span class=k>instanceof</span> <span class=n>Cleanable</span><span class=p>)</span> <span class=p>{</span>
                <span class=p>((</span><span class=n>Cleanable</span><span class=p>)</span> <span class=n>out</span><span class=p>).</span><span class=na>cleanup</span><span class=p>();</span>
            <span class=p>}</span>
            <span class=n>bos</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span>
            <span class=n>bos</span><span class=p>.</span><span class=na>close</span><span class=p>();</span>

            <span class=c1>// 获取写入的字节数，也就是消息体长度</span>
            <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=n>bos</span><span class=p>.</span><span class=na>writtenBytes</span><span class=p>();</span>
            <span class=n>checkPayload</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>

            <span class=c1>// 将消息体长度写入到消息头中</span>
            <span class=n>Bytes</span><span class=p>.</span><span class=na>int2bytes</span><span class=p>(</span><span class=n>len</span><span class=p>,</span> <span class=n>header</span><span class=p>,</span> <span class=mi>12</span><span class=p>);</span>
            <span class=c1>// 将 buffer 指针移动到 savedWriteIndex，为写消息头做准备</span>
            <span class=n>buffer</span><span class=p>.</span><span class=na>writerIndex</span><span class=p>(</span><span class=n>savedWriteIndex</span><span class=p>);</span>
            <span class=c1>// 从 savedWriteIndex 下标处写入消息头</span>
            <span class=n>buffer</span><span class=p>.</span><span class=na>writeBytes</span><span class=p>(</span><span class=n>header</span><span class=p>);</span> 
            <span class=c1>// 设置新的 writerIndex，writerIndex = 原写下标 + 消息头长度 + 消息体长度</span>
            <span class=n>buffer</span><span class=p>.</span><span class=na>writerIndex</span><span class=p>(</span><span class=n>savedWriteIndex</span> <span class=o>+</span> <span class=n>HEADER_LENGTH</span> <span class=o>+</span> <span class=n>len</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 异常处理逻辑不是很难理解，但是代码略多，这里忽略了</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=kd>class</span> <span class=nc>DubboCodec</span> <span class=kd>extends</span> <span class=n>ExchangeCodec</span> <span class=kd>implements</span> <span class=n>Codec2</span> <span class=p>{</span>

    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>encodeResponseData</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>ObjectOutput</span> <span class=n>out</span><span class=p>,</span> <span class=n>Object</span> <span class=n>data</span><span class=p>,</span> <span class=n>String</span> <span class=n>version</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
        <span class=n>Result</span> <span class=n>result</span> <span class=o>=</span> <span class=p>(</span><span class=n>Result</span><span class=p>)</span> <span class=n>data</span><span class=p>;</span>
        <span class=c1>// 检测当前协议版本是否支持带有 attachment 集合的 Response 对象</span>
        <span class=kt>boolean</span> <span class=n>attach</span> <span class=o>=</span> <span class=n>Version</span><span class=p>.</span><span class=na>isSupportResponseAttachment</span><span class=p>(</span><span class=n>version</span><span class=p>);</span>
        <span class=n>Throwable</span> <span class=n>th</span> <span class=o>=</span> <span class=n>result</span><span class=p>.</span><span class=na>getException</span><span class=p>();</span>

        <span class=c1>// 异常信息为空</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>th</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>Object</span> <span class=n>ret</span> <span class=o>=</span> <span class=n>result</span><span class=p>.</span><span class=na>getValue</span><span class=p>();</span>
            <span class=c1>// 调用结果为空</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 序列化响应类型</span>
                <span class=n>out</span><span class=p>.</span><span class=na>writeByte</span><span class=p>(</span><span class=n>attach</span> <span class=o>?</span> <span class=n>RESPONSE_NULL_VALUE_WITH_ATTACHMENTS</span> <span class=p>:</span> <span class=n>RESPONSE_NULL_VALUE</span><span class=p>);</span>
            <span class=p>}</span> 
            <span class=c1>// 调用结果非空</span>
            <span class=k>else</span> <span class=p>{</span>
                <span class=c1>// 序列化响应类型</span>
                <span class=n>out</span><span class=p>.</span><span class=na>writeByte</span><span class=p>(</span><span class=n>attach</span> <span class=o>?</span> <span class=n>RESPONSE_VALUE_WITH_ATTACHMENTS</span> <span class=p>:</span> <span class=n>RESPONSE_VALUE</span><span class=p>);</span>
                <span class=c1>// 序列化调用结果</span>
                <span class=n>out</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>ret</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span> 
        <span class=c1>// 异常信息非空</span>
        <span class=k>else</span> <span class=p>{</span>
            <span class=c1>// 序列化响应类型</span>
            <span class=n>out</span><span class=p>.</span><span class=na>writeByte</span><span class=p>(</span><span class=n>attach</span> <span class=o>?</span> <span class=n>RESPONSE_WITH_EXCEPTION_WITH_ATTACHMENTS</span> <span class=p>:</span> <span class=n>RESPONSE_WITH_EXCEPTION</span><span class=p>);</span>
            <span class=c1>// 序列化异常对象</span>
            <span class=n>out</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>th</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>attach</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 记录 Dubbo 协议版本</span>
            <span class=n>result</span><span class=p>.</span><span class=na>getAttachments</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>DUBBO_VERSION_KEY</span><span class=p>,</span> <span class=n>Version</span><span class=p>.</span><span class=na>getProtocolVersion</span><span class=p>());</span>
            <span class=c1>// 序列化 attachments 集合</span>
            <span class=n>out</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=na>getAttachments</span><span class=p>());</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>以上就是 Response 对象编码的过程，和前面分析的 Request 对象编码过程很相似。如果大家能看 Request 对象的编码逻辑，那么这里的 Response 对象的编码逻辑也不难理解，就不多说了。接下来我们再来分析双向通信的最后一环 —— 服务消费方接收调用结果。</p> <h3 id=25>2.5 服务消费方接收调用结果<a class=headerlink href=#25 title="Permanent link">&para;</a></h3> <p>服务消费方在收到响应数据后，首先要做的事情是对响应数据进行解码，得到 Response 对象。然后再将该对象传递给下一个入站处理器，这个入站处理器就是 NettyHandler。接下来 NettyHandler 会将这个对象继续向下传递，最后 AllChannelHandler 的 received 方法会收到这个对象，并将这个对象派发到线程池中。这个过程和服务提供方接收请求的过程是一样的，因此这里就不重复分析了。本节我们重点分析两个方面的内容，一是响应数据的解码过程，二是 Dubbo 如何将调用结果传递给用户线程的。下面先来分析响应数据的解码过程。</p> <h4 id=251>2.5.1 响应数据解码<a class=headerlink href=#251 title="Permanent link">&para;</a></h4> <p>响应数据解码逻辑主要的逻辑封装在 DubboCodec 中，我们直接分析这个类的代码。如下：</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DubboCodec</span> <span class=kd>extends</span> <span class=n>ExchangeCodec</span> <span class=kd>implements</span> <span class=n>Codec2</span> <span class=p>{</span>

    <span class=nd>@Override</span>
    <span class=kd>protected</span> <span class=n>Object</span> <span class=nf>decodeBody</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>InputStream</span> <span class=n>is</span><span class=p>,</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>header</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
        <span class=kt>byte</span> <span class=n>flag</span> <span class=o>=</span> <span class=n>header</span><span class=o>[</span><span class=mi>2</span><span class=o>]</span><span class=p>,</span> <span class=n>proto</span> <span class=o>=</span> <span class=p>(</span><span class=kt>byte</span><span class=p>)</span> <span class=p>(</span><span class=n>flag</span> <span class=o>&amp;</span> <span class=n>SERIALIZATION_MASK</span><span class=p>);</span>
        <span class=n>Serialization</span> <span class=n>s</span> <span class=o>=</span> <span class=n>CodecSupport</span><span class=p>.</span><span class=na>getSerialization</span><span class=p>(</span><span class=n>channel</span><span class=p>.</span><span class=na>getUrl</span><span class=p>(),</span> <span class=n>proto</span><span class=p>);</span>
        <span class=c1>// 获取请求编号</span>
        <span class=kt>long</span> <span class=n>id</span> <span class=o>=</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>bytes2long</span><span class=p>(</span><span class=n>header</span><span class=p>,</span> <span class=mi>4</span><span class=p>);</span>
        <span class=c1>// 检测消息类型，若下面的条件成立，表明消息类型为 Response</span>
        <span class=k>if</span> <span class=p>((</span><span class=n>flag</span> <span class=o>&amp;</span> <span class=n>FLAG_REQUEST</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 创建 Response 对象</span>
            <span class=n>Response</span> <span class=n>res</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Response</span><span class=p>(</span><span class=n>id</span><span class=p>);</span>
            <span class=c1>// 检测事件标志位</span>
            <span class=k>if</span> <span class=p>((</span><span class=n>flag</span> <span class=o>&amp;</span> <span class=n>FLAG_EVENT</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 设置心跳事件</span>
                <span class=n>res</span><span class=p>.</span><span class=na>setEvent</span><span class=p>(</span><span class=n>Response</span><span class=p>.</span><span class=na>HEARTBEAT_EVENT</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=c1>// 获取响应状态</span>
            <span class=kt>byte</span> <span class=n>status</span> <span class=o>=</span> <span class=n>header</span><span class=o>[</span><span class=mi>3</span><span class=o>]</span><span class=p>;</span>
            <span class=c1>// 设置响应状态</span>
            <span class=n>res</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>status</span><span class=p>);</span>

            <span class=c1>// 如果响应状态为 OK，表明调用过程正常</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>status</span> <span class=o>==</span> <span class=n>Response</span><span class=p>.</span><span class=na>OK</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>try</span> <span class=p>{</span>
                    <span class=n>Object</span> <span class=n>data</span><span class=p>;</span>
                    <span class=k>if</span> <span class=p>(</span><span class=n>res</span><span class=p>.</span><span class=na>isHeartbeat</span><span class=p>())</span> <span class=p>{</span>
                        <span class=c1>// 反序列化心跳数据，已废弃</span>
                        <span class=n>data</span> <span class=o>=</span> <span class=n>decodeHeartbeatData</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>deserialize</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>channel</span><span class=p>.</span><span class=na>getUrl</span><span class=p>(),</span> <span class=n>is</span><span class=p>));</span>
                    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>res</span><span class=p>.</span><span class=na>isEvent</span><span class=p>())</span> <span class=p>{</span>
                        <span class=c1>// 反序列化事件数据</span>
                        <span class=n>data</span> <span class=o>=</span> <span class=n>decodeEventData</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>deserialize</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>channel</span><span class=p>.</span><span class=na>getUrl</span><span class=p>(),</span> <span class=n>is</span><span class=p>));</span>
                    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                        <span class=n>DecodeableRpcResult</span> <span class=n>result</span><span class=p>;</span>
                        <span class=c1>// 根据 url 参数决定是否在 IO 线程上执行解码逻辑</span>
                        <span class=k>if</span> <span class=p>(</span><span class=n>channel</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getParameter</span><span class=p>(</span>
                                <span class=n>Constants</span><span class=p>.</span><span class=na>DECODE_IN_IO_THREAD_KEY</span><span class=p>,</span>
                                <span class=n>Constants</span><span class=p>.</span><span class=na>DEFAULT_DECODE_IN_IO_THREAD</span><span class=p>))</span> <span class=p>{</span>
                            <span class=c1>// 创建 DecodeableRpcResult 对象</span>
                            <span class=n>result</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DecodeableRpcResult</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>res</span><span class=p>,</span> <span class=n>is</span><span class=p>,</span>
                                    <span class=p>(</span><span class=n>Invocation</span><span class=p>)</span> <span class=n>getRequestData</span><span class=p>(</span><span class=n>id</span><span class=p>),</span> <span class=n>proto</span><span class=p>);</span>
                            <span class=c1>// 进行后续的解码工作</span>
                            <span class=n>result</span><span class=p>.</span><span class=na>decode</span><span class=p>();</span>
                        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                            <span class=c1>// 创建 DecodeableRpcResult 对象</span>
                            <span class=n>result</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DecodeableRpcResult</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>res</span><span class=p>,</span>
                                    <span class=k>new</span> <span class=n>UnsafeByteArrayInputStream</span><span class=p>(</span><span class=n>readMessageData</span><span class=p>(</span><span class=n>is</span><span class=p>)),</span>
                                    <span class=p>(</span><span class=n>Invocation</span><span class=p>)</span> <span class=n>getRequestData</span><span class=p>(</span><span class=n>id</span><span class=p>),</span> <span class=n>proto</span><span class=p>);</span>
                        <span class=p>}</span>
                        <span class=n>data</span> <span class=o>=</span> <span class=n>result</span><span class=p>;</span>
                    <span class=p>}</span>

                    <span class=c1>// 设置 DecodeableRpcResult 对象到 Response 对象中</span>
                    <span class=n>res</span><span class=p>.</span><span class=na>setResult</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
                <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
                    <span class=c1>// 解码过程中出现了错误，此时设置 CLIENT_ERROR 状态码到 Response 对象中</span>
                    <span class=n>res</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>Response</span><span class=p>.</span><span class=na>CLIENT_ERROR</span><span class=p>);</span>
                    <span class=n>res</span><span class=p>.</span><span class=na>setErrorMessage</span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>toString</span><span class=p>(</span><span class=n>t</span><span class=p>));</span>
                <span class=p>}</span>
            <span class=p>}</span> 
            <span class=c1>// 响应状态非 OK，表明调用过程出现了异常</span>
            <span class=k>else</span> <span class=p>{</span>
                <span class=c1>// 反序列化异常信息，并设置到 Response 对象中</span>
                <span class=n>res</span><span class=p>.</span><span class=na>setErrorMessage</span><span class=p>(</span><span class=n>deserialize</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>channel</span><span class=p>.</span><span class=na>getUrl</span><span class=p>(),</span> <span class=n>is</span><span class=p>).</span><span class=na>readUTF</span><span class=p>());</span>
            <span class=p>}</span>
            <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=c1>// 对请求数据进行解码，前面已分析过，此处忽略</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>以上就是响应数据的解码过程，上面逻辑看起来是不是似曾相识。对的，我们在前面章节分析过 DubboCodec 的 decodeBody 方法中关于请求数据的解码过程，该过程和响应数据的解码过程很相似。下面，我们继续分析调用结果的反序列化过程，如下：</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DecodeableRpcResult</span> <span class=kd>extends</span> <span class=n>RpcResult</span> <span class=kd>implements</span> <span class=n>Codec</span><span class=p>,</span> <span class=n>Decodeable</span> <span class=p>{</span>

    <span class=kd>private</span> <span class=n>Invocation</span> <span class=n>invocation</span><span class=p>;</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>decode</span><span class=p>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>hasDecoded</span> <span class=o>&amp;&amp;</span> <span class=n>channel</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>inputStream</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>try</span> <span class=p>{</span>
                <span class=c1>// 执行反序列化操作</span>
                <span class=n>decode</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>inputStream</span><span class=p>);</span>
            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 反序列化失败，设置 CLIENT_ERROR 状态到 Response 对象中</span>
                <span class=n>response</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>Response</span><span class=p>.</span><span class=na>CLIENT_ERROR</span><span class=p>);</span>
                <span class=c1>// 设置异常信息</span>
                <span class=n>response</span><span class=p>.</span><span class=na>setErrorMessage</span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>toString</span><span class=p>(</span><span class=n>e</span><span class=p>));</span>
            <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
                <span class=n>hasDecoded</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>Object</span> <span class=nf>decode</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>InputStream</span> <span class=n>input</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
        <span class=n>ObjectInput</span> <span class=n>in</span> <span class=o>=</span> <span class=n>CodecSupport</span><span class=p>.</span><span class=na>getSerialization</span><span class=p>(</span><span class=n>channel</span><span class=p>.</span><span class=na>getUrl</span><span class=p>(),</span> <span class=n>serializationType</span><span class=p>)</span>
                <span class=p>.</span><span class=na>deserialize</span><span class=p>(</span><span class=n>channel</span><span class=p>.</span><span class=na>getUrl</span><span class=p>(),</span> <span class=n>input</span><span class=p>);</span>

        <span class=c1>// 反序列化响应类型</span>
        <span class=kt>byte</span> <span class=n>flag</span> <span class=o>=</span> <span class=n>in</span><span class=p>.</span><span class=na>readByte</span><span class=p>();</span>
        <span class=k>switch</span> <span class=p>(</span><span class=n>flag</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>case</span> <span class=n>DubboCodec</span><span class=p>.</span><span class=na>RESPONSE_NULL_VALUE</span><span class=p>:</span>
                <span class=k>break</span><span class=p>;</span>
            <span class=k>case</span> <span class=n>DubboCodec</span><span class=p>.</span><span class=na>RESPONSE_VALUE</span><span class=p>:</span>
                <span class=c1>// ...</span>
                <span class=k>break</span><span class=p>;</span>
            <span class=k>case</span> <span class=n>DubboCodec</span><span class=p>.</span><span class=na>RESPONSE_WITH_EXCEPTION</span><span class=p>:</span>
                <span class=c1>// ...</span>
                <span class=k>break</span><span class=p>;</span>

            <span class=c1>// 返回值为空，且携带了 attachments 集合</span>
            <span class=k>case</span> <span class=n>DubboCodec</span><span class=p>.</span><span class=na>RESPONSE_NULL_VALUE_WITH_ATTACHMENTS</span><span class=p>:</span>
                <span class=k>try</span> <span class=p>{</span>
                    <span class=c1>// 反序列化 attachments 集合，并存储起来 </span>
                    <span class=n>setAttachments</span><span class=p>((</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>String</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>in</span><span class=p>.</span><span class=na>readObject</span><span class=p>(</span><span class=n>Map</span><span class=p>.</span><span class=na>class</span><span class=p>));</span>
                <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>ClassNotFoundException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                    <span class=k>throw</span> <span class=k>new</span> <span class=n>IOException</span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>toString</span><span class=p>(</span><span class=s>&quot;Read response data failed.&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>));</span>
                <span class=p>}</span>
                <span class=k>break</span><span class=p>;</span>

            <span class=c1>// 返回值不为空，且携带了 attachments 集合</span>
            <span class=k>case</span> <span class=n>DubboCodec</span><span class=p>.</span><span class=na>RESPONSE_VALUE_WITH_ATTACHMENTS</span><span class=p>:</span>
                <span class=k>try</span> <span class=p>{</span>
                    <span class=c1>// 获取返回值类型</span>
                    <span class=n>Type</span><span class=o>[]</span> <span class=n>returnType</span> <span class=o>=</span> <span class=n>RpcUtils</span><span class=p>.</span><span class=na>getReturnTypes</span><span class=p>(</span><span class=n>invocation</span><span class=p>);</span>
                    <span class=c1>// 反序列化调用结果，并保存起来</span>
                    <span class=n>setValue</span><span class=p>(</span><span class=n>returnType</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>returnType</span><span class=p>.</span><span class=na>length</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>?</span> <span class=n>in</span><span class=p>.</span><span class=na>readObject</span><span class=p>()</span> <span class=p>:</span>
                            <span class=p>(</span><span class=n>returnType</span><span class=p>.</span><span class=na>length</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>?</span> <span class=n>in</span><span class=p>.</span><span class=na>readObject</span><span class=p>((</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=p>)</span> <span class=n>returnType</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>)</span>
                                    <span class=p>:</span> <span class=n>in</span><span class=p>.</span><span class=na>readObject</span><span class=p>((</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=p>)</span> <span class=n>returnType</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>,</span> <span class=n>returnType</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span><span class=p>)));</span>
                    <span class=c1>// 反序列化 attachments 集合，并存储起来</span>
                    <span class=n>setAttachments</span><span class=p>((</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>String</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>in</span><span class=p>.</span><span class=na>readObject</span><span class=p>(</span><span class=n>Map</span><span class=p>.</span><span class=na>class</span><span class=p>));</span>
                <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>ClassNotFoundException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                    <span class=k>throw</span> <span class=k>new</span> <span class=n>IOException</span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>toString</span><span class=p>(</span><span class=s>&quot;Read response data failed.&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>));</span>
                <span class=p>}</span>
                <span class=k>break</span><span class=p>;</span>

            <span class=c1>// 异常对象不为空，且携带了 attachments 集合</span>
            <span class=k>case</span> <span class=n>DubboCodec</span><span class=p>.</span><span class=na>RESPONSE_WITH_EXCEPTION_WITH_ATTACHMENTS</span><span class=p>:</span>
                <span class=k>try</span> <span class=p>{</span>
                    <span class=c1>// 反序列化异常对象</span>
                    <span class=n>Object</span> <span class=n>obj</span> <span class=o>=</span> <span class=n>in</span><span class=p>.</span><span class=na>readObject</span><span class=p>();</span>
                    <span class=k>if</span> <span class=p>(</span><span class=n>obj</span> <span class=k>instanceof</span> <span class=n>Throwable</span> <span class=o>==</span> <span class=kc>false</span><span class=p>)</span>
                        <span class=k>throw</span> <span class=k>new</span> <span class=n>IOException</span><span class=p>(</span><span class=s>&quot;Response data error, expect Throwable, but get &quot;</span> <span class=o>+</span> <span class=n>obj</span><span class=p>);</span>
                    <span class=c1>// 设置异常对象</span>
                    <span class=n>setException</span><span class=p>((</span><span class=n>Throwable</span><span class=p>)</span> <span class=n>obj</span><span class=p>);</span>
                    <span class=c1>// 反序列化 attachments 集合，并存储起来</span>
                    <span class=n>setAttachments</span><span class=p>((</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>String</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>in</span><span class=p>.</span><span class=na>readObject</span><span class=p>(</span><span class=n>Map</span><span class=p>.</span><span class=na>class</span><span class=p>));</span>
                <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>ClassNotFoundException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                    <span class=k>throw</span> <span class=k>new</span> <span class=n>IOException</span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>toString</span><span class=p>(</span><span class=s>&quot;Read response data failed.&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>));</span>
                <span class=p>}</span>
                <span class=k>break</span><span class=p>;</span>
            <span class=k>default</span><span class=p>:</span>
                <span class=k>throw</span> <span class=k>new</span> <span class=n>IOException</span><span class=p>(</span><span class=s>&quot;Unknown result flag, expect &#39;0&#39; &#39;1&#39; &#39;2&#39;, get &quot;</span> <span class=o>+</span> <span class=n>flag</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>in</span> <span class=k>instanceof</span> <span class=n>Cleanable</span><span class=p>)</span> <span class=p>{</span>
            <span class=p>((</span><span class=n>Cleanable</span><span class=p>)</span> <span class=n>in</span><span class=p>).</span><span class=na>cleanup</span><span class=p>();</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>本篇文章所分析的源码版本为 2.6.4，该版本下的 Response 支持 attachments 集合，所以上面仅对部分 case 分支进行了注释。其他 case 分支的逻辑比被注释分支的逻辑更为简单，这里就忽略了。我们所使用的测试服务接口 DemoService 包含了一个具有返回值的方法，正常调用下，线程会进入 RESPONSE_VALUE_WITH_ATTACHMENTS 分支中。然后线程会从 invocation 变量（大家探索一下 invocation 变量的由来）中获取返回值类型，接着对调用结果进行反序列化，并将序列化后的结果存储起来。最后对 attachments 集合进行反序列化，并存到指定字段中。到此，关于响应数据的解码过程就分析完了。接下来，我们再来探索一下响应对象 Response 的去向。</p> <h4 id=252>2.5.2 向用户线程传递调用结果<a class=headerlink href=#252 title="Permanent link">&para;</a></h4> <p>响应数据解码完成后，Dubbo 会将响应对象派发到线程池上。要注意的是，线程池中的线程并非用户的调用线程，所以要想办法将响应对象从线程池线程传递到用户线程上。我们在 2.1 节分析过用户线程在发送完请求后的动作，即调用 DefaultFuture 的 get 方法等待响应对象的到来。当响应对象到来后，用户线程会被唤醒，并通过**调用编号**获取属于自己的响应对象。下面我们来看一下整个过程对应的代码。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HeaderExchangeHandler</span> <span class=kd>implements</span> <span class=n>ChannelHandlerDelegate</span> <span class=p>{</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>received</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>Object</span> <span class=n>message</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=n>channel</span><span class=p>.</span><span class=na>setAttribute</span><span class=p>(</span><span class=n>KEY_READ_TIMESTAMP</span><span class=p>,</span> <span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>());</span>
        <span class=n>ExchangeChannel</span> <span class=n>exchangeChannel</span> <span class=o>=</span> <span class=n>HeaderExchangeChannel</span><span class=p>.</span><span class=na>getOrAddChannel</span><span class=p>(</span><span class=n>channel</span><span class=p>);</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>message</span> <span class=k>instanceof</span> <span class=n>Request</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 处理请求，前面已分析过，省略</span>
            <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>message</span> <span class=k>instanceof</span> <span class=n>Response</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 处理响应</span>
                <span class=n>handleResponse</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=p>(</span><span class=n>Response</span><span class=p>)</span> <span class=n>message</span><span class=p>);</span>
            <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>message</span> <span class=k>instanceof</span> <span class=n>String</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// telnet 相关，忽略</span>
            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                <span class=n>handler</span><span class=p>.</span><span class=na>received</span><span class=p>(</span><span class=n>exchangeChannel</span><span class=p>,</span> <span class=n>message</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
            <span class=n>HeaderExchangeChannel</span><span class=p>.</span><span class=na>removeChannelIfDisconnected</span><span class=p>(</span><span class=n>channel</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=kd>static</span> <span class=kt>void</span> <span class=nf>handleResponse</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>Response</span> <span class=n>response</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RemotingException</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>response</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>response</span><span class=p>.</span><span class=na>isHeartbeat</span><span class=p>())</span> <span class=p>{</span>
            <span class=c1>// 继续向下调用</span>
            <span class=n>DefaultFuture</span><span class=p>.</span><span class=na>received</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>response</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=kd>class</span> <span class=nc>DefaultFuture</span> <span class=kd>implements</span> <span class=n>ResponseFuture</span> <span class=p>{</span>  

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Lock</span> <span class=n>lock</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ReentrantLock</span><span class=p>();</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Condition</span> <span class=n>done</span> <span class=o>=</span> <span class=n>lock</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span>
    <span class=kd>private</span> <span class=kd>volatile</span> <span class=n>Response</span> <span class=n>response</span><span class=p>;</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>received</span><span class=p>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=p>,</span> <span class=n>Response</span> <span class=n>response</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=c1>// 根据调用编号从 FUTURES 集合中查找指定的 DefaultFuture 对象</span>
            <span class=n>DefaultFuture</span> <span class=n>future</span> <span class=o>=</span> <span class=n>FUTURES</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>future</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 继续向下调用</span>
                <span class=n>future</span><span class=p>.</span><span class=na>doReceived</span><span class=p>(</span><span class=n>response</span><span class=p>);</span>
            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                <span class=n>logger</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;The timeout response finally returned at ...&quot;</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
            <span class=n>CHANNELS</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>doReceived</span><span class=p>(</span><span class=n>Response</span> <span class=n>res</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=c1>// 保存响应对象</span>
            <span class=n>response</span> <span class=o>=</span> <span class=n>res</span><span class=p>;</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>done</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 唤醒用户线程</span>
                <span class=n>done</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
            <span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>callback</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>invokeCallback</span><span class=p>(</span><span class=n>callback</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>以上逻辑是将响应对象保存到相应的 DefaultFuture 实例中，然后再唤醒用户线程，随后用户线程即可从 DefaultFuture 实例中获取到相应结果。</p> <p>本篇文章在多个地方都强调过调用编号很重要，但一直没有解释原因，这里简单说明一下。一般情况下，服务消费方会并发调用多个服务，每个用户线程发送请求后，会调用不同 DefaultFuture 对象的 get 方法进行等待。 一段时间后，服务消费方的线程池会收到多个响应对象。这个时候要考虑一个问题，如何将每个响应对象传递给相应的 DefaultFuture 对象，且不出错。答案是通过调用编号。DefaultFuture 被创建时，会要求传入一个 Request 对象。此时 DefaultFuture 可从 Request 对象中获取调用编号，并将 \&lt;调用编号, DefaultFuture 对象&gt; 映射关系存入到静态 Map 中，即 FUTURES。线程池中的线程在收到 Response 对象后，会根据 Response 对象中的调用编号到 FUTURES 集合中取出相应的 DefaultFuture 对象，然后再将 Response 对象设置到 DefaultFuture 对象中。最后再唤醒用户线程，这样用户线程即可从 DefaultFuture 对象中获取调用结果了。整个过程大致如下图：</p> <p><img alt src=../sources/images/request-id-application.jpg></p> <h2 id=3>3. 总结<a class=headerlink href=#3 title="Permanent link">&para;</a></h2> <p>本篇文章主要对 Dubbo 中的几种服务调用方式，以及从双向通信的角度对整个通信过程进行了详细的分析。按照通信顺序，通信过程包括服务消费方发送请求，服务提供方接收请求，服务提供方返回响应数据，服务消费方接收响应数据等过程。理解这些过程需要大家对网络编程，尤其是 Netty 有一定的了解。限于篇幅原因，本篇文章无法将服务调用的所有内容都一一进行分析。对于本篇文章未讲到或未详细分析的内容，比如服务降级、过滤器链、以及序列化等。大家若感兴趣，可自行进行分析。并将分析整理成文，分享给社区。</p> <p>本篇文章就到这里了，感谢阅读。</p> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-footer-social> <a href=http://www.apache.org target=_blank rel=noopener title=Fundation class=md-footer-social__link> <!-- Created with Inkscape (http://www.inkscape.org/) --> <svg id=svg2 xmlns:rdf=http://www.w3.org/1999/02/22-rdf-syntax-ns# xmlns=http://www.w3.org/2000/svg version=1.0 xmlns:cc=http://creativecommons.org/ns# xmlns:xlink=http://www.w3.org/1999/xlink xmlns:dc=http://purl.org/dc/elements/1.1/ viewbox="0 0 100 100"> <defs id=defs4></defs> <metadata id=metadata7> <rdf:rdf> <cc:work rdf:about> <dc:format>image/svg+xml</dc:format> <dc:type rdf:resource=http://purl.org/dc/dcmitype/StillImage /> <dc:title/> <dc:creator> <cc:agent> <dc:title>hrum</dc:title> </cc:agent> </dc:creator> <dc:subject> <rdf:bag> <rdf:li>feather</rdf:li> <rdf:li>bird</rdf:li> </rdf:bag> </dc:subject> <cc:license rdf:resource=http://creativecommons.org/licenses/publicdomain/ /> </cc:work> <cc:license rdf:about=http://creativecommons.org/licenses/publicdomain/ > <cc:permits rdf:resource=http://creativecommons.org/ns#Reproduction /> <cc:permits rdf:resource=http://creativecommons.org/ns#Distribution /> <cc:permits rdf:resource=http://creativecommons.org/ns#DerivativeWorks /> </cc:license> </rdf:rdf> </metadata> <g id=layer1 transform=translate(-41.7017,-537.54073)> <g id=g4360 transform=matrix(0.15183836,0,0,0.15183768,35.369777,531.73802)> <path id=path2383 d=m96.031,0.5c-0.11611,0.00905-0.21242,0.048559-0.3125,0.09375-0.01283,0.005794-0.01874,0.024769-0.03125,0.03125-0.1786,0.010474-0.37198,0.01281-0.5625,0.03125-0.48231-0.1012-1.2249,0.09014-1.6562,0.21875-0.02198,0.004551-0.04048,0.026713-0.0625,0.03125-0.01064,0.001936-0.02058-0.001954-0.03125,0-0.37705,0.07741-0.75408,0.17201-1.125,0.25-0.11794,0.026255-0.22334,0.034381-0.34375,0.0625-0.25616,0.05799-0.51562,0.11856-0.75,0.1875-0.29027,0.074001-0.57253,0.13524-0.875,0.21875-0.0629,0.15674-0.15229,0.33489-0.21875,0.5-0.32718,0.53485-0.55142,1.2906-0.8125,2.0312-0.08476,0.20698-0.16919,0.42932-0.25,0.625-0.11753,0.2846-0.05639,0.16641-0.15625,0.40625-0.01601,0.038442-0.01569,0.025179-0.03125,0.0625-0.0091,0.021933-0.02226,0.0097-0.03125,0.03125-0.07806,0.13316-0.1588,0.25776-0.25,0.375-0.02468,0.15462-0.03959,0.25842-0.0625,0.375-0.0019,0.00947,0.0021,0.021613,0,0.03125-0.06921,0.16338-0.13727,0.32005-0.1875,0.4375-0.01776,0.041518-0.04706,0.12026-0.0625,0.15625-0.03266,0.071089-0.07809,0.1513-0.09375,0.1875-0.0993,0.013748-0.12753-0.23997-0.09375-0.59375,0.0022-0.022625-0.0029-0.039158,0-0.0625,0.04221-0.2299,0.04549-0.20195,0.09375-0.46875,0.0017-0.00939-0.0017-0.021822,0-0.03125,0.0042-0.012389,0.02655-0.018696,0.03125-0.03125,0.03816-0.102,0.0731-0.21479,0.125-0.3125,0.06341-0.52902,0.09063-0.86367,0.125-1.2188,0.01233-0.077645,0.02035-0.14453,0.03125-0.21875,0.0017-0.0108-0.0017-0.020532,0-0.03125,0.04858-0.31393,0.08164-0.58275,0.125-0.875,0.0019-0.00867-0.0019-0.022528,0-0.03125,0.0019-0.0087-0.002-0.022515,0-0.03125,0.0508-0.22677,0.12871-0.46196,0.21875-0.75-0.02627,0.00749-0.06669,0.023215-0.09375,0.03125,0.0031-0.0285-0.0029-0.065707,0-0.09375-0.67942,0.20952-1.3995,0.43847-2.125,0.6875-0.22113,0.040554-0.45688,0.077095-0.6875,0.09375-0.17688,0.11654-0.37152,0.24094-0.5625,0.34375-0.02018,0.010866-0.04218,0.02052-0.0625,0.03125-0.52999,0.1916-1.0446,0.38376-1.5938,0.59375-0.88593,0.33238-1.778,0.67256-2.7188,1.0625-0.01281,0.00529-0.01843,0.025948-0.03125,0.03125-0.08058,0.035042-0.17025,0.060457-0.25,0.09375-0.07998,0.033919-0.17176,0.058538-0.25,0.09375-0.18559,0.080466-0.37666,0.16781-0.5625,0.25-0.37804,0.16103-0.77334,0.33133-1.1562,0.5-0.19405,0.084859-0.39903,0.16257-0.59375,0.25-0.01286,0.00571-0.01839,0.025536-0.03125,0.03125-0.05,0.022186-0.10617,0.040202-0.15625,0.0625-0.38536,0.17408-0.76476,0.35248-1.1562,0.53125-0.06392,0.029525-0.12347,0.06405-0.1875,0.09375-0.36319,0.16652-0.72706,0.32796-1.0938,0.5-0.72818,0.34328-1.4447,0.69857-2.1875,1.0625-1.0198,0.4999-2.0282,1.0252-3.0625,1.5625-0.0083,0.0043-0.02294-0.00432-0.03125,0-0.02093,0.01087-0.04157,0.02037-0.0625,0.03125-0.02896,0.01506-0.06478,0.01617-0.09375,0.03125-0.62,0.274-1.219,0.561-1.784,0.938-0.04269,0.03063-0.08287,0.0634-0.125,0.09375-0.03038,0.02188-0.06254,0.04166-0.09375,0.0625-0.51982,0.2809-1.0421,0.55451-1.5625,0.84375-0.17665,0.09551-0.35544,0.18268-0.53125,0.28125-0.08605,0.04802-0.16403,0.10777-0.25,0.15625-0.22385,0.118-0.44162,0.24501-0.65625,0.375-0.98276,0.56061-1.9613,1.1313-2.9375,1.7188-0.21693,0.12919-0.44065,0.24381-0.65625,0.375-0.11629,0.0706-0.2278,0.14766-0.34375,0.21875-0.17035,0.08122-0.31241,0.20292-0.46875,0.3125-0.14267,0.08824-0.29513,0.16124-0.4375,0.25-0.0076,0.0047-0.02369-0.0047-0.03125,0-0.75333,0.27006-1.3421,0.83453-1.9688,1.2812-0.01862,0.01328-0.04382,0.01816-0.0625,0.03125-0.01939,0.01258-0.04312,0.01866-0.0625,0.03125-0.01286,0.0057-0.01957,0.02365-0.03125,0.03125-0.01937,0.01259-0.04313,0.01865-0.0625,0.03125-0.19316,0.1283-0.38322,0.25172-0.59375,0.34375-0.09694,0.09197-0.20774,0.16748-0.3125,0.25-0.01151,0.0091-0.01983,0.02209-0.03125,0.03125-0.04057,0.03254-0.0836,0.06222-0.125,0.09375-0.03859,0.02566-0.08645,0.0368-0.125,0.0625-0.25449,0.17098-0.49662,0.3595-0.75,0.53125-0.03815,0.02598-0.08691,0.03648-0.125,0.0625-0.03327,0.01741-0.06278,0.04143-0.09375,0.0625-0.8407,0.49023-1.7095,0.94719-2.375,1.625-0.38659,0.30315-0.80514,0.62819-1.2188,0.9375-0.06051,0.04525-0.12765,0.08003-0.1875,0.125-0.10824,0.08028-0.20518,0.16964-0.3125,0.25-0.23954,0.1682-0.48848,0.32484-0.71875,0.5-0.19592,0.14901-0.36849,0.3188-0.5625,0.46875-0.12308,0.09525-0.2522,0.18545-0.375,0.28125-0.03077,0.02329-0.06298,0.03916-0.09375,0.0625-0.33367,0.26123-0.67257,0.5175-1,0.78125-0.65632,0.51336-1.2871,1.0497-1.9062,1.5938-0.0793,0.06773-0.17116,0.11964-0.25,0.1875-0.10365,0.09293-0.21073,0.18729-0.3125,0.28125-0.09455,0.08326-0.18719,0.16638-0.28125,0.25-0.1537,0.13465-0.31699,0.27116-0.46875,0.40625-0.06041,0.0545-0.12791,0.10097-0.1875,0.15625-0.14642,0.13148-0.29297,0.27442-0.4375,0.40625-0.14899,0.14235-0.28658,0.29727-0.4375,0.4375-0.43949,0.40737-0.89241,0.8081-1.3125,1.2188-0.1596,0.15224-0.30971,0.31599-0.46875,0.46875-0.0328,0.03217-0.06103,0.06164-0.09375,0.09375-0.04363,0.04282-0.0815,0.08228-0.125,0.125-0.05419,0.05324-0.10228,0.10316-0.15625,0.15625-1.0499,1.0097-2.1036,2.0159-3.1562,3.0312-0.08939,0.13409-0.18386,0.24977-0.28125,0.375-0.03226,0.03253-0.06177,0.06143-0.09375,0.09375-0.36981,0.37315-0.70391,0.72855-1.0625,1.0938-0.07138,0.07319-0.14669,0.14521-0.21875,0.21875-0.07361,0.07278-0.14687,0.14525-0.21875,0.21875-0.05418,0.04812-0.10209,0.10832-0.15625,0.15625-0.6873,0.60825-1.3566,1.199-1.875,1.9375-0.0098,0.01017-0.02152,0.0211-0.03125,0.03125-0.02293,0.02958-0.04163,0.06215-0.0625,0.09375-0.11999,0.12663-0.25262,0.24251-0.375,0.375-0.15042,0.14713-0.30247,0.29536-0.4375,0.4375-0.0049,0.0052,0.0049,0.0261,0,0.03125-0.90058,0.9482-1.7125,1.8287-2.5312,2.7188-0.01237,0.0091-0.01877,0.02219-0.03125,0.03125-0.0062,0.0136-0.02491,0.01777-0.03125,0.03125-0.22873,0.24884-0.4304,0.50271-0.65625,0.75-0.11355,0.12476-0.26304,0.2514-0.375,0.375-0.11804,0.13031-0.22675,0.24557-0.34375,0.375-0.07257,0.08041-0.14742,0.17055-0.21875,0.25-0.01104,0.0086-0.02029,0.02266-0.03125,0.03125-0.03044,0.03393-0.06343,0.05991-0.09375,0.09375-0.26141,0.21433-0.49765,0.43018-0.65625,0.71875-0.01132,0.02061-0.02057,0.04121-0.03125,0.0625-0.08867,0.10015-0.16198,0.21077-0.25,0.3125-0.23115,0.26062-0.49777,0.52738-0.71875,0.78125-0.55744,0.64086-1.0833,1.2677-1.5938,1.875-0.01826,0.02168-0.04432,0.04084-0.0625,0.0625-0.04471,0.05326-0.0807,0.10322-0.125,0.15625-0.08524,0.09547-0.17368,0.18961-0.25,0.28125-0.20894,0.25123-0.41706,0.49176-0.625,0.75-0.20818,0.25731-0.42579,0.52999-0.625,0.78125-0.06276,0.07865-0.12662,0.17389-0.1875,0.25-0.43479,0.55175-0.85205,1.1048-1.25,1.625-0.30879,0.40388-0.65409,0.83399-0.9375,1.2188-0.03093,0.04198-0.0631,0.08322-0.09375,0.125-0.10294,0.14034-0.18258,0.26949-0.28125,0.40625-0.03749,0.05148-0.08834,0.10524-0.125,0.15625-0.07053,0.09815-0.11847,0.18422-0.1875,0.28125-0.20643,0.29123-0.42961,0.59018-0.625,0.875-0.24296,0.35439-0.49761,0.72385-0.71875,1.0625-0.0581,0.08889-0.09962,0.16227-0.15625,0.25-0.01898,0.02945-0.04369,0.06443-0.0625,0.09375-0.25727,0.40116-0.49656,0.807-0.71875,1.1875-0.22382,0.3728-0.42975,0.74168-0.625,1.0938-0.27165,0.48982-0.56258,0.98354-0.78125,1.4375-0.17374,0.36071-0.32657,0.72319-0.46875,1.0625-0.0085,0.0204-0.02282,0.04229-0.03125,0.0625-0.12366,0.29789-0.24392,0.59455-0.34375,0.875-0.0217,0.05934-0.04189,0.12893-0.0625,0.1875-0.07827,0.22262-0.15736,0.44434-0.21875,0.65625-0.03575,0.12177-0.06326,0.25682-0.09375,0.375-0.01865,0.07303-0.04552,0.14758-0.0625,0.21875-0.07852,0.33009-0.14502,0.66533-0.1875,0.96875-0.0342,0.24409-0.05032,0.45978-0.0625,0.6875-0.0042,0.07759,0.00049,0.14378,0,0.21875-0.000422,0.01968,0.000261,0.04292,0,0.0625-0.0029,0.21573,0.01474,0.42379,0.03125,0.625,0.0018,0.01997-0.0018,0.04259,0,0.0625,0.01502,0.16655,0.0036,0.34299,0.03125,0.5,0.01966,0.10867,0.06827,0.20824,0.09375,0.3125,0.008,0.03154,0.02313,0.06297,0.03125,0.09375,0.02506,0.09566,0.06386,0.18925,0.09375,0.28125,0.01604,0.04918,0.01388,0.10808,0.03125,0.15625,0.02512,0.06933,0.03468,0.15148,0.0625,0.21875-0.77537,0.98099-1.5109,1.9373-2.25,2.9062-0.32102,0.41317-0.65891,0.8379-0.96875,1.25-0.04411,0.05865-0.08103,0.12893-0.125,0.1875-0.10897,0.1452-0.23571,0.29283-0.34375,0.4375-1.5333,2.0531-2.9225,4.0143-4.25,5.9062-0.63407,0.90333-1.2941,1.8382-1.875,2.6875-0.54506,0.79753-1.0366,1.5098-1.5312,2.25-0.1726,0.266-0.3614,0.564-0.5286,0.816-0.1339,0.202-0.214,0.334-0.3437,0.531-0.0971,0.147-0.2178,0.325-0.3125,0.469-0.72056,1.0998-1.3956,2.1626-1.9688,3.0625-0.025009,0.0393-0.069036,0.08612-0.09375,0.125-0.10881,0.16721-0.21857,0.35114-0.3125,0.5-0.051976,0.08069-0.1058,0.16977-0.15625,0.25-0.085634,0.136-0.16883,0.24549-0.25,0.375-0.28116,0.44105-0.56814,0.90528-0.78125,1.25-0.010208,0.01653-0.021154,0.04614-0.03125,0.0625-0.20162,0.33011-0.48004,0.7923-0.625,1.0312-0.22291,0.372-0.6562,1.095-0.6562,1.095l0.28125,0.25,6.0312-6.25s0.24131-0.42207,0.375-0.65625c0.017337-0.02973,0.064714-0.07821,0.09375-0.125,0.072241-0.12464,0.056555-0.11385,0.15625-0.28125,0.02077-0.03496,0.041312-0.09007,0.0625-0.125,0.12515-0.20771,0.33862-0.52129,0.5-0.78125,0.14196-0.22979,0.24926-0.40852,0.40625-0.65625,0.00988-0.01555,0.01721-0.04174,0.03125-0.0625,0.00674-0.01058,0.024461-0.02061,0.03125-0.03125,0.0068-0.012,0.0247-0.023,0.0314-0.033,0.42069-0.65967,0.99248-1.5204,1.5938-2.4062,0.099631-0.14787,0.14552-0.25386,0.25-0.40625,0.00783-0.01142,0.023387-0.0198,0.03125-0.03125,0.3933-0.57312,0.81339-1.1559,1.2812-1.8125,0.09923-0.13913,0.20985-0.32595,0.3125-0.46875,0.52426-0.72912,1.1026-1.5204,1.7188-2.3438,0.0095-0.01271,0.02172-0.01852,0.03125-0.03125,0.02144-0.02863,0.04065-0.06479,0.0625-0.09375,0.22488-0.29988,0.51277-0.65684,0.75-0.96875,0.62874-0.82658,1.3133-1.7141,2.0312-2.625,0.0085-0.01073,0.02276-0.0205,0.03125-0.03125,0.0677-0.08584,0.11895-0.16352,0.1875-0.25,0.95022-1.1987,1.9528-2.4466,3.0625-3.7812,0.05176-0.01898,0.10346-0.04154,0.15625-0.0625l-0.125,0.125,2.0625-0.59375s0.73975-0.27282,1.2812-0.46875c0.18474-0.0683,0.53265-0.1995,0.75-0.28125,0.73616-0.19447,1.4325-0.36279,2.0938-0.5,0.05156-0.0107,0.10556-0.01572,0.15625-0.03125,0.69198-0.14116,1.312-0.24664,1.9375-0.34375,0.01956-0.003,0.04299,0.003,0.0625,0,0.59682-0.09116,1.168-0.18278,1.7188-0.25,0.45233-0.0552,0.88256-0.10748,1.3125-0.15625,0.11747-0.01353,0.2276-0.01782,0.34375-0.03125,1.0729-0.12241,2.0941-0.2433,3.125-0.4375,0.27684-0.05215,0.56224-0.12636,0.84375-0.1875s0.55912-0.10923,0.84375-0.1875c0.03055-0.0084,0.06312-0.02267,0.09375-0.03125,0.04084-0.01128,0.08403-0.01964,0.125-0.03125,0.11367-0.03266,0.22812-0.08841,0.34375-0.125,0.09247-0.0266,0.18887-0.03705,0.28125-0.0625,0.02204-0.0073,0.04042-0.02383,0.0625-0.03125,0.03189-0.01047,0.06176-0.02055,0.09375-0.03125,0.06132-0.02033,0.12523-0.04235,0.1875-0.0625,0.15218-0.05262,0.31426-0.09712,0.46875-0.15625,0.04911-0.01849,0.10684-0.04344,0.15625-0.0625h0.03125c0.03461-0.01265,0.05937-0.0492,0.09375-0.0625,0.3349-0.12953,0.66938-0.26405,1-0.40625,0.16353-0.07034,0.34014-0.1128,0.5-0.1875,0.71301-0.17104,1.3067-0.61474,1.875-1.0312,0.02417-0.01772,0.03824-0.04684,0.0625-0.0625,0.0852-0.0503,0.19491-0.10416,0.28125-0.15625,0.20682-0.12432,0.41128-0.24007,0.625-0.375,0.03059-0.01931,0.06301-0.04296,0.09375-0.0625,0.23168-0.11112,0.46075-0.21134,0.71875-0.25,1.9689-1.5011,4.1265-3.2242,5.9375-4.6562,0.61676-0.6195,1.2883-1.2524,1.9688-1.875,0.17178-0.15367,0.3872-0.34155,0.5625-0.5l0.03-0.033c0.33064-0.30342,0.63743-0.63056,0.96875-0.9375,0.19266-0.17734,0.39692-0.3483,0.59375-0.53125,0.49666-0.46166,1.0703-1.0299,1.5938-1.5312,0.01586-0.01519,0.04646-0.01608,0.0625-0.03125,0.1375-0.13115,0.29807-0.30378,0.4375-0.4375,0.59317-0.56924,1.2771-1.2268,1.9062-1.8438,2.3912-2.287,4.7767-4.592,7.2812-6.75,0.01109-0.0096,0.02016-0.0217,0.03125-0.03125,0.0726-0.06249,0.14596-0.12523,0.21875-0.1875,0.20587-0.16977,0.41795-0.3324,0.625-0.5,0.08119-0.06578,0.16836-0.12266,0.25-0.1875,0.39435-0.31736,0.7892-0.62672,1.1875-0.9375,0.44532-0.34666,0.89441-0.69246,1.3438-1.0312,0.06509-0.04921,0.12247-0.10709,0.1875-0.15625,0.7891-0.59394,1.5779-1.1775,2.375-1.75,0.1576-0.11322,0.31095-0.2313,0.46875-0.34375,0.63777-0.45859,1.293-0.89688,1.9375-1.3438,1.1514-0.79715,2.2929-1.5786,3.4375-2.3438,0.10488-0.07012,0.20581-0.14878,0.3125-0.21875,0.11193-0.07464,0.22806-0.14605,0.34375-0.21875,0.14268-0.09496,0.2951-0.1867,0.4375-0.28125,0.0866-0.05723,0.16337-0.13032,0.25-0.1875,0.97864-0.6493,1.9162-1.2727,2.875-1.9062,0.59018-0.38925,1.1924-0.7639,1.7812-1.1562,0.55459-0.36889,1.082-0.7278,1.625-1.0938,1.2371-0.71014,2.3922-1.5594,3.5312-2.4375,0.44109-0.34004,0.90338-0.65621,1.3438-1,0.67747-0.49834,1.3305-0.9988,1.9688-1.5,0.55692-0.43636,1.1003-0.87195,1.625-1.3125,0.03048-0.02233,0.06213-0.04247,0.09375-0.0625,0.0281-0.02369,0.06575-0.0388,0.09375-0.0625,0.02216-0.01876,0.04041-0.04373,0.0625-0.0625,0.61656-0.4569,1.2068-0.93099,1.6562-1.4688,0.01877-0.02246,0.0443-0.03984,0.0625-0.0625,0.29507-0.27706,0.60034-0.55727,0.875-0.84375-0.05312-0.29561-0.14424-0.64004-0.21875-0.96875-0.01861-0.33997-0.09361-0.70448-0.28125-1.0938-0.0087-0.06982-0.04969-0.12065-0.0625-0.1875-0.09508-0.49607-0.32811-0.88718-0.59375-1.25-0.005-0.0068,0.0051-0.02444,0-0.03125-0.03545-0.04996-0.08477-0.10574-0.125-0.15625-0.11152-0.13644-0.21836-0.27765-0.34375-0.40625-0.0047-0.0053,0.0048-0.02596,0-0.03125-0.01426-0.01583-0.01675-0.04662-0.03125-0.0625-0.182-0.181-0.375-0.363-0.565-0.533-0.109-0.105-0.229-0.208-0.344-0.313-0.111-0.1-0.205-0.21-0.312-0.312-0.04019-0.03507-0.0845-0.05889-0.125-0.09375-0.01048-0.01036-0.02085-0.02085-0.03125-0.03125-0.13022-0.13019-0.26001-0.26715-0.375-0.40625-0.01282,0.01233-0.10606-0.04902-0.25-0.125v-0.03125c-0.08842-0.04701-0.1823-0.12761-0.28125-0.1875-0.08526-0.06729-0.16309-0.13147-0.25-0.1875-0.03136-0.02022-0.06285-0.04214-0.09375-0.0625-0.05409-0.04196-0.10317-0.05303-0.15625-0.09375-0.0055-0.0042,0.0055-0.02709,0-0.03125,0.0041-0.01246,0.0028,0.0018,0.03125,0,0.39594,0.24883,0.65882,0.41634,0.8125,0.53125,0.02333,0.01634,0.03858,0.04575,0.0625,0.0625,0.06016,0.05119,0.13212,0.11815,0.125,0.125,0.35441,0.21033,0.69931,0.44833,1.0312,0.6875,0.09053,0.06523,0.19227,0.12031,0.28125,0.1875,0.0185,0.01296,0.01258,0.01817,0.03125,0.03125,0.0063,0.0091,0.0124,0.01806,0.03125,0.03125,0.7798,0.59601,1.5074,1.2518,2.1875,1.9688,0.0103,0.01086,0.02097,0.02036,0.03125,0.03125,0.01013,0.01073,0.02114,0.0205,0.03125,0.03125,0.03924,0.04753,0.05578,0.10884,0.09375,0.15625,0.16169,0.20137,0.3304,0.39819,0.46875,0.59375,0.17151,0.24243,0.33112,0.46943,0.46875,0.6875,0.01798-0.02295,0.04465-0.03949,0.0625-0.0625,0.17422-0.22459,0.34122-0.45249,0.5-0.6875,0.17752-0.25344,0.33823-0.51978,0.5-0.78125,0.17-0.25307,0.32415-0.50973,0.46875-0.78125,0.004-0.0074-0.0049-0.02406,0-0.03125,0.01626-0.02396,0.04939-0.03767,0.0625-0.0625,0.12795-0.24686,0.23327-0.49232,0.34375-0.75,0.0097-0.02108,0.02167-0.04137,0.03125-0.0625,0.01281-0.03034,0.01866-0.06329,0.03125-0.09375,0.01902-0.04276,0.04394-0.08211,0.0625-0.125,0.08095-0.1863,0.14662-0.37309,0.21875-0.5625,0.0081-0.02132,0.02321-0.04113,0.03125-0.0625,0.09484-0.26965,0.19831-0.53967,0.28125-0.8125,0.0059-0.01909-0.0058-0.04337,0-0.0625,0.11717-0.38293,0.22639-0.78772,0.3125-1.1875,0.0082-0.03152,0.02244-0.06197,0.03125-0.09375,0.0027-0.0097-0.0027-0.0215,0-0.03125,0.04062-0.14688,0.08918-0.29428,0.125-0.4375,0.01761-0.12425,0.02592-0.23193,0.03125-0.34375,0.000481-0.010089-0.000462-0.021093,0-0.03125,0.06145-0.41506,0.0973-0.81624,0.125-1.25,0.0021-0.032204-0.0019-0.06144,0-0.09375,0.000573-0.010079-0.000564-0.021146,0-0.03125,0.02358-0.42298,0.04089-0.87088,0.03125-1.3125-0.002-0.082882,0.0032-0.16644,0-0.25-0.033-0.2921-0.05-0.5475-0.06-0.813-0.018-0.5216-0.022-1.0483-0.187-1.5937-0.005-0.0313-0.026-0.0621-0.032-0.0938-0.031-0.1896-0.056-0.4009-0.093-0.5938-0.054-0.2792-0.122-0.5575-0.188-0.8437-0.0044-0.019058,0.0044-0.043395,0-0.0625-0.117-0.5029-0.251-1.0061-0.406-1.5312-0.05235-0.06573-0.12046-0.099317-0.1875-0.15625,0.0054-0.00816-0.01899-0.023545-0.0625-0.0625-0.06112-0.045989-0.11607-0.11652-0.1875-0.15625-0.01061-0.005861-0.02041-0.025524-0.03125-0.03125-0.03729-0.046355-0.08286-0.092677-0.125-0.125-0.07335,0.014704-0.16905,0.00047589-0.25,0-0.07924-0.027136-0.16322-0.070849-0.25-0.09375-0.03768-0.009288-0.0859-0.022859-0.125-0.03125-0.10508-0.022552-0.2286-0.015122-0.34375-0.03125-0.07494-0.005837-0.14155-0.023052-0.21875-0.03125-0.05258-0.005584-0.10167-0.027061-0.15625-0.03125-0.02832-0.002053-0.06494,0.001734-0.09375,0-0.282-0.06642-0.565-0.11312-0.813-0.09385zm-8.156,6.8438c-0.00012,0.11062-0.04058,0.1632-0.0625,0.21875,0.0075-0.054929-0.003-0.10974,0-0.125,0.02573-0.032989,0.02062-0.056927,0.0625-0.09375zm3.5,14.594,0,0.03125,0-0.03125zm-0.781,0.593,0.031,0.031-0.031-0.031zm-62.063,21.219,0.031,0.062-0.031-0.062zm-1.3125,1.7188,0,0.03125,0-0.03125zm27.688,4.5,0.03125,0-0.03125,0zm-6.75,6.2812,0,0.0625,0-0.0625zm-2.8438,2.3125-0.03125,0.03125,0.03125-0.03125zm-0.375,0.3125,0.03125,0.03125l-0.03-0.03zm-0.34375,0.09375,0,0.03125,0-0.03125zm0.0625,0.0625-0.03125,0.03125,0.03125-0.03125zm0.0625,0.09375,0,0.03125,0-0.03125zm-1.8125,1.125,0.03125,0-0.03125,0zm-0.156,0.126,0.031,0.031-0.031-0.031zm-0.5,0.15625,0,0.03125,0-0.03125zm-0.3125,0.125,0,0.03125,0-0.03125zm-0.719,0.594-0.031,0.031,0.031-0.031zm-0.15625,0.15625-0.03125,0.03125,0.03125-0.03125zm0.09375,0.0625,0,0.0625,0-0.0625zm-1.845,0.782v0.03125-0.03125zm-0.1875,0.03125,0,0.03125,0-0.03125zm0,0.09375,0,0.03125,0-0.03125zm-0.71875,0.15625,0.03125,0-0.03125,0zm-0.655,0.25-0.031,0.031,0.031-0.031z transform=matrix(6.585951,0,0,6.5859805,41.701735,38.216535) /> </g> </g> </svg> </a> <a href=http://www.apache.org/licenses/ target=_blank rel=noopener title=www.apache.org class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9 10a3.04 3.04 0 013-3 3.04 3.04 0 013 3 3.04 3.04 0 01-3 3 3.04 3.04 0 01-3-3m3 9l4 1v-3.08A7.54 7.54 0 0112 18a7.54 7.54 0 01-4-1.08V20m4-16a5.78 5.78 0 00-4.24 1.74A5.78 5.78 0 006 10a5.78 5.78 0 001.76 4.23A5.78 5.78 0 0012 16a5.78 5.78 0 004.24-1.77A5.78 5.78 0 0018 10a5.78 5.78 0 00-1.76-4.26A5.78 5.78 0 0012 4m8 6a8.04 8.04 0 01-.57 2.8A7.84 7.84 0 0118 15.28V23l-6-2-6 2v-7.72A7.9 7.9 0 014 10a7.68 7.68 0 012.33-5.64A7.73 7.73 0 0112 2a7.73 7.73 0 015.67 2.36A7.68 7.68 0 0120 10z"/></svg> </a> <a href=http://www.apache.org/events/current-event target=_blank rel=noopener title=www.apache.org class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><path d="M99 414.3c1.1 5.7-2.3 11.1-8 12.3-5.4 1.1-10.9-2.3-12-8-1.1-5.4 2.3-11.1 7.7-12.3 5.4-1.2 11.1 2.3 12.3 8zm143.1 71.4c-6.3 4.6-8 13.4-3.7 20 4.6 6.6 13.4 8.3 20 3.7 6.3-4.6 8-13.4 3.4-20-4.2-6.5-13.1-8.3-19.7-3.7zm-86-462.3c6.3-1.4 10.3-7.7 8.9-14-1.1-6.6-7.4-10.6-13.7-9.1-6.3 1.4-10.3 7.7-9.1 14 1.4 6.6 7.6 10.6 13.9 9.1zM34.4 226.3c-10-6.9-23.7-4.3-30.6 6-6.9 10-4.3 24 5.7 30.9 10 7.1 23.7 4.6 30.6-5.7 6.9-10.4 4.3-24.1-5.7-31.2zm272-170.9c10.6-6.3 13.7-20 7.7-30.3-6.3-10.6-19.7-14-30-7.7s-13.7 20-7.4 30.6c6 10.3 19.4 13.7 29.7 7.4zm-191.1 58c7.7-5.4 9.4-16 4.3-23.7s-15.7-9.4-23.1-4.3c-7.7 5.4-9.4 16-4.3 23.7 5.1 7.8 15.6 9.5 23.1 4.3zm372.3 156c-7.4 1.7-12.3 9.1-10.6 16.9 1.4 7.4 8.9 12.3 16.3 10.6 7.4-1.4 12.3-8.9 10.6-16.6-1.5-7.4-8.9-12.3-16.3-10.9zm39.7-56.8c-1.1-5.7-6.6-9.1-12-8-5.7 1.1-9.1 6.9-8 12.6 1.1 5.4 6.6 9.1 12.3 8 5.4-1.5 9.1-6.9 7.7-12.6zM447 138.9c-8.6 6-10.6 17.7-4.9 26.3 5.7 8.6 17.4 10.6 26 4.9 8.3-6 10.3-17.7 4.6-26.3-5.7-8.7-17.4-10.9-25.7-4.9zm-6.3 139.4c26.3 43.1 15.1 100-26.3 129.1-17.4 12.3-37.1 17.7-56.9 17.1-12 47.1-69.4 64.6-105.1 32.6-1.1.9-2.6 1.7-3.7 2.9-39.1 27.1-92.3 17.4-119.4-22.3-9.7-14.3-14.6-30.6-15.1-46.9-65.4-10.9-90-94-41.1-139.7-28.3-46.9.6-107.4 53.4-114.9C151.6 70 234.1 38.6 290.1 82c67.4-22.3 136.3 29.4 130.9 101.1 41.1 12.6 52.8 66.9 19.7 95.2zm-70 74.3c-3.1-20.6-40.9-4.6-43.1-27.1-3.1-32 43.7-101.1 40-128-3.4-24-19.4-29.1-33.4-29.4-13.4-.3-16.9 2-21.4 4.6-2.9 1.7-6.6 4.9-11.7-.3-6.3-6-11.1-11.7-19.4-12.9-12.3-2-17.7 2-26.6 9.7-3.4 2.9-12 12.9-20 9.1-3.4-1.7-15.4-7.7-24-11.4-16.3-7.1-40 4.6-48.6 20-12.9 22.9-38 113.1-41.7 125.1-8.6 26.6 10.9 48.6 36.9 47.1 11.1-.6 18.3-4.6 25.4-17.4 4-7.4 41.7-107.7 44.6-112.6 2-3.4 8.9-8 14.6-5.1 5.7 3.1 6.9 9.4 6 15.1-1.1 9.7-28 70.9-28.9 77.7-3.4 22.9 26.9 26.6 38.6 4 3.7-7.1 45.7-92.6 49.4-98.3 4.3-6.3 7.4-8.3 11.7-8 3.1 0 8.3.9 7.1 10.9-1.4 9.4-35.1 72.3-38.9 87.7-4.6 20.6 6.6 41.4 24.9 50.6 11.4 5.7 62.5 15.7 58.5-11.1zm5.7 92.3c-10.3 7.4-12.9 22-5.7 32.6 7.1 10.6 21.4 13.1 32 6 10.6-7.4 13.1-22 6-32.6-7.4-10.6-21.7-13.5-32.3-6z"/></svg> </a> <a href=http://www.apache.org/foundation/sponsorship.html target=_blank rel=noopener title=www.apache.org class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6z"/></svg> </a> </div> </div> </div> </footer> </div> <script src=../../../../assets/javascripts/vendor.c3dc8c49.min.js></script> <script src=../../../../assets/javascripts/bundle.30071cf1.min.js></script><script id=__lang type=application/json>{"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c"}</script> <script>
        app = initialize({
          base: "../../../..",
          features: ["tabs", "search.highlight"],
          search: Object.assign({
            worker: "../../../../assets/javascripts/worker/search.8e2cddea.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> </body> </html>